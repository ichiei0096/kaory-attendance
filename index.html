<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KAORY - æ ªå¼ä¼šç¤¾ æˆä¼¸å·¥æ¥­ å‡ºé€€å‹¤ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Hiragino Sans', 'Yu Gothic UI', 'Meiryo UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      padding: 40px;
      width: 100%;
      max-width: 500px;
      text-align: center;
    }
    .logo { color: #0072bc; font-size: 2.5em; font-weight: bold; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.1);}
    .company-name { color: #666; font-size: 1.1em; margin-bottom: 30px; font-weight: 500;}
    .form-group { margin-bottom: 20px; text-align: left;}
    label { display: block; margin-bottom: 8px; color: #333; font-weight: 500;}
    select, input, textarea {
      width: 100%; padding: 15px; border: 2px solid #e1e5e9; border-radius: 10px; font-size: 16px;
      transition: border-color 0.3s; font-family: inherit;
    }
    textarea { resize: vertical; min-height: 100px;}
    select:focus, input:focus, textarea:focus { outline: none; border-color: #0072bc; }
    .login-btn, .stamp-btn, .admin-btn, .request-btn {
      width: 100%; padding: 15px; background: linear-gradient(45deg, #0072bc, #00a0d2); color: white;
      border: none; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s; margin-top: 10px;
    }
    .login-btn:hover, .stamp-btn:hover, .admin-btn:hover, .request-btn:hover {
      transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,114,188,0.3);
    }
    .stamp-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 30px 0;}
    .in-btn { background: linear-gradient(45deg, #4CAF50, #45a049);}
    .out-btn { background: linear-gradient(45deg, #f44336, #da190b);}
    .in-btn:hover { box-shadow: 0 10px 20px rgba(76,175,80,0.3);}
    .out-btn:hover { box-shadow: 0 10px 20px rgba(244,67,54,0.3);}
    .hidden { display: none !important;}
    #user-greeting { color: #333; margin-bottom: 20px; font-size: 1.3em;}
    #roulette-area {
      margin: 20px 0; padding: 20px; border-radius: 10px; min-height: 60px;
      display: flex; align-items: center; justify-content: center; font-size: 1.1em; font-weight: bold;
    }
    #qr-reader {
      margin: 20px 0; padding: 20px; border: 2px dashed #0072bc; border-radius: 10px; background: #f8f9fa; min-height: 300px;
    }
    .roulette-win { background: linear-gradient(45deg, #FFD700, #FFA500); color: #333; padding: 20px; border-radius: 15px; animation: bounce 0.6s ease-in-out;}
    .roulette-lose { background: linear-gradient(45deg, #87CEEB, #4682B4); color: white; padding: 15px; border-radius: 10px;}
    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% { transform: translateY(0);}
      40% { transform: translateY(-10px);}
      60% { transform: translateY(-5px);}
    }
    .logout-btn { background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 20px;}
    .logout-btn:hover { background: #5a6268;}
    .error { color: #dc3545; font-size: 0.9em; margin-top: 5px;}
    .success { color: #28a745; font-size: 0.9em; margin-top: 5px;}
    #history { margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px; text-align: left; max-height: 400px; overflow-y: auto;}
    .history-entry {
      background: white; padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 4px solid #0072bc; font-size: 0.9em;
    }
    .edit-btn, .delete-btn, .approve-btn, .reject-btn {
      padding: 5px 10px; margin: 5px 5px 0 0; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8em;
    }
    .edit-btn, .approve-btn { background: #28a745; color: white;}
    .delete-btn, .reject-btn { background: #dc3545; color: white;}
    .stamp-btn:disabled { background: #6c757d !important; cursor: not-allowed; transform: none !important;}
    .request-form { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 20px;}
    .request-item { background: white; padding: 15px; margin: 10px 0; border-radius: 8px; border: 1px solid #e1e5e9;}
    .request-pending { border-left: 4px solid #ffc107;}
    .request-approved { border-left: 4px solid #28a745;}
    .request-rejected { border-left: 4px solid #dc3545;}
    @media (max-width: 600px) {
      .container { padding: 20px; margin: 10px;}
      .logo { font-size: 2em;}
      .stamp-buttons { grid-template-columns: 1fr;}
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒªã‚¢ -->
    <div id="login-area">
      <div class="logo">KAORY</div>
      <div class="company-name">æ ªå¼ä¼šç¤¾ æˆä¼¸å·¥æ¥­ å‡ºé€€å‹¤ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </div>
      <div class="form-group">
        <label for="department">éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„</label>
        <select id="department" onchange="updateSections()">
          <option value="">-- éƒ¨ç½²ã‚’é¸æŠ --</option>
        </select>
      </div>
      <div class="form-group">
        <label for="section">èª²ã‚’é¸æŠã—ã¦ãã ã•ã„</label>
        <select id="section" onchange="updateEmployees()" disabled>
          <option value="">-- èª²ã‚’é¸æŠ --</option>
        </select>
      </div>
      <div class="form-group">
        <label for="employee">ãŠåå‰ã‚’é¸æŠã—ã¦ãã ã•ã„</label>
        <select id="employee" onchange="enableEmpNo()" disabled>
          <option value="">-- åå‰ã‚’é¸æŠ --</option>
        </select>
      </div>
      <div class="form-group">
        <label for="empno">ç¤¾å“¡ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</label>
        <input type="text" id="empno" placeholder="ç¤¾å“¡ç•ªå·" disabled>
      </div>
      <button class="login-btn" onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <div id="login-error" class="error"></div>
      <button class="admin-btn" onclick="showAdminLogin()" style="margin-top: 20px; background: #6c757d;">ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</button>
    </div>
    <!-- ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒªã‚¢ -->
    <div id="admin-login-area" class="hidden">
      <h2>ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</h2>
      <div class="form-group">
        <label for="admin-pass">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
        <input type="password" id="admin-pass" placeholder="ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
      </div>
      <button class="login-btn" onclick="adminLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <div id="admin-login-error" class="error"></div>
      <button onclick="showLoginArea()" class="logout-btn">æˆ»ã‚‹</button>
    </div>
    <!-- æ‰“åˆ»ã‚¨ãƒªã‚¢ -->
    <div id="stamp-area" class="hidden">
      <h2 id="user-greeting">ã“ã‚“ã«ã¡ã¯ï¼</h2>
      <div class="stamp-buttons">
        <button id="punch-in" class="stamp-btn in-btn" onclick="punchIn()">å‡ºå‹¤</button>
        <button id="punch-out" class="stamp-btn out-btn" onclick="punchOut()">é€€å‹¤</button>
      </div>
      <div id="roulette-area"></div>
      <div id="stamp-message" class="success"></div>
      <div id="qr-reader" class="hidden" style="margin-top:14px;"></div>
      <div id="history"></div>
      <!-- å¤‰æ›´ä¾é ¼ãƒ•ã‚©ãƒ¼ãƒ  -->
      <div class="request-form hidden" id="change-request-form">
        <h3>æ‰“åˆ»æ™‚åˆ»å¤‰æ›´ä¾é ¼</h3>
        <div class="form-group">
          <label for="request-type">å¤‰æ›´ã™ã‚‹æ‰“åˆ»</label>
          <select id="request-type">
            <option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>
          </select>
        </div>
        <div class="form-group">
          <label for="request-time">å¤‰æ›´å¾Œã®æ™‚åˆ»</label>
          <input type="datetime-local" id="request-time">
        </div>
        <div class="form-group">
          <label for="request-reason">å¤‰æ›´ç†ç”±</label>
          <textarea id="request-reason" placeholder="å¤‰æ›´ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
        </div>
        <button class="request-btn" onclick="submitChangeRequest()">å¤‰æ›´ä¾é ¼ã‚’é€ä¿¡</button>
        <button class="logout-btn" onclick="hideChangeRequestForm()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <div id="request-message" class="success"></div>
      </div>
      <button onclick="showChangeRequestForm()" class="admin-btn" style="margin-top: 10px;">æ‰“åˆ»æ™‚åˆ»å¤‰æ›´ä¾é ¼</button>
      <button onclick="logout()" class="logout-btn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
    <!-- ç®¡ç†è€…ã‚¨ãƒªã‚¢ -->
    <div id="admin-area" class="hidden">
      <h2>ç®¡ç†è€…ç”»é¢</h2>
      <!-- å¤‰æ›´ä¾é ¼ä¸€è¦§ -->
      <div id="change-requests">
        <h3>å¤‰æ›´ä¾é ¼ä¸€è¦§</h3>
        <div id="requests-list"></div>
      </div>
      <!-- å…¨æ‰“åˆ»å±¥æ­´ -->
      <div id="admin-history" style="margin-top: 30px;"></div>
      <button onclick="adminLogout()" class="logout-btn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
  </div>
  <script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let qrReader = null;
    let qrProcessing = false;
    let currentEmpNo = "";
    let currentEmpName = "";
    let currentPunchType = "";
    let isAdminLoggedIn = false;
    let historyData = {}; // æ‰“åˆ»å±¥æ­´ï¼ˆãƒ¡ãƒ¢ãƒªå†…ç®¡ç†ï¼‰
    let changeRequests = []; // å¤‰æ›´ä¾é ¼

    // çµ„ç¹”ãƒ‡ãƒ¼ã‚¿ï¼ˆæ ªå¼ä¼šç¤¾ æˆä¼¸å·¥æ¥­ï¼‰
    const organizationData = {
      "è£½é€ éƒ¨": {
        "è£½é€ èª²": [
          "å°å‚ æ•æ–‡", "ç‰‡å±± é›„å¸", "è±Šç”° å´‡è–", "å²¡ å¤§æˆ", "æ²³æœ¬ å“å“‰",
          "å²©ç”° ä¸€å¹³", "è—¤æ°¸ æ­¦å¿—", "é  é¾æˆ", "ç¦æµª æ™ºå¼˜", "è±Šç”° æŸ¾å¸Œ",
          "ãƒã‚ª", "ã‚½ãƒ³", "ãƒãƒ¥ãƒƒã‚¯", "ã‚´ã‚¢ãƒ³", "æ¸…å®¶ ç¿¼",
          "å°å· æ™ƒå¤§", "å‰æ°¸ è¼ä¹Ÿ", "ã‚¿ã‚¤ãƒ³", "æœ«ç•™ ç‘è¦", "ãƒ›ã‚¢ãƒ³",
          "ã‚¯ã‚¢ãƒ³", "ãƒ´â€•", "ãƒ†ã‚£ãƒ³"
        ],
        "æº¶æ¥èª²": [
          "è—¤åŸ ç§€ä¸€", "æ¨‹ä¸Š é›…å½¦", "ä½™ äºŒå¥", "é»’æœ¨ çœŸäºº", "è—¤ç”° æ™‹ä¹Ÿ",
          "ãƒ‡ãƒ­ã‚¹", "æ¾å· å“²ä¹Ÿ", "é«™æ©‹ æ·³", "ãƒ–ã‚ªãƒ³"
        ],
        "æŠ€è¡“æ”¯æ´èª²": ["ä¹…æ´¥é–“ å‰›"],
        "ãƒ­ãƒœãƒƒãƒˆã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³èª²": ["æ¡‘ç”° å¤§è¼”"],
        "ãƒ¬ãƒ¼ã‚¶ãƒ¼ã‚·ã‚¢ãƒªãƒ³ã‚°èª²": [
          "å¥¥æ±Ÿ äº®è¼”", "å¥¥æ±Ÿ èµ·çŸ¢", "å°æ— è¯ä»£", "æ±æ£® å¥å¤ª",
          "å¾Œè—¤ ä¸€ä¹Ÿ", "é–€ç”° ä¿¡å­", "å¤§å‡º ã‚ã‹ã­"
        ],
        "ï¼¨å½¢é‹¼æ©Ÿæ¢°åŠ å·¥èª²": [
          "è©åŸ æ­£å±•", "å°ç”° è£•æƒŸ", "ä¸‰è°· æ•å¤«", "æ— å¸",
          "å°ç”° æ­¦å£«", "åº§è³€ç™½ æ´‹ä¸€", "ç«¹åŸ è–ä¹Ÿ", "é«˜æœ¬ æœ‹å…¸", "é«˜æ©‹ äºœå®Ÿ"
        ]
      },
      "å·¥å‹™éƒ¨": {
        "è¨­è¨ˆèª²": [
          "è²æ¸… ä¿Šä¸€", "è—¤äº• æ•¦ä»", "ç•‘æœ¬ æ³°å®", "æ— çŠçŠ",
          "æ­¦æœ¬ ç¤¼", "ä»Šå· è–ä½³", "å‰å· å½©é¦™", "åºƒæ±Ÿ å°†å’Œ"
        ],
        "é…é€èª²": [
          "ä»Šæ‘ ä»", "ä¹ƒç¾ å´‡ä¸€éƒ", "å‚æœ¬ å¤§å’Œ", "å²¡åŸ ç”±æ´‹", "èŠ è³¢äºŒ"
        ],
        "å·¥äº‹èª²": ["çŸ³äº• å‹‡ä¹Ÿ", "æœªå‰ å°†å¿—"]
      },
      "ç·å‹™éƒ¨": {
        "ç·å‹™èª²": ["æ²³åŸ æ˜éŸ³", "é’æœ¨ å„ªèŠ±", "æ¥¢å´ æ˜å½¦"]
      }
    };

    // åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', function() {
      initializeDepartments();
    });

    function initializeDepartments() {
      const departmentSelect = document.getElementById('department');
      departmentSelect.innerHTML = '<option value="">-- éƒ¨ç½²ã‚’é¸æŠ --</option>';
      Object.keys(organizationData).forEach(dept => {
        const option = document.createElement('option');
        option.value = dept;
        option.textContent = dept;
        departmentSelect.appendChild(option);
      });
    }

    function updateSections() {
      const department = document.getElementById('department').value;
      const sectionSelect = document.getElementById('section');
      const employeeSelect = document.getElementById('employee');
      const empnoInput = document.getElementById('empno');
      sectionSelect.innerHTML = '<option value="">-- èª²ã‚’é¸æŠ --</option>';
      employeeSelect.innerHTML = '<option value="">-- åå‰ã‚’é¸æŠ --</option>';
      empnoInput.value = '';
      if (department && organizationData[department]) {
        sectionSelect.disabled = false;
        employeeSelect.disabled = true;
        empnoInput.disabled = true;
        Object.keys(organizationData[department]).forEach(section => {
          const option = document.createElement('option');
          option.value = section;
          option.textContent = section;
          sectionSelect.appendChild(option);
        });
      } else {
        sectionSelect.disabled = true;
        employeeSelect.disabled = true;
        empnoInput.disabled = true;
      }
    }

    function updateEmployees() {
      const department = document.getElementById('department').value;
      const section = document.getElementById('section').value;
      const employeeSelect = document.getElementById('employee');
      const empnoInput = document.getElementById('empno');
      employeeSelect.innerHTML = '<option value="">-- åå‰ã‚’é¸æŠ --</option>';
      empnoInput.value = '';
      empnoInput.disabled = true;
      if (department && section && organizationData[department] && organizationData[department][section]) {
        employeeSelect.disabled = false;
        organizationData[department][section].forEach(name => {
          const option = document.createElement('option');
          option.value = name;
          option.textContent = name;
          employeeSelect.appendChild(option);
        });
      } else {
        employeeSelect.disabled = true;
      }
    }

    function enableEmpNo() {
      const employee = document.getElementById('employee').value;
      const empnoInput = document.getElementById('empno');
      if (employee) {
        empnoInput.disabled = false;
      } else {
        empnoInput.disabled = true;
        empnoInput.value = '';
      }
    }

    function login() {
      const empno = document.getElementById('empno').value.trim();
      const empName = document.getElementById('employee').value;
      const loginError = document.getElementById('login-error');
      if (!empName || !empno) {
        loginError.textContent = 'éƒ¨ç½²ã€èª²ã€åå‰ã‚’é¸æŠã—ã€ç¤¾å“¡ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
        return;
      }
      currentEmpNo = empno;
      currentEmpName = empName;
      showStampArea();
    }

    function logout() {
      currentEmpNo = "";
      currentEmpName = "";
      // QRãƒªãƒ¼ãƒ€ãƒ¼ãŒã‚ã‚Œã°åœæ­¢
      if (qrReader && typeof qrReader.stop === "function") {
        qrReader.stop().catch(err => {});
      }
      qrReader = null;
      qrProcessing = false;
      showLoginArea();
      initializeDepartments();
    }

    function showLoginArea() {
      document.getElementById("login-area").classList.remove("hidden");
      document.getElementById("admin-login-area").classList.add("hidden");
      document.getElementById("stamp-area").classList.add("hidden");
      document.getElementById("admin-area").classList.add("hidden");
      document.getElementById('login-error').textContent = '';
      // QRãƒªãƒ¼ãƒ€ãƒ¼ãŒã‚ã‚Œã°åœæ­¢
      if (qrReader && typeof qrReader.stop === "function") {
        qrReader.stop().catch(err => {});
      }
      qrReader = null;
      qrProcessing = false;
    }

    function showAdminLogin() {
      document.getElementById("login-area").classList.add("hidden");
      document.getElementById("admin-login-area").classList.remove("hidden");
      document.getElementById('admin-login-error').textContent = '';
      document.getElementById('admin-pass').value = '';
    }

    function showStampArea() {
      document.getElementById("login-area").classList.add("hidden");
      document.getElementById("admin-login-area").classList.add("hidden");
      document.getElementById("stamp-area").classList.remove("hidden");
      document.getElementById("admin-area").classList.add("hidden");
      document.getElementById("user-greeting").textContent = `${currentEmpName}ã•ã‚“ã€ãŠç–²ã‚Œæ§˜ã§ã™ï¼`;
      document.getElementById("stamp-message").innerHTML = "";
      document.getElementById("roulette-area").innerHTML = "";
      document.getElementById("qr-reader").classList.add("hidden");
      updateStampButtons();
      renderHistory();
    }

    // ä»Šæ—¥ã®æ—¥ä»˜ã‚’å–å¾—ï¼ˆYYYY-MM-DDå½¢å¼ï¼‰
    function getTodayDate() {
      const now = new Date();
      return now.toISOString().split('T')[0];
    }

    // ä»Šæ—¥ã™ã§ã«æ‰“åˆ»ã—ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    function hasPunchedToday(type) {
      if (!historyData[currentEmpNo]) return false;
      const today = getTodayDate();
      return historyData[currentEmpNo].some(h =>
        h.type === type && h.date.startsWith(today)
      );
    }

    // æ‰“åˆ»ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
    function updateStampButtons() {
      const punchInBtn = document.getElementById("punch-in");
      const punchOutBtn = document.getElementById("punch-out");
      punchInBtn.disabled = hasPunchedToday("å‡ºå‹¤");
      punchOutBtn.disabled = hasPunchedToday("é€€å‹¤");
      punchInBtn.textContent = punchInBtn.disabled ? "å‡ºå‹¤æ¸ˆã¿" : "å‡ºå‹¤";
      punchOutBtn.textContent = punchOutBtn.disabled ? "é€€å‹¤æ¸ˆã¿" : "é€€å‹¤";
    }

    // å‡ºå‹¤å‡¦ç†
    function punchIn() {
      if (hasPunchedToday("å‡ºå‹¤")) {
        alert("æœ¬æ—¥ã¯ã™ã§ã«å‡ºå‹¤æ¸ˆã¿ã§ã™ã€‚");
        return;
      }
      currentPunchType = "å‡ºå‹¤";
      startQrReader("å‡ºå‹¤");
    }

    // é€€å‹¤å‡¦ç†
    function punchOut() {
      if (hasPunchedToday("é€€å‹¤")) {
        alert("æœ¬æ—¥ã¯ã™ã§ã«é€€å‹¤æ¸ˆã¿ã§ã™ã€‚");
        return;
      }
      currentPunchType = "é€€å‹¤";
      startQrReader("é€€å‹¤");
    }

    // --- QRã‚³ãƒ¼ãƒ‰ã‚«ãƒ¡ãƒ©èª­å–æ©Ÿèƒ½ ---
    function startQrReader(type) {
      // æ—¢å­˜ãƒªãƒ¼ãƒ€ãƒ¼åœæ­¢
      if (qrReader) {
        try { qrReader.clear(); } catch(e) {}
      }
      qrProcessing = false;
      document.getElementById("qr-reader").classList.remove("hidden");
      document.getElementById("roulette-area").innerHTML = "";
      document.getElementById("stamp-message").innerHTML = '<span style="color:#0072bc;">QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ã¦ã„ã¾ã™...</span>';
      qrReader = new Html5Qrcode("qr-reader");
      qrReader.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        qrCodeMessage => {
          if (qrProcessing) return;
          qrProcessing = true;
          document.getElementById("stamp-message").innerHTML = `<span style="color:#0072bc;">ä½ç½®æƒ…å ±ã‚’å–å¾—ã—ã¦ã„ã¾ã™...</span>`;
          processQrResult(qrCodeMessage, type);
          qrReader.stop().then(() => {
            document.getElementById("qr-reader").classList.add("hidden");
            qrProcessing = false;
          }).catch(() => {
            document.getElementById("qr-reader").classList.add("hidden");
            qrProcessing = false;
          });
        },
        errorMessage => {
          // èª­ã¿å–ã‚Šå¤±æ•—æ™‚ã¯ä½•ã‚‚ã—ãªã„
        }
      ).catch(err => {
        document.getElementById("stamp-message").innerHTML = `<span style="color:red;">ã‚«ãƒ¡ãƒ©ãŒèµ·å‹•ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚è¨±å¯ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</span>`;
        document.getElementById("qr-reader").classList.add("hidden");
        qrProcessing = false;
      });
    }
    // QRèª­å–å¾Œã®æ‰“åˆ»å‡¦ç†
    function processQrResult(qrCodeMessage, type) {
      // ã“ã“ã§QRã‚³ãƒ¼ãƒ‰ã®å†…å®¹ãƒã‚§ãƒƒã‚¯ã‚„èªè¨¼ã‚’å¿…è¦ã«å¿œã˜ã¦å®Ÿè£…
      // ä¾‹: "kaory-entrance" ã¨ã„ã†QRã‚³ãƒ¼ãƒ‰ã®ã¿æœ‰åŠ¹ã¨ã™ã‚‹
      if (qrCodeMessage !== "kaory-entrance") {
        document.getElementById("stamp-message").innerHTML = `<span style="color:red;">ç„¡åŠ¹ãªQRã‚³ãƒ¼ãƒ‰ã§ã™ã€‚</span>`;
        return;
      }
      // ä½ç½®æƒ…å ±å–å¾—
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          pos => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            recordPunch(type, lat, lng);
          },
          err => {
            document.getElementById("stamp-message").innerHTML = `<span style="color:red;">ä½ç½®æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚</span>`;
          }
        );
      } else {
        document.getElementById("stamp-message").innerHTML = `<span style="color:red;">ä½ç½®æƒ…å ±éå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã§ã™ã€‚</span>`;
      }
    }

    // æ‰“åˆ»è¨˜éŒ²
    function recordPunch(type, lat, lng) {
      const now = new Date();
      const dateStr = now.toLocaleString('ja-JP', { hour12: false });
      if (!historyData[currentEmpNo]) historyData[currentEmpNo] = [];
      historyData[currentEmpNo].push({
        type,
        date: now.toISOString(),
        dispDate: dateStr,
        lat,
        lng
      });
      document.getElementById("stamp-message").innerHTML = `<span style="color:#28a745;">${type}æ‰“åˆ»ãŒå®Œäº†ã—ã¾ã—ãŸã€‚</span>`;
      showRoulette(type);
      updateStampButtons();
      renderHistory();
    }

    // ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆè¡¨ç¤º
    function showRoulette(type) {
      const rouletteArea = document.getElementById("roulette-area");
      const isWin = Math.random() < 0.1; // 10%ã§å½“ãŸã‚Š
      if (isWin) {
        rouletteArea.innerHTML = `<div class="roulette-win">ğŸ‰ ãŠã‚ã§ã¨ã†ï¼${type}ã‚¬ãƒãƒ£å¤§å½“ãŸã‚Šï¼<br>æœ¬æ—¥ã®ãƒ©ãƒƒã‚­ãƒ¼è³ï¼</div>`;
      } else {
        rouletteArea.innerHTML = `<div class="roulette-lose">æœ¬æ—¥ã‚‚ãŠä»•äº‹ãŠç–²ã‚Œæ§˜ã§ã™ï¼</div>`;
      }
    }

    // å±¥æ­´è¡¨ç¤º
    function renderHistory() {
      const historyDiv = document.getElementById("history");
      historyDiv.innerHTML = "<h3>æœ¬æ—¥ã®æ‰“åˆ»å±¥æ­´</h3>";
      const today = getTodayDate();
      const logs = (historyData[currentEmpNo] || []).filter(h => h.date.startsWith(today));
      if (logs.length === 0) {
        historyDiv.innerHTML += "<div>æœ¬æ—¥ã®æ‰“åˆ»ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>";
        return;
      }
      logs.forEach(h => {
        historyDiv.innerHTML += `<div class="history-entry">${h.dispDate}ï¼š${h.type}ï¼ˆä½ç½®æƒ…å ±: ${h.lat.toFixed(4)}, ${h.lng.toFixed(4)}ï¼‰</div>`;
      });
    }

    // ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³
    function adminLogin() {
      const pass = document.getElementById('admin-pass').value;
      const adminError = document.getElementById('admin-login-error');
      if (pass === "kaoryadmin") { // ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
        isAdminLoggedIn = true;
        showAdminArea();
      } else {
        adminError.textContent = "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚";
      }
    }

    function adminLogout() {
      isAdminLoggedIn = false;
      showLoginArea();
    }

    function showAdminArea() {
      document.getElementById("login-area").classList.add("hidden");
      document.getElementById("admin-login-area").classList.add("hidden");
      document.getElementById("stamp-area").classList.add("hidden");
      document.getElementById("admin-area").classList.remove("hidden");
      renderChangeRequests();
      renderAdminHistory();
    }

    // å¤‰æ›´ä¾é ¼ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤º
    function showChangeRequestForm() {
      document.getElementById("change-request-form").classList.remove("hidden");
      // ä¾é ¼å¯èƒ½ãªæ‰“åˆ»ç¨®åˆ¥ã‚’ã‚»ãƒƒãƒˆ
      const reqTypeSel = document.getElementById("request-type");
      reqTypeSel.innerHTML = '<option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>';
      const today = getTodayDate();
      const logs = (historyData[currentEmpNo] || []).filter(h => h.date.startsWith(today));
      logs.forEach(h => {
        reqTypeSel.innerHTML += `<option value="${h.type}">${h.type}ï¼ˆ${h.dispDate}ï¼‰</option>`;
      });
      document.getElementById("request-time").value = "";
      document.getElementById("request-reason").value = "";
      document.getElementById("request-message").textContent = "";
    }

    function hideChangeRequestForm() {
      document.getElementById("change-request-form").classList.add("hidden");
    }

    // å¤‰æ›´ä¾é ¼é€ä¿¡
    function submitChangeRequest() {
      const type = document.getElementById("request-type").value;
      const newTime = document.getElementById("request-time").value;
      const reason = document.getElementById("request-reason").value.trim();
      const reqMsg = document.getElementById("request-message");
      if (!type || !newTime || !reason) {
        reqMsg.textContent = "å…¨ã¦å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
        reqMsg.style.color = "#dc3545";
        return;
      }
      changeRequests.push({
        empNo: currentEmpNo,
        empName: currentEmpName,
        type,
        newTime,
        reason,
        status: "pending"
      });
      reqMsg.textContent = "å¤‰æ›´ä¾é ¼ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚";
      reqMsg.style.color = "#28a745";
      setTimeout(hideChangeRequestForm, 1000);
    }

    // ç®¡ç†è€…ï¼šå¤‰æ›´ä¾é ¼ä¸€è¦§è¡¨ç¤º
    function renderChangeRequests() {
      const reqListDiv = document.getElementById("requests-list");
      reqListDiv.innerHTML = "";
      if (changeRequests.length === 0) {
        reqListDiv.innerHTML = "<div>å¤‰æ›´ä¾é ¼ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>";
        return;
      }
      changeRequests.forEach((req, idx) => {
        let statusClass = "request-pending";
        if (req.status === "approved") statusClass = "request-approved";
        if (req.status === "rejected") statusClass = "request-rejected";
        reqListDiv.innerHTML +=
          `<div class="request-item ${statusClass}">
            <b>${req.empName}</b>ï¼ˆ${req.empNo}ï¼‰<br>
            <b>${req.type}</b>ã®æ™‚åˆ»ã‚’
            <b>${new Date(req.newTime).toLocaleString('ja-JP')}</b>ã«å¤‰æ›´å¸Œæœ›<br>
            ç†ç”±: ${req.reason}<br>
            <span>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${req.status === "pending" ? "æ‰¿èªå¾…ã¡" : req.status === "approved" ? "æ‰¿èª" : "å´ä¸‹"}</span><br>
            ${req.status === "pending" ?
              `<button class="approve-btn" onclick="approveRequest(${idx})">æ‰¿èª</button>
               <button class="reject-btn" onclick="rejectRequest(${idx})">å´ä¸‹</button>` : ""}
          </div>`;
      });
    }

    // ç®¡ç†è€…ï¼šä¾é ¼æ‰¿èª
    function approveRequest(idx) {
      const req = changeRequests[idx];
      req.status = "approved";
      // å±¥æ­´ã‚’ä¿®æ­£
      if (historyData[req.empNo]) {
        const today = getTodayDate();
        const log = historyData[req.empNo].find(h => h.type === req.type && h.date.startsWith(today));
        if (log) {
          log.date = new Date(req.newTime).toISOString();
          log.dispDate = new Date(req.newTime).toLocaleString('ja-JP', { hour12: false });
        }
      }
      renderChangeRequests();
      renderAdminHistory();
    }

    // ç®¡ç†è€…ï¼šä¾é ¼å´ä¸‹
    function rejectRequest(idx) {
      changeRequests[idx].status = "rejected";
      renderChangeRequests();
    }

    // ç®¡ç†è€…ï¼šå…¨æ‰“åˆ»å±¥æ­´
    function renderAdminHistory() {
      const div = document.getElementById("admin-history");
      div.innerHTML = "<h3>å…¨ç¤¾å“¡ã®æœ¬æ—¥æ‰“åˆ»å±¥æ­´</h3>";
      const today = getTodayDate();
      let found = false;
      Object.keys(historyData).forEach(empNo => {
        const logs = historyData[empNo].filter(h => h.date.startsWith(today));
        if (logs.length > 0) {
          found = true;
          div.innerHTML += `<div style="margin-bottom:8px;"><b>${empNo}</b>ï¼š<br>`;
          logs.forEach(h => {
            div.innerHTML += `ã€€${h.dispDate}ï¼š${h.type}ï¼ˆä½ç½®æƒ…å ±: ${h.lat.toFixed(4)}, ${h.lng.toFixed(4)}ï¼‰<br>`;
          });
          div.innerHTML += `</div>`;
        }
      });
      if (!found) div.innerHTML += "<div>æœ¬æ—¥ã®æ‰“åˆ»å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>";
    }
  </script>
</body>
</html>
