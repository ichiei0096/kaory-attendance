<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>KAORY</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    /* æ—¢å­˜ã‚¹ã‚¿ã‚¤ãƒ«ã¯çœç•¥ï¼ˆå…ƒã‚³ãƒ¼ãƒ‰ã¨åŒã˜ï¼‰ */
    body {
      font-family: 'Segoe UI', 'Meiryo', sans-serif;
      background: #f2f6fa;
      margin: 0;
      padding: 0;
    }
    header {
      background: #0072bc;
      color: #fff;
      padding: 18px 10px 12px 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .main-title {
      font-size: 2em;
      font-weight: bold;
      letter-spacing: 0.1em;
      margin-bottom: 6px;
    }
    .subtitle {
      font-size: 1.05em;
      opacity: 0.92;
      letter-spacing: 0.04em;
    }
    main {
      max-width: 480px;
      margin: 32px auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 16px rgba(0,0,0,0.06);
      padding: 24px 18px 32px 18px;
    }
    #result {
      font-size: 1.2em;
      margin: 12px 0;
      min-height: 1.8em;
    }
    #roulette-area {
      margin: 12px 0 0 0;
      min-height: 3em;
    }
    #history {
      margin-top: 24px;
      background: #f8f8f8;
      border-radius: 8px;
      padding: 16px;
      font-size: 0.98em;
      word-break: break-all;
    }
    .btn {
      background: #0072bc;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 12px 28px;
      font-size: 1.1em;
      cursor: pointer;
      margin: 10px 0;
      transition: background 0.2s;
    }
    .btn:hover {
      background: #005fa3;
    }
    .hidden {
      display: none;
    }
    .history-entry {
      margin-bottom: 10px;
      border-bottom: 1px dotted #b2cbe4;
      padding-bottom: 7px;
    }
    .edit-btn, .delete-btn {
      background: #eee;
      color: #333;
      border: none;
      border-radius: 3px;
      padding: 3px 9px;
      font-size: 0.97em;
      margin-left: 7px;
      cursor: pointer;
    }
    .edit-btn:hover, .delete-btn:hover {
      background: #cbe3fa;
    }
    .input-row {
      margin-bottom: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .input-row label {
      min-width: 80px;
      font-weight: bold;
    }
    .input-row input {
      flex: 1;
      font-size: 1.1em;
      padding: 7px 8px;
      border: 1px solid #b2cbe4;
      border-radius: 5px;
    }
    .inout-btns {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
    }
    .inout-btn {
      flex: 1;
      font-size: 1.1em;
      font-weight: bold;
      padding: 12px 0;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      transition: background 0.2s;
    }
    .in-btn {
      background: #4caf50;
      color: #fff;
    }
    .in-btn:hover {
      background: #388e3c;
    }
    .out-btn {
      background: #f44336;
      color: #fff;
    }
    .out-btn:hover {
      background: #c62828;
    }
    .logout-btn {
      background: #999;
      color: #fff;
      border: none;
      border-radius: 5px;
      padding: 7px 18px;
      font-size: 1em;
      margin-top: 10px;
      cursor: pointer;
    }
    .logout-btn:hover {
      background: #666;
    }
    /* ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆæ¼”å‡ºç”¨ */
    .roulette-win {
      color: #eabf00;
      background: #fffbe8;
      font-size: 1.2em;
      font-weight: bold;
      padding: 10px;
      border-radius: 8px;
      margin-top: 5px;
      animation: flash 1s 2;
    }
    .roulette-lose {
      color: #888;
      background: #f4f4f4;
      font-size: 1.1em;
      padding: 10px;
      border-radius: 8px;
      margin-top: 5px;
    }
    @keyframes flash {
      0% { background: #fffbe8; }
      50% { background: #fff3a0; }
      100% { background: #fffbe8; }
    }
    @media (max-width: 600px) {
      main {
        margin: 12px 3px;
        padding: 12px 3vw 16px 3vw;
      }
      header {
        font-size: 1em;
        padding: 12px 3vw;
      }
      .main-title {
        font-size: 1.3em;
      }
      .subtitle {
        font-size: 0.95em;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="main-title">KAORY</div>
    <div class="subtitle">æ ªå¼ä¼šç¤¾ æˆä¼¸å·¥æ¥­ å‡ºé€€å‹¤å°‚ç”¨ã‚¢ãƒ—ãƒª</div>
  </header>
  <main>
    <!-- ç¤¾å“¡ç•ªå·å…¥åŠ›ç”»é¢ -->
    <div id="login-area">
      <h2 style="margin-top:0;">ç¤¾å“¡ç•ªå·å…¥åŠ›</h2>
      <div class="input-row">
        <label for="empno">ç¤¾å“¡ç•ªå·</label>
        <input type="text" id="empno" maxlength="10" autocomplete="off" placeholder="ä¾‹: 1234">
      </div>
      <button class="btn" onclick="login()">æ¬¡ã¸</button>
      <div id="login-error" style="color:red;min-height:1.5em;"></div>
    </div>
    <!-- æ‰“åˆ»ç”»é¢ -->
    <div id="stamp-area" class="hidden">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h2 style="margin:0;">å‡ºé€€å‹¤æ‰“åˆ»</h2>
        <button class="logout-btn" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>
      <div style="margin-bottom:10px;">
        <b>ç¤¾å“¡ç•ªå·ï¼š</b><span id="current-empno"></span>
      </div>
      <div class="inout-btns">
        <button class="inout-btn in-btn" onclick="startQrReader('å‡ºå‹¤')">å‡ºå‹¤</button>
        <button class="inout-btn out-btn" onclick="startQrReader('é€€å‹¤')">é€€å‹¤</button>
      </div>
      <div id="result"></div>
      <div id="roulette-area"></div>
      <div id="qr-reader" class="hidden" style="margin-top:14px;"></div>
      <div id="history"></div>
    </div>
  </main>
  <script>
    let qrReader = null;
    let qrProcessing = false;
    let punchType = "";
    let currentEmpNo = "";

    // ãƒšãƒ¼ã‚¸è¡¨ç¤ºæ™‚ã«ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ç¢ºèª
    window.onload = function() {
      const empno = sessionStorage.getItem("empno");
      if(empno) {
        showStampArea(empno);
      } else {
        showLoginArea();
      }
    };

    function login() {
      const emp = document.getElementById('empno').value.trim();
      if (!emp) {
        document.getElementById("login-error").innerText = "ç¤¾å“¡ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";
        return;
      }
      sessionStorage.setItem("empno", emp);
      showStampArea(emp);
    }

    function logout() {
      sessionStorage.removeItem("empno");
      showLoginArea();
    }

    function showLoginArea() {
      document.getElementById("login-area").classList.remove("hidden");
      document.getElementById("stamp-area").classList.add("hidden");
      document.getElementById('empno').value = "";
      document.getElementById("login-error").innerText = "";
    }

    function showStampArea(empno) {
      currentEmpNo = empno;
      document.getElementById("current-empno").innerText = empno;
      document.getElementById("login-area").classList.add("hidden");
      document.getElementById("stamp-area").classList.remove("hidden");
      document.getElementById("result").innerHTML = "";
      document.getElementById("roulette-area").innerHTML = "";
      document.getElementById("qr-reader").classList.add("hidden");
      renderHistory();
    }

    function startQrReader(type) {
      punchType = type;
      document.getElementById("result").innerHTML = "";
      document.getElementById("roulette-area").innerHTML = "";
      document.getElementById("qr-reader").classList.remove("hidden");
      if (qrReader) qrReader.clear();
      qrReader = new Html5Qrcode("qr-reader");
      qrProcessing = false;
      qrReader.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        qrCodeMessage => {
          if (qrProcessing) return;
          qrProcessing = true;
          document.getElementById("result").innerHTML = `<span style="color:#0072bc;">ä½ç½®æƒ…å ±ã‚’å–å¾—ã—ã¦ã„ã¾ã™...</span>`;
          navigator.geolocation.getCurrentPosition(
            function(position) {
              addHistory(currentEmpNo, punchType, qrCodeMessage, new Date(), position.coords, navigator.userAgent);
              document.getElementById("result").innerHTML = `<span style="color:green;">${punchType}æ‰“åˆ»ã—ã¾ã—ãŸ</span>`;
              qrReader.stop();
              document.getElementById("qr-reader").classList.add("hidden");
              qrProcessing = false;
              showRoulette();
            },
            function(error) {
              addHistory(currentEmpNo, punchType, qrCodeMessage, new Date(), null, navigator.userAgent);
              document.getElementById("result").innerHTML = `<span style="color:red;">ä½ç½®æƒ…å ±ã‚¨ãƒ©ãƒ¼ï¼ˆ${error.message}ï¼‰</span>`;
              qrReader.stop();
              document.getElementById("qr-reader").classList.add("hidden");
              qrProcessing = false;
              showRoulette();
            }
          );
        },
        errorMessage => {}
      );
    }

    // ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆæ¼”å‡ºã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
    function showRoulette() {
      const rouletteDiv = document.getElementById("roulette-area");
      rouletteDiv.innerHTML = '<span style="color:#0072bc;">ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆä¸­...</span>';
      setTimeout(() => {
        const isWin = Math.random() < 0.5;
        if (isWin) {
          rouletteDiv.innerHTML = `<div class="roulette-win">
            ğŸ‰å½“ãŸã‚Šï¼ã‚¸ãƒ¥ãƒ¼ã‚¹ä¸€æœ¬ç„¡æ–™ï¼ğŸ‰<br>
            <span style="font-size:1em;">ã‚¹ã‚¯ã‚·ãƒ§ã‚’æ’®ã£ã¦ç·å‹™éƒ¨ã¸æç¤ºã—ã¦ã­ï¼</span><br>
            <img src="https://media.giphy.com/media/111ebonMs90YLu/giphy.gif" alt="å½“ãŸã‚Š" style="width:120px;margin-top:5px;">
          </div>`;
        } else {
          rouletteDiv.innerHTML = `<div class="roulette-lose">
            ã¯ãšã‚Œï½ã¾ãŸæŒ‘æˆ¦ã—ã¦ã­ï¼<br>
            <img src="https://media.giphy.com/media/3oEjI6SIIHBdRxXI40/giphy.gif" alt="ã¯ãšã‚Œ" style="width:80px;margin-top:5px;">
          </div>`;
        }
      }, 900); // ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆä¸­ã®æ¼”å‡ºã‚’0.9ç§’è¡¨ç¤º
    }

    function addHistory(empno, type, qr, date, coords, device) {
      let key = "history_" + empno;
      let history = JSON.parse(localStorage.getItem(key) || "[]");
      const entry = {
        type,
        qr,
        date: date.toLocaleString(),
        lat: coords ? coords.latitude : null,
        lng: coords ? coords.longitude : null,
        device: device || ""
      };
      history.unshift(entry);
      localStorage.setItem(key, JSON.stringify(history));
      renderHistory();
    }

    function renderHistory() {
      let key = "history_" + currentEmpNo;
      let history = JSON.parse(localStorage.getItem(key) || "[]");
      let html = "<b>æ‰“åˆ»å±¥æ­´</b><br>";
      if (history.length === 0) {
        html += "<span style='color:#888;'>ã¾ã å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</span>";
      } else {
        history.forEach((h, i) => {
          html += `<div class="history-entry">
            [${h.date}]<br>
            ç¨®åˆ¥: <b>${h.type}</b><br>
            QRå†…å®¹: <b>${h.qr}</b>
            ${h.lat && h.lng ? `<br>ä½ç½®: <a href="https://www.google.com/maps?q=${h.lat},${h.lng}" target="_blank">${h.lat.toFixed(5)},${h.lng.toFixed(5)}</a>` : "<br>ä½ç½®: ãªã—"}
            <br>ç«¯æœ«æƒ…å ±: <span style="font-size:0.95em;">${h.device ? escapeHtml(h.device) : "ãªã—"}</span>
            <br>
            <button class="edit-btn" onclick="editHistory(${i})">ç·¨é›†</button>
            <button class="delete-btn" onclick="deleteHistory(${i})">å‰Šé™¤</button>
          </div>`;
        });
      }
      document.getElementById("history").innerHTML = html;
    }

    function escapeHtml(str) {
      return str.replace(/[&<>"'`]/g, function(match) {
        return ({
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;',
          '`': '&#x60;'
        })[match];
      });
    }

    function editHistory(index) {
      let key = "history_" + currentEmpNo;
      let history = JSON.parse(localStorage.getItem(key) || "[]");
      let h = history[index];
      let newQr = prompt("QRå†…å®¹ã‚’ç·¨é›†", h.qr);
      if (newQr && newQr.trim()) {
        h.qr = newQr.trim();
        history[index] = h;
        localStorage.setItem(key, JSON.stringify(history));
        renderHistory();
      }
    }

    function deleteHistory(index) {
      if (!confirm("ã“ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
      let key = "history_" + currentEmpNo;
      let history = JSON.parse(localStorage.getItem(key) || "[]");
      history.splice(index, 1);
      localStorage.setItem(key, JSON.stringify(history));
      renderHistory();
    }
  </script>
</body>
</html>
