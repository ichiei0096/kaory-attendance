<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KAORY - æ ªå¼ä¼šç¤¾ æˆä¼¸å·¥æ¥­ å‡ºé€€å‹¤ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', 'Meiryo', sans-serif;
      background: #f2f6fa;
      margin: 0;
      padding: 0;
    }
    header {
      background: #0072bc;
      color: #fff;
      padding: 18px 10px 12px 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .main-title {
      font-size: 2em;
      font-weight: bold;
      letter-spacing: 0.1em;
      margin-bottom: 6px;
    }
    .subtitle {
      font-size: 1.05em;
      opacity: 0.92;
      letter-spacing: 0.04em;
    }
    main {
      max-width: 480px;
      margin: 32px auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 16px rgba(0,0,0,0.06);
      padding: 24px 18px 32px 18px;
    }
    #result {
      font-size: 1.2em;
      margin: 12px 0;
      min-height: 1.8em;
    }
    #roulette-area {
      margin: 12px 0 0 0;
      min-height: 3em;
    }
    #history {
      margin-top: 24px;
      background: #f8f8f8;
      border-radius: 8px;
      padding: 16px;
      font-size: 0.98em;
      word-break: break-all;
    }
    .btn {
      background: #0072bc;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 12px 28px;
      font-size: 1.1em;
      cursor: pointer;
      margin: 10px 0;
      transition: background 0.2s;
      width: 100%;
    }
    .btn:hover {
      background: #005fa3;
    }
    .btn:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    .hidden {
      display: none;
    }
    .history-entry {
      margin-bottom: 10px;
      border-bottom: 1px dotted #b2cbe4;
      padding-bottom: 7px;
    }
    #login-area label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #555;
      text-align: left;
    }
    #login-area select, #login-area input {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .input-row {
      margin-bottom: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .input-row label {
      min-width: 80px;
      font-weight: bold;
    }
    .input-row input {
      flex: 1;
      font-size: 1.1em;
      padding: 7px 8px;
      border: 1px solid #b2cbe4;
      border-radius: 5px;
    }
    .inout-btns {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
    }
    .inout-btn {
      flex: 1;
      font-size: 1.1em;
      font-weight: bold;
      padding: 12px 0;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      transition: background 0.2s;
    }
    .in-btn {
      background: #4caf50;
      color: #fff;
    }
    .in-btn:hover {
      background: #388e3c;
    }
    .in-btn:disabled {
      background: #ccc !important;
    }
    .out-btn {
      background: #f44336;
      color: #fff;
    }
    .out-btn:hover {
      background: #c62828;
    }
    .out-btn:disabled {
      background: #ccc !important;
    }
    .logout-btn {
      background: #999;
      color: #fff;
      border: none;
      border-radius: 5px;
      padding: 7px 18px;
      font-size: 1em;
      margin-top: 10px;
      cursor: pointer;
    }
    .logout-btn:hover {
      background: #666;
    }
    .roulette-win {
      color: #eabf00;
      background: #fffbe8;
      font-size: 1.2em;
      font-weight: bold;
      padding: 10px;
      border-radius: 8px;
      margin-top: 5px;
      animation: flash 1s 2;
    }
    .roulette-lose {
      color: #888;
      background: #f4f4f4;
      font-size: 1.1em;
      padding: 10px;
      border-radius: 8px;
      margin-top: 5px;
    }
    @keyframes flash {
      0% { background: #fffbe8; }
      50% { background: #fff3a0; }
      100% { background: #fffbe8; }
    }
    /* å¤‰æ›´ä¾é ¼ãƒ•ã‚©ãƒ¼ãƒ  */
    .request-form {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      margin-top: 20px;
    }
    .request-form label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #555;
      text-align: left;
    }
    .request-form select, .request-form input, .request-form textarea {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .request-form textarea {
      min-height: 100px;
      resize: vertical;
    }
    /* ç®¡ç†è€…ç”»é¢ */
    #admin-area {
      margin-top: 24px;
    }
    .admin-history-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.97em;
      margin-top: 10px;
      table-layout: fixed;
    }
    .admin-history-table th, .admin-history-table td {
      border: 1px solid #b2cbe4;
      padding: 4px 2px;
      text-align: left;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .admin-history-table th {
      background: #e9f3fa;
      font-size: 0.97em;
    }
    .admin-history-table tr:nth-child(even) {
      background: #f7fafc;
    }
    .request-item {
      background: white;
      padding: 15px;
      margin: 10px 0;
      border-radius: 8px;
      border: 1px solid #e1e5e9;
    }
    .request-pending {
      border-left: 4px solid #ffc107;
    }
    .request-approved {
      border-left: 4px solid #28a745;
    }
    .request-rejected {
      border-left: 4px solid #dc3545;
    }
    .approve-btn, .reject-btn {
      padding: 5px 10px;
      margin: 5px 5px 0 0;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8em;
    }
    .approve-btn {
      background: #28a745;
      color: white;
    }
    .reject-btn {
      background: #dc3545;
      color: white;
    }
    @media (max-width: 600px) {
      main {
        margin: 12px 3px;
        padding: 12px 3vw 16px 3vw;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="main-title">KAORY</div>
    <div class="subtitle">æ ªå¼ä¼šç¤¾ æˆä¼¸å·¥æ¥­ å‡ºé€€å‹¤ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </div>
  </header>
  <main>
    <!-- ãƒ­ã‚°ã‚¤ãƒ³é¸æŠç”»é¢ -->
    <div id="login-area">
      <h2 style="margin-top:0;">ãƒ­ã‚°ã‚¤ãƒ³</h2>
      <label for="department">éƒ¨ç½²:</label>
      <select id="department" name="department">
        <option value="">-- éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>
      </select>

      <label for="section">èª²:</label>
      <select id="section" name="section" disabled>
        <option value="">-- èª²ã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>
      </select>

      <label for="employee">åå‰:</label>
      <select id="employee" name="employee" disabled>
        <option value="">-- åå‰ã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>
      </select>

      <label for="empno">ç¤¾å“¡ç•ªå·:</label>
      <input type="text" id="empno" placeholder="ç¤¾å“¡ç•ªå·ã‚’å…¥åŠ›" disabled>

      <button id="loginButton" class="btn" onclick="login()" disabled>ãƒ­ã‚°ã‚¤ãƒ³</button>
      <div id="login-error" style="color:red;min-height:1.5em;"></div>

      <!-- ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ  -->
      <div id="admin-login-area" style="margin-top:22px;">
        <hr>
        <div><b>ç®¡ç†è€…å°‚ç”¨ãƒ­ã‚°ã‚¤ãƒ³</b></div>
        <div class="input-row" style="margin-bottom:5px;">
          <label for="admin-pass" style="min-width:70px;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
          <input type="password" id="admin-pass" maxlength="20" autocomplete="off" style="max-width:140px;">
        </div>
        <button class="btn" style="padding:8px 22px;font-size:1em;" onclick="adminLogin()">ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</button>
        <div id="admin-login-error" style="color:red;min-height:1.5em;"></div>
      </div>
    </div>

    <!-- æ‰“åˆ»ç”»é¢ -->
    <div id="stamp-area" class="hidden">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h2 style="margin:0;">å‡ºé€€å‹¤æ‰“åˆ»</h2>
        <button class="logout-btn" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>
      <div style="margin-bottom:10px;">
        <b>ç¤¾å“¡ç•ªå·ï¼š</b><span id="current-empno"></span> <br>
        <b>åå‰ï¼š</b><span id="current-empname"></span>
      </div>
      <div class="inout-btns">
        <button id="punch-in-btn" class="inout-btn in-btn" onclick="startQrReader('å‡ºå‹¤')">å‡ºå‹¤</button>
        <button id="punch-out-btn" class="inout-btn out-btn" onclick="startQrReader('é€€å‹¤')">é€€å‹¤</button>
      </div>
      <div id="result"></div>
      <div id="roulette-area"></div>
      <div id="qr-reader" class="hidden" style="margin-top:14px;"></div>
      <div id="history"></div>
      
      <!-- å¤‰æ›´ä¾é ¼ãƒ•ã‚©ãƒ¼ãƒ  -->
      <div class="request-form hidden" id="change-request-form">
        <h3>æ‰“åˆ»æ™‚åˆ»å¤‰æ›´ä¾é ¼</h3>
        <label for="request-type">å¤‰æ›´ã™ã‚‹æ‰“åˆ»:</label>
        <select id="request-type">
          <option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>
        </select>
        
        <label for="request-time">å¤‰æ›´å¾Œã®æ™‚åˆ»:</label>
        <input type="datetime-local" id="request-time">
        
        <label for="request-reason">å¤‰æ›´ç†ç”±:</label>
        <textarea id="request-reason" placeholder="å¤‰æ›´ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
        
        <button class="btn" onclick="submitChangeRequest()">å¤‰æ›´ä¾é ¼ã‚’é€ä¿¡</button>
        <button class="logout-btn" onclick="hideChangeRequestForm()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <div id="request-message" style="color:green;min-height:1.5em;"></div>
      </div>
      
      <button class="btn" onclick="showChangeRequestForm()" style="margin-top: 10px;background:#6c757d;">æ‰“åˆ»æ™‚åˆ»å¤‰æ›´ä¾é ¼</button>
    </div>

    <!-- ç®¡ç†è€…ç”»é¢ -->
    <div id="admin-area" class="hidden">
      <h2 style="margin-top:0;">ç®¡ç†è€…ç”»é¢</h2>
      
      <!-- å¤‰æ›´ä¾é ¼ä¸€è¦§ -->
      <div id="change-requests">
        <h3>å¤‰æ›´ä¾é ¼ä¸€è¦§</h3>
        <div id="requests-list"></div>
      </div>
      
      <!-- å…¨æ‰“åˆ»å±¥æ­´ -->
      <div id="admin-history"></div>
      <button class="logout-btn" onclick="adminLogout()">ç®¡ç†è€…ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
  </main>

  <script>
    // --- ä¼šç¤¾ãƒ‡ãƒ¼ã‚¿ ---
    const companyData = {
      "è£½é€ éƒ¨": {
        "è£½é€ èª²": [
          "å°å‚ æ•æ–‡", "ç‰‡å±± é›„å¸", "è±Šç”° å´‡è–", "å²¡ å¤§æˆ", "æ²³æœ¬ å“å“‰",
          "å²©ç”° ä¸€å¹³", "è—¤æ°¸ æ­¦å¿—", "é  é¾æˆ", "ç¦æµª æ™ºå¼˜", "è±Šç”° æŸ¾å¸Œ",
          "ãƒã‚ª", "ã‚½ãƒ³", "ãƒãƒ¥ãƒƒã‚¯", "ã‚´ã‚¢ãƒ³", "æ¸…å®¶ ç¿¼",
          "å°å· æ™ƒå¤§", "å‰æ°¸ è¼ä¹Ÿ", "ã‚¿ã‚¤ãƒ³", "æœ«ç•™ ç‘è¦", "ãƒ›ã‚¢ãƒ³",
          "ã‚¯ã‚¢ãƒ³", "ãƒ´â€•", "ãƒ†ã‚£ãƒ³"
        ],
        "æº¶æ¥èª²": [
          "è—¤åŸ ç§€ä¸€", "æ¨‹ä¸Š é›…å½¦", "ä½™ äºŒå¥", "é»’æœ¨ çœŸäºº", "è—¤ç”° æ™‹ä¹Ÿ",
          "ãƒ‡ãƒ­ã‚¹", "æ¾å· å“²ä¹Ÿ", "é«™æ©‹ æ·³", "ãƒ–ã‚ªãƒ³"
        ],
        "æŠ€è¡“æ”¯æ´èª²": ["ä¹…æ´¥é–“ å‰›"],
        "ãƒ­ãƒœãƒƒãƒˆã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³èª²": ["æ¡‘ç”° å¤§è¼”"],
        "ãƒ¬ãƒ¼ã‚¶ãƒ¼ã‚·ã‚¢ãƒªãƒ³ã‚°èª²": [
          "å¥¥æ±Ÿ äº®è¼”", "å¥¥æ±Ÿ èµ·çŸ¢", "å°æ— è¯ä»£", "æ±æ£® å¥å¤ª",
          "å¾Œè—¤ ä¸€ä¹Ÿ", "é–€ç”° ä¿¡å­", "å¤§å‡º ã‚ã‹ã­"
        ],
        "ï¼¨å½¢é‹¼æ©Ÿæ¢°åŠ å·¥èª²": [
          "è©åŸ æ­£å±•", "å°ç”° è£•æƒŸ", "ä¸‰è°· æ•å¤«", "æ— å¸",
          "å°ç”° æ­¦å£«", "åº§è³€ç™½ æ´‹ä¸€", "ç«¹åŸ è–ä¹Ÿ", "é«˜æœ¬ æœ‹å…¸", "é«˜æ©‹ äºœå®Ÿ"
        ]
      },
      "å·¥å‹™éƒ¨": {
        "è¨­è¨ˆèª²": [
          "è²æ¸… ä¿Šä¸€", "è—¤äº• æ•¦ä»", "ç•‘æœ¬ æ³°å®", "æ— çŠçŠ",
          "æ­¦æœ¬ ç¤¼", "ä»Šå· è–ä½³", "å‰å· å½©é¦™", "åºƒæ±Ÿ å°†å’Œ"
        ],
        "é…é€èª²": [
          "ä»Šæ‘ ä»", "ä¹ƒç¾ å´‡ä¸€éƒ", "å‚æœ¬ å¤§å’Œ", "å²¡åŸ ç”±æ´‹", "èŠ è³¢äºŒ"
        ],
        "å·¥äº‹èª²": ["çŸ³äº• å‹‡ä¹Ÿ", "æœªå‰ å°†å¿—"]
      },
      "ç·å‹™éƒ¨": {
        "ç·å‹™èª²": ["æ²³åŸ æ˜éŸ³", "é’æœ¨ å„ªèŠ±", "æ¥¢å´ æ˜å½¦"]
      }
    };

    // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
    let qrReader = null;
    let qrProcessing = false;
    let punchType = "";
    let currentEmpNo = "";
    let currentEmpName = "";
    let historyData = {};
    let changeRequests = [];

    // --- DOMè¦ç´ å–å¾— ---
    const departmentSelect = document.getElementById('department');
    const sectionSelect = document.getElementById('section');
    const employeeSelect = document.getElementById('employee');
    const empnoInput = document.getElementById('empno');
    const loginButton = document.getElementById('loginButton');
    const loginError = document.getElementById('login-error');
    const adminLoginError = document.getElementById('admin-login-error');

    // --- åˆæœŸåŒ–å‡¦ç† ---
    window.onload = function() {
      initializeDepartments();
    };

    // --- ãƒ­ã‚°ã‚¤ãƒ³é–¢é€£å‡¦ç† ---
    function initializeDepartments() {
      departmentSelect.innerHTML = '<option value="">-- éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>';
      Object.keys(companyData).forEach(dep => {
        const option = document.createElement('option');
        option.value = dep;
        option.textContent = dep;
        departmentSelect.appendChild(option);
      });
    }

    departmentSelect.addEventListener('change', function() {
      const selectedDepartment = this.value;
      sectionSelect.innerHTML = '<option value="">-- èª²ã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>';
      employeeSelect.innerHTML = '<option value="">-- åå‰ã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>';
      empnoInput.value = '';
      sectionSelect.disabled = true;
      employeeSelect.disabled = true;
      empnoInput.disabled = true;
      loginButton.disabled = true;
      loginError.innerText = '';

      if (selectedDepartment && companyData[selectedDepartment]) {
        const sections = Object.keys(companyData[selectedDepartment]);
        sections.forEach(sec => {
          const option = document.createElement('option');
          option.value = sec;
          option.textContent = sec;
          sectionSelect.appendChild(option);
        });
        sectionSelect.disabled = false;
      }
    });

    sectionSelect.addEventListener('change', function() {
      const selectedDepartment = departmentSelect.value;
      const selectedSection = this.value;
      employeeSelect.innerHTML = '<option value="">-- åå‰ã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>';
      empnoInput.value = '';
      employeeSelect.disabled = true;
      empnoInput.disabled = true;
      loginButton.disabled = true;
      loginError.innerText = '';

      if (selectedDepartment && selectedSection && companyData[selectedDepartment][selectedSection]) {
        const employees = companyData[selectedDepartment][selectedSection];
        employees.forEach(emp => {
          const option = document.createElement('option');
          option.value = emp;
          option.textContent = emp;
          employeeSelect.appendChild(option);
        });
        employeeSelect.disabled = false;
      }
    });

    employeeSelect.addEventListener('change', function() {
      empnoInput.disabled = !this.value;
      empnoInput.value = '';
      loginButton.disabled = true;
      loginError.innerText = '';
    });

    empnoInput.addEventListener('input', function() {
      loginButton.disabled = !this.value.trim();
    });

    function login() {
      const selectedEmployeeName = employeeSelect.value;
      const empno = empnoInput.value.trim();

      if (!selectedEmployeeName || !empno) {
        loginError.innerText = "åå‰ã¨ç¤¾å“¡ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";
        return;
      }
      
      currentEmpNo = empno;
      currentEmpName = selectedEmployeeName;
      showStampArea();
    }

    function logout() {
      // QRãƒªãƒ¼ãƒ€ãƒ¼ã®åœæ­¢
      if (qrReader && qrReader.getState() === 2) {
        qrReader.stop().catch(err => console.error("QRãƒªãƒ¼ãƒ€ãƒ¼åœæ­¢ã‚¨ãƒ©ãƒ¼:", err));
      }
      qrReader = null;
      qrProcessing = false;
      
      // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã®ãƒªã‚»ãƒƒãƒˆ
      currentEmpNo = "";
      currentEmpName = "";
      
      // ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒªã‚»ãƒƒãƒˆ
      departmentSelect.value = "";
      sectionSelect.innerHTML = '<option value="">-- èª²ã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>';
      employeeSelect.innerHTML = '<option value="">-- åå‰ã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>';
      empnoInput.value = '';
      sectionSelect.disabled = true;
      employeeSelect.disabled = true;
      empnoInput.disabled = true;
      loginButton.disabled = true;
      
      showLoginArea();
    }

    function showLoginArea() {
      document.getElementById("login-area").classList.remove("hidden");
      document.getElementById("stamp-area").classList.add("hidden");
      document.getElementById("admin-area").classList.add("hidden");
      document.getElementById("admin-pass").value = "";
      loginError.innerText = "";
      adminLoginError.innerText = "";
    }

    function showStampArea() {
      currentEmpNo = currentEmpNo;
      currentEmpName = currentEmpName;
      document.getElementById("current-empno").innerText = currentEmpNo;
      document.getElementById("current-empname").innerText = currentEmpName;
      document.getElementById("login-area").classList.add("hidden");
      document.getElementById("stamp-area").classList.remove("hidden");
      document.getElementById("admin-area").classList.add("hidden");
      document.getElementById("result").innerHTML = "";
      document.getElementById("roulette-area").innerHTML = "";
      document.getElementById("qr-reader").classList.add("hidden");
      updateStampButtons();
      renderHistory();
    }

    // ä»Šæ—¥ã®æ—¥ä»˜ã‚’å–å¾—
    function getTodayDate() {
      const now = new Date();
      return now.toISOString().split('T')[0];
    }

    // ä»Šæ—¥ã™ã§ã«æ‰“åˆ»ã—ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    function hasPunchedToday(type) {
      if (!historyData[currentEmpNo]) return false;
      const today = getTodayDate();
      return historyData[currentEmpNo].some(h => 
        h.type === type && h.date.startsWith(today)
      );
    }

    // æ‰“åˆ»ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
    function updateStampButtons() {
      const punchInBtn = document.getElementById("punch-in-btn");
      const punchOutBtn = document.getElementById("punch-out-btn");
      
      const inPunched = hasPunchedToday("å‡ºå‹¤");
      const outPunched = hasPunchedToday("é€€å‹¤");
      
      punchInBtn.disabled = inPunched;
      punchOutBtn.disabled = outPunched;
      
      punchInBtn.textContent = inPunched ? "å‡ºå‹¤æ¸ˆã¿" : "å‡ºå‹¤";
      punchOutBtn.textContent = outPunched ? "é€€å‹¤æ¸ˆã¿" : "é€€å‹¤";
    }

    // --- æ‰“åˆ»é–¢é€£å‡¦ç† ---
    function startQrReader(type) {
      if (hasPunchedToday(type)) {
        alert(`æœ¬æ—¥ã¯ã™ã§ã«${type}æ¸ˆã¿ã§ã™ã€‚`);
        return;
      }
      
      punchType = type;
      document.getElementById("result").innerHTML = "";
      document.getElementById("roulette-area").innerHTML = "";
      document.getElementById("qr-reader").classList.remove("hidden");
      
      if (qrReader) {
        qrReader.clear().catch(err => console.error("QRãƒªãƒ¼ãƒ€ãƒ¼clearã‚¨ãƒ©ãƒ¼:", err));
      }
      
      qrReader = new Html5Qrcode("qr-reader");
      qrProcessing = false;

      const config = { fps: 10, qrbox: { width: 250, height: 250 } };

      qrReader.start(
        { facingMode: "environment" },
        config,
        qrCodeMessage => {
          if (qrProcessing) return;
          qrProcessing = true;
          
          // QRã‚³ãƒ¼ãƒ‰ã®æ¤œè¨¼
          if (!qrCodeMessage || qrCodeMessage.trim() !== "kaory-entrance") {
            document.getElementById("result").innerHTML = `<span style="color:red;">ç„¡åŠ¹ãªQRã‚³ãƒ¼ãƒ‰ã§ã™ã€‚</span>`;
            stopQrReaderAfterError();
            return;
          }
          
          document.getElementById("result").innerHTML = `<span style="color:#0072bc;">ä½ç½®æƒ…å ±ã‚’å–å¾—ã—ã¦ã„ã¾ã™...</span>`;
          
          navigator.geolocation.getCurrentPosition(
            function(position) {
              addHistory(currentEmpNo, punchType, qrCodeMessage, new Date(), position.coords, navigator.userAgent);
              document.getElementById("result").innerHTML = `<span style="color:green;">${punchType}æ‰“åˆ»ã—ã¾ã—ãŸ</span>`;
              stopQrReaderAndShowRoulette();
            },
            function(error) {
              addHistory(currentEmpNo, punchType, qrCodeMessage, new Date(), null, navigator.userAgent);
              document.getElementById("result").innerHTML = `<span style="color:orange;">${punchType}æ‰“åˆ»ã—ã¾ã—ãŸï¼ˆä½ç½®æƒ…å ±ãªã—ï¼‰</span>`;
              stopQrReaderAndShowRoulette();
            },
            {
              enableHighAccuracy: true,
              timeout: 10000,
              maximumAge: 0
            }
          );
        },
        errorMessage => {
          // èª­ã¿å–ã‚Šã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
        }
      ).catch(err => {
        console.error("QRãƒªãƒ¼ãƒ€ãƒ¼é–‹å§‹ã‚¨ãƒ©ãƒ¼:", err);
        document.getElementById("result").innerHTML = `<span style="color:red;">ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚è¨±å¯ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</span>`;
        document.getElementById("qr-reader").classList.add("hidden");
        qrProcessing = false;
      });
    }

    function stopQrReaderAfterError() {
      if (qrReader && qrReader.getState() === 2) {
        qrReader.stop()
          .then(() => {
            document.getElementById("qr-reader").classList.add("hidden");
            qrProcessing = false;
          })
          .catch(err => {
            console.error("QRãƒªãƒ¼ãƒ€ãƒ¼åœæ­¢ã‚¨ãƒ©ãƒ¼:", err);
            document.getElementById("qr-reader").classList.add("hidden");
            qrProcessing = false;
          });
      }
    }

    function stopQrReaderAndShowRoulette() {
      if (qrReader && qrReader.getState() === 2) {
        qrReader.stop()
          .then(() => {
            document.getElementById("qr-reader").classList.add("hidden");
            qrProcessing = false;
            showRoulette();
            updateStampButtons();
          })
          .catch(err => {
            console.error("QRãƒªãƒ¼ãƒ€ãƒ¼åœæ­¢ã‚¨ãƒ©ãƒ¼:", err);
            document.getElementById("qr-reader").classList.add("hidden");
            qrProcessing = false;
            showRoulette();
            updateStampButtons();
          });
      } else {
        document.getElementById("qr-reader").classList.add("hidden");
        qrProcessing = false;
        showRoulette();
        updateStampButtons();
      }
    }

    function showRoulette() {
      const rouletteDiv = document.getElementById("roulette-area");
      rouletteDiv.innerHTML = '<span style="color:#0072bc;">ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆä¸­...</span>';
      setTimeout(() => {
        const isWin = Math.random() < 0.5;
        if (isWin) {
          rouletteDiv.innerHTML = `<div class="roulette-win">
            ğŸ‰å½“ãŸã‚Šï¼ã‚¸ãƒ¥ãƒ¼ã‚¹ä¸€æœ¬ç„¡æ–™ï¼ğŸ‰<br>
            <span style="font-size:1em;">ã‚¹ã‚¯ã‚·ãƒ§ã‚’æ’®ã£ã¦ç·å‹™éƒ¨ã¸æç¤ºã—ã¦ã­ï¼</span>
          </div>`;
        } else {
          rouletteDiv.innerHTML = `<div class="roulette-lose">
            ã¯ãšã‚Œï½ã¾ãŸæŒ‘æˆ¦ã—ã¦ã­ï¼<br>
            æœ¬æ—¥ã‚‚ãŠç–²ã‚Œæ§˜ã§ã™ï¼
          </div>`;
        }
      }, 900);
    }

    // --- å±¥æ­´é–¢é€£å‡¦ç† ---
    function addHistory(empno, type, qr, date, coords, device) {
      if (!historyData[empno]) {
        historyData[empno] = [];
      }
      const entry = {
        id: Date.now() + Math.random(),
        empno: empno,
        empname: currentEmpName,
        type,
        qr,
        date: date.toISOString(),
        lat: coords ? coords.latitude : null,
        lng: coords ? coords.longitude : null,
        device: device || ""
      };
      historyData[empno].unshift(entry);
      
      if (historyData[empno].length > 100) {
        historyData[empno] = historyData[empno].slice(0, 100);
      }
      
      renderHistory();
    }

    function renderHistory() {
      const historyDiv = document.getElementById("history");
      let history = historyData[currentEmpNo] || [];
      
      // 3æ—¥å‰ã®æ—¥ä»˜ã‚’è¨ˆç®—
      const threeDaysAgo = new Date();
      threeDaysAgo.setDate(threeDaysAgo.getDate() - 3);
      threeDaysAgo.setHours(0, 0, 0, 0);
      
      // 3æ—¥ä»¥å†…ã®å±¥æ­´ã®ã¿ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
      const recentHistory = history.filter(h => {
        const historyDate = new Date(h.date);
        return historyDate >= threeDaysAgo;
      });
      
      let html = "<b>æ‰“åˆ»å±¥æ­´ï¼ˆç›´è¿‘3æ—¥é–“ï¼‰</b><br>";
      if (recentHistory.length === 0) {
        html += "<span style='color:#888;'>å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</span>";
      } else {
        recentHistory.forEach((h, i) => {
          const dateObj = new Date(h.date);
          const formattedDate = dateObj.toLocaleString('ja-JP');
          html += `<div class="history-entry">
            [${formattedDate}]<br>
            ç¨®åˆ¥: <b>${escapeHtml(h.type)}</b><br>
            ${h.lat && h.lng ? `ä½ç½®: <a href="https://www.google.com/maps?q=${h.lat},${h.lng}" target="_blank">${h.lat.toFixed(5)},${h.lng.toFixed(5)}</a>` : "ä½ç½®: ãªã—"}
          </div>`;
        });
      }
      historyDiv.innerHTML = html;
    }

    function escapeHtml(str) {
      if (typeof str !== 'string') return "";
      return str.replace(/[&<>"'`]/g, function(match) {
        return ({
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;',
          '`': '&#x60;'
        })[match];
      });
    }

    // --- å¤‰æ›´ä¾é ¼é–¢é€£å‡¦ç† ---
    function showChangeRequestForm() {
      document.getElementById("change-request-form").classList.remove("hidden");
      
      const selectType = document.getElementById("request-type");
      selectType.innerHTML = '<option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>';
      
      const history = historyData[currentEmpNo] || [];
      
      // 3æ—¥å‰ã®æ—¥ä»˜ã‚’è¨ˆç®—
      const threeDaysAgo = new Date();
      threeDaysAgo.setDate(threeDaysAgo.getDate() - 3);
      threeDaysAgo.setHours(0, 0, 0, 0);
      
      // 3æ—¥ä»¥å†…ã®å±¥æ­´ã®ã¿
      const recentHistory = history.filter(h => {
        const historyDate = new Date(h.date);
        return historyDate >= threeDaysAgo;
      });
      
      recentHistory.forEach(h => {
        const dateObj = new Date(h.date);
        const option = document.createElement('option');
        option.value = h.id;
        option.textContent = `${dateObj.toLocaleString('ja-JP')} - ${h.type}`;
        selectType.appendChild(option);
      });
      
      document.getElementById("request-time").value = '';
      document.getElementById("request-reason").value = '';
      document.getElementById("request-message").textContent = '';
    }

    function hideChangeRequestForm() {
      document.getElementById("change-request-form").classList.add("hidden");
    }

    function submitChangeRequest() {
      const requestType = document.getElementById("request-type").value;
      const requestTime = document.getElementById("request-time").value;
      const requestReason = document.getElementById("request-reason").value.trim();
      
      if (!requestType || !requestTime || !requestReason) {
        alert("ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
      }
      
      const history = historyData[currentEmpNo] || [];
      const targetHistory = history.find(h => h.id == requestType);
      
      if (!targetHistory) {
        alert("å¯¾è±¡ã®æ‰“åˆ»ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
        return;
      }
      
      const request = {
        id: Date.now() + Math.random(),
        empno: currentEmpNo,
        empname: currentEmpName,
        originalHistory: targetHistory,
        newTime: requestTime,
        reason: requestReason,
        status: "pending",
        requestDate: new Date().toISOString()
      };
      
      changeRequests.push(request);
      
      document.getElementById("request-message").textContent = "å¤‰æ›´ä¾é ¼ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚ç®¡ç†è€…ã®æ‰¿èªã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚";
      
      setTimeout(() => {
        hideChangeRequestForm();
      }, 2000);
    }

    // --- ç®¡ç†è€…é–¢é€£å‡¦ç† ---
    function adminLogin() {
      const pass = document.getElementById('admin-pass').value;
      if (pass === "1") {
        showAdminArea();
      } else {
        adminLoginError.innerText = "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™";
      }
    }

    function showAdminArea() {
      document.getElementById("login-area").classList.add("hidden");
      document.getElementById("stamp-area").classList.add("hidden");
      document.getElementById("admin-area").classList.remove("hidden");
      renderAdminHistory();
      renderChangeRequests();
      
      if (qrReader && qrReader.getState() === 2) {
        qrReader.stop().catch(err => console.error("QRãƒªãƒ¼ãƒ€ãƒ¼åœæ­¢ã‚¨ãƒ©ãƒ¼(Admin):", err));
      }
      qrReader = null;
      qrProcessing = false;
    }

    function adminLogout() {
      showLoginArea();
    }

    function renderChangeRequests() {
      const requestsList = document.getElementById("requests-list");
      const pendingRequests = changeRequests.filter(r => r.status === "pending");
      
      if (pendingRequests.length === 0) {
        requestsList.innerHTML = "<span style='color:#888;'>å¤‰æ›´ä¾é ¼ã¯ã‚ã‚Šã¾ã›ã‚“</span>";
        return;
      }
      
      let html = "";
      pendingRequests.forEach(request => {
        const originalDate = new Date(request.originalHistory.date);
        const newDate = new Date(request.newTime);
        
        html += `<div class="request-item request-pending">
          <b>${request.empname} (${request.empno})</b><br>
          å¤‰æ›´å¯¾è±¡: ${request.originalHistory.type}<br>
          ç¾åœ¨ã®æ™‚åˆ»: ${originalDate.toLocaleString('ja-JP')}<br>
          å¤‰æ›´å¾Œã®æ™‚åˆ»: ${newDate.toLocaleString('ja-JP')}<br>
          ç†ç”±: ${escapeHtml(request.reason)}<br>
          ç”³è«‹æ—¥æ™‚: ${new Date(request.requestDate).toLocaleString('ja-JP')}<br>
          <button class="approve-btn" onclick="approveRequest('${request.id}')">æ‰¿èª</button>
          <button class="reject-btn" onclick="rejectRequest('${request.id}')">å´ä¸‹</button>
        </div>`;
      });
      
      requestsList.innerHTML = html;
    }

    function approveRequest(requestId) {
      const request = changeRequests.find(r => r.id == requestId);
      if (!request) return;
      
      const history = historyData[request.empno];
      if (history) {
        const targetIndex = history.findIndex(h => h.id === request.originalHistory.id);
        if (targetIndex !== -1) {
          history[targetIndex].date = new Date(request.newTime).toISOString();
          history[targetIndex].edited = true;
          history[targetIndex].editReason = request.reason;
        }
      }
      
      request.status = "approved";
      
      alert("å¤‰æ›´ä¾é ¼ã‚’æ‰¿èªã—ã¾ã—ãŸã€‚");
      renderChangeRequests();
      renderAdminHistory();
    }

    function rejectRequest(requestId) {
      const request = changeRequests.find(r => r.id == requestId);
      if (!request) return;
      
      request.status = "rejected";
      
      alert("å¤‰æ›´ä¾é ¼ã‚’å´ä¸‹ã—ã¾ã—ãŸã€‚");
      renderChangeRequests();
    }

    function renderAdminHistory() {
      let html = "<h3>å…¨ç¤¾å“¡ã®æ‰“åˆ»å±¥æ­´ï¼ˆå…¨æœŸé–“ï¼‰</h3>";
      let allHistoryEntries = [];

      Object.keys(historyData).forEach(empno => {
        historyData[empno].forEach(entry => {
          allHistoryEntries.push(entry);
        });
      });

      allHistoryEntries.sort((a, b) => new Date(b.date) - new Date(a.date));

      if (allHistoryEntries.length === 0) {
        html += "<span style='color:#888;'>ã¾ã å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</span>";
      } else {
        html += `<table class="admin-history-table">
          <thead>
            <tr>
              <th>ç¤¾å“¡ç•ªå·</th>
              <th>åå‰</th>
              <th>æ—¥æ™‚</th>
              <th>ç¨®åˆ¥</th>
              <th>ä½ç½®</th>
            </tr>
          </thead>
          <tbody>
        `;
        allHistoryEntries.forEach(h => {
          const dateObj = new Date(h.date);
          const formattedDate = dateObj.toLocaleString('ja-JP');
          html += `<tr>
            <td>${escapeHtml(h.empno)}</td>
            <td>${escapeHtml(h.empname)}</td>
            <td>${escapeHtml(formattedDate)}${h.edited ? ' [ç·¨é›†æ¸ˆ]' : ''}</td>
            <td>${escapeHtml(h.type)}</td>
            <td>${h.lat && h.lng ? `<a href="https://www.google.com/maps?q=${h.lat},${h.lng}" target="_blank">åœ°å›³</a>` : "ãªã—"}</td>
          </tr>`;
        });
        html += "</tbody></table>";
      }
      document.getElementById("admin-history").innerHTML = html;
    }
  </script>
</body>
</html>
