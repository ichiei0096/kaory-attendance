<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KAORY - æ ªå¼ä¼šç¤¾ æˆä¼¸å·¥æ¥­ å‡ºé€€å‹¤ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Hiragino Sans', 'Yu Gothic UI', 'Meiryo UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      padding: 40px;
      width: 100%;
      max-width: 500px;
      text-align: center;
    }

    .logo {
      color: #0072bc;
      font-size: 2.5em;
      font-weight: bold;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    }

    .company-name {
      color: #666;
      font-size: 1.1em;
      margin-bottom: 30px;
      font-weight: 500;
    }

    .form-group {
      margin-bottom: 20px;
      text-align: left;
    }

    label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 500;
    }

    select, input, textarea {
      width: 100%;
      padding: 15px;
      border: 2px solid #e1e5e9;
      border-radius: 10px;
      font-size: 16px;
      transition: border-color 0.3s;
      font-family: inherit;
    }

    textarea {
      resize: vertical;
      min-height: 100px;
    }

    select:focus, input:focus, textarea:focus {
      outline: none;
      border-color: #0072bc;
    }

    .login-btn, .stamp-btn, .admin-btn, .request-btn {
      width: 100%;
      padding: 15px;
      background: linear-gradient(45deg, #0072bc, #00a0d2);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      margin-top: 10px;
    }

    .login-btn:hover, .stamp-btn:hover, .admin-btn:hover, .request-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(0,114,188,0.3);
    }

    .stamp-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin: 30px 0;
    }

    .in-btn {
      background: linear-gradient(45deg, #4CAF50, #45a049);
    }

    .out-btn {
      background: linear-gradient(45deg, #f44336, #da190b);
    }

    .in-btn:hover {
      box-shadow: 0 10px 20px rgba(76,175,80,0.3);
    }

    .out-btn:hover {
      box-shadow: 0 10px 20px rgba(244,67,54,0.3);
    }

    .hidden {
      display: none !important;
    }

    #user-greeting {
      color: #333;
      margin-bottom: 20px;
      font-size: 1.3em;
    }

    #qr-reader {
      margin: 20px 0;
      border: 2px dashed #0072bc;
      border-radius: 10px;
      padding: 20px;
    }

    #roulette-area {
      margin: 20px 0;
      padding: 20px;
      border-radius: 10px;
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1em;
      font-weight: bold;
    }

    .roulette-win {
      background: linear-gradient(45deg, #FFD700, #FFA500);
      color: #333;
      padding: 20px;
      border-radius: 15px;
      animation: bounce 0.6s ease-in-out;
    }

    .roulette-lose {
      background: linear-gradient(45deg, #87CEEB, #4682B4);
      color: white;
      padding: 15px;
      border-radius: 10px;
    }

    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-10px); }
      60% { transform: translateY(-5px); }
    }

    .logout-btn {
      background: #6c757d;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 20px;
    }

    .logout-btn:hover {
      background: #5a6268;
    }

    .error {
      color: #dc3545;
      font-size: 0.9em;
      margin-top: 5px;
    }

    .success {
      color: #28a745;
      font-size: 0.9em;
      margin-top: 5px;
    }

    #history {
      margin-top: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 10px;
      text-align: left;
      max-height: 400px;
      overflow-y: auto;
    }

    .history-entry {
      background: white;
      padding: 15px;
      margin: 10px 0;
      border-radius: 8px;
      border-left: 4px solid #0072bc;
      font-size: 0.9em;
    }

    .edit-btn, .delete-btn, .approve-btn, .reject-btn {
      padding: 5px 10px;
      margin: 5px 5px 0 0;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8em;
    }

    .edit-btn, .approve-btn {
      background: #28a745;
      color: white;
    }

    .delete-btn, .reject-btn {
      background: #dc3545;
      color: white;
    }

    .stamp-btn:disabled {
      background: #6c757d !important;
      cursor: not-allowed;
      transform: none !important;
    }

    .request-form {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      margin-top: 20px;
    }

    .request-item {
      background: white;
      padding: 15px;
      margin: 10px 0;
      border-radius: 8px;
      border: 1px solid #e1e5e9;
    }

    .request-pending {
      border-left: 4px solid #ffc107;
    }

    .request-approved {
      border-left: 4px solid #28a745;
    }

    .request-rejected {
      border-left: 4px solid #dc3545;
    }

    @media (max-width: 600px) {
      .container {
        padding: 20px;
        margin: 10px;
      }
      
      .logo {
        font-size: 2em;
      }
      
      .stamp-buttons {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒªã‚¢ -->
    <div id="login-area">
      <div class="logo">KAORY</div>
      <div class="company-name">æ ªå¼ä¼šç¤¾ æˆä¼¸å·¥æ¥­ å‡ºé€€å‹¤ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </div>
      
      <div class="form-group">
        <label for="department">éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„</label>
        <select id="department" onchange="updateSections()">
          <option value="">-- éƒ¨ç½²ã‚’é¸æŠ --</option>
        </select>
      </div>

      <div class="form-group">
        <label for="section">èª²ã‚’é¸æŠã—ã¦ãã ã•ã„</label>
        <select id="section" onchange="updateEmployees()" disabled>
          <option value="">-- èª²ã‚’é¸æŠ --</option>
        </select>
      </div>

      <div class="form-group">
        <label for="employee">ãŠåå‰ã‚’é¸æŠã—ã¦ãã ã•ã„</label>
        <select id="employee" onchange="enableEmpNo()" disabled>
          <option value="">-- åå‰ã‚’é¸æŠ --</option>
        </select>
      </div>

      <div class="form-group">
        <label for="empno">ç¤¾å“¡ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</label>
        <input type="text" id="empno" placeholder="ç¤¾å“¡ç•ªå·" disabled>
      </div>

      <button class="login-btn" onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <div id="login-error" class="error"></div>

      <button class="admin-btn" onclick="showAdminLogin()" style="margin-top: 20px; background: #6c757d;">ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</button>
    </div>

    <!-- ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒªã‚¢ -->
    <div id="admin-login-area" class="hidden">
      <h2>ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</h2>
      <div class="form-group">
        <label for="admin-pass">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
        <input type="password" id="admin-pass" placeholder="ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
      </div>
      <button class="login-btn" onclick="adminLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <div id="admin-login-error" class="error"></div>
      <button onclick="showLoginArea()" class="logout-btn">æˆ»ã‚‹</button>
    </div>

    <!-- æ‰“åˆ»ã‚¨ãƒªã‚¢ -->
    <div id="stamp-area" class="hidden">
      <h2 id="user-greeting">ã“ã‚“ã«ã¡ã¯ï¼</h2>
      <div class="stamp-buttons">
        <button id="punch-in" class="stamp-btn in-btn" onclick="punchIn()">å‡ºå‹¤</button>
        <button id="punch-out" class="stamp-btn out-btn" onclick="punchOut()">é€€å‹¤</button>
      </div>
      <div id="qr-reader" class="hidden"></div>
      <div id="roulette-area"></div>
      <div id="stamp-message" class="success"></div>
      <div id="history"></div>
      
      <!-- å¤‰æ›´ä¾é ¼ãƒ•ã‚©ãƒ¼ãƒ  -->
      <div class="request-form hidden" id="change-request-form">
        <h3>æ‰“åˆ»æ™‚åˆ»å¤‰æ›´ä¾é ¼</h3>
        <div class="form-group">
          <label for="request-type">å¤‰æ›´ã™ã‚‹æ‰“åˆ»</label>
          <select id="request-type">
            <option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>
          </select>
        </div>
        <div class="form-group">
          <label for="request-time">å¤‰æ›´å¾Œã®æ™‚åˆ»</label>
          <input type="datetime-local" id="request-time">
        </div>
        <div class="form-group">
          <label for="request-reason">å¤‰æ›´ç†ç”±</label>
          <textarea id="request-reason" placeholder="å¤‰æ›´ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
        </div>
        <button class="request-btn" onclick="submitChangeRequest()">å¤‰æ›´ä¾é ¼ã‚’é€ä¿¡</button>
        <button class="logout-btn" onclick="hideChangeRequestForm()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <div id="request-message" class="success"></div>
      </div>
      
      <button onclick="showChangeRequestForm()" class="admin-btn" style="margin-top: 10px;">æ‰“åˆ»æ™‚åˆ»å¤‰æ›´ä¾é ¼</button>
      <button onclick="logout()" class="logout-btn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>

    <!-- ç®¡ç†è€…ã‚¨ãƒªã‚¢ -->
    <div id="admin-area" class="hidden">
      <h2>ç®¡ç†è€…ç”»é¢</h2>
      
      <!-- å¤‰æ›´ä¾é ¼ä¸€è¦§ -->
      <div id="change-requests">
        <h3>å¤‰æ›´ä¾é ¼ä¸€è¦§</h3>
        <div id="requests-list"></div>
      </div>
      
      <!-- å…¨æ‰“åˆ»å±¥æ­´ -->
      <div id="admin-history" style="margin-top: 30px;"></div>
      
      <button onclick="adminLogout()" class="logout-btn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
  </div>

  <script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let html5QrCode = null;
    let qrProcessing = false;
    let currentEmpNo = "";
    let currentEmpName = "";
    let isAdminLoggedIn = false;
    let historyData = {}; // æ‰“åˆ»å±¥æ­´
    let changeRequests = []; // å¤‰æ›´ä¾é ¼
    let currentPunchType = ""; // ç¾åœ¨ã®æ‰“åˆ»ã‚¿ã‚¤ãƒ—

    // çµ„ç¹”ãƒ‡ãƒ¼ã‚¿ï¼ˆæ ªå¼ä¼šç¤¾ æˆä¼¸å·¥æ¥­ï¼‰
    const organizationData = {
      "è£½é€ éƒ¨": {
        "è£½é€ èª²": [
          "å°å‚ æ•æ–‡", "ç‰‡å±± é›„å¸", "è±Šç”° å´‡è–", "å²¡ å¤§æˆ", "æ²³æœ¬ å“å“‰",
          "å²©ç”° ä¸€å¹³", "è—¤æ°¸ æ­¦å¿—", "é  é¾æˆ", "ç¦æµª æ™ºå¼˜", "è±Šç”° æŸ¾å¸Œ",
          "ãƒã‚ª", "ã‚½ãƒ³", "ãƒãƒ¥ãƒƒã‚¯", "ã‚´ã‚¢ãƒ³", "æ¸…å®¶ ç¿¼",
          "å°å· æ™ƒå¤§", "å‰æ°¸ è¼ä¹Ÿ", "ã‚¿ã‚¤ãƒ³", "æœ«ç•™ ç‘è¦", "ãƒ›ã‚¢ãƒ³",
          "ã‚¯ã‚¢ãƒ³", "ãƒ´â€•", "ãƒ†ã‚£ãƒ³"
        ],
        "æº¶æ¥èª²": [
          "è—¤åŸ ç§€ä¸€", "æ¨‹ä¸Š é›…å½¦", "ä½™ äºŒå¥", "é»’æœ¨ çœŸäºº", "è—¤ç”° æ™‹ä¹Ÿ",
          "ãƒ‡ãƒ­ã‚¹", "æ¾å· å“²ä¹Ÿ", "é«™æ©‹ æ·³", "ãƒ–ã‚ªãƒ³"
        ],
        "æŠ€è¡“æ”¯æ´èª²": ["ä¹…æ´¥é–“ å‰›"],
        "ãƒ­ãƒœãƒƒãƒˆã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³èª²": ["æ¡‘ç”° å¤§è¼”"],
        "ãƒ¬ãƒ¼ã‚¶ãƒ¼ã‚·ã‚¢ãƒªãƒ³ã‚°èª²": [
          "å¥¥æ±Ÿ äº®è¼”", "å¥¥æ±Ÿ èµ·çŸ¢", "å°æ— è¯ä»£", "æ±æ£® å¥å¤ª",
          "å¾Œè—¤ ä¸€ä¹Ÿ", "é–€ç”° ä¿¡å­", "å¤§å‡º ã‚ã‹ã­"
        ],
        "ï¼¨å½¢é‹¼æ©Ÿæ¢°åŠ å·¥èª²": [
          "è©åŸ æ­£å±•", "å°ç”° è£•æƒŸ", "ä¸‰è°· æ•å¤«", "æ— å¸",
          "å°ç”° æ­¦å£«", "åº§è³€ç™½ æ´‹ä¸€", "ç«¹åŸ è–ä¹Ÿ", "é«˜æœ¬ æœ‹å…¸", "é«˜æ©‹ äºœå®Ÿ"
        ]
      },
      "å·¥å‹™éƒ¨": {
        "è¨­è¨ˆèª²": [
          "è²æ¸… ä¿Šä¸€", "è—¤äº• æ•¦ä»", "ç•‘æœ¬ æ³°å®", "æ— çŠçŠ",
          "æ­¦æœ¬ ç¤¼", "ä»Šå· è–ä½³", "å‰å· å½©é¦™", "åºƒæ±Ÿ å°†å’Œ"
        ],
        "é…é€èª²": [
          "ä»Šæ‘ ä»", "ä¹ƒç¾ å´‡ä¸€éƒ", "å‚æœ¬ å¤§å’Œ", "å²¡åŸ ç”±æ´‹", "èŠ è³¢äºŒ"
        ],
        "å·¥äº‹èª²": ["çŸ³äº• å‹‡ä¹Ÿ", "æœªå‰ å°†å¿—"]
      },
      "ç·å‹™éƒ¨": {
        "ç·å‹™èª²": ["æ²³åŸ æ˜éŸ³", "é’æœ¨ å„ªèŠ±", "æ¥¢å´ æ˜å½¦"]
      }
    };

    // åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', function() {
      initializeDepartments();
    });

    function initializeDepartments() {
      const departmentSelect = document.getElementById('department');
      departmentSelect.innerHTML = '<option value="">-- éƒ¨ç½²ã‚’é¸æŠ --</option>';
      
      Object.keys(organizationData).forEach(dept => {
        const option = document.createElement('option');
        option.value = dept;
        option.textContent = dept;
        departmentSelect.appendChild(option);
      });
    }

    function updateSections() {
      const department = document.getElementById('department').value;
      const sectionSelect = document.getElementById('section');
      const employeeSelect = document.getElementById('employee');
      const empnoInput = document.getElementById('empno');
      
      sectionSelect.innerHTML = '<option value="">-- èª²ã‚’é¸æŠ --</option>';
      employeeSelect.innerHTML = '<option value="">-- åå‰ã‚’é¸æŠ --</option>';
      empnoInput.value = '';
      
      if (department && organizationData[department]) {
        sectionSelect.disabled = false;
        employeeSelect.disabled = true;
        empnoInput.disabled = true;
        
        Object.keys(organizationData[department]).forEach(section => {
          const option = document.createElement('option');
          option.value = section;
          option.textContent = section;
          sectionSelect.appendChild(option);
        });
      } else {
        sectionSelect.disabled = true;
        employeeSelect.disabled = true;
        empnoInput.disabled = true;
      }
    }

    function updateEmployees() {
      const department = document.getElementById('department').value;
      const section = document.getElementById('section').value;
      const employeeSelect = document.getElementById('employee');
      const empnoInput = document.getElementById('empno');
      
      employeeSelect.innerHTML = '<option value="">-- åå‰ã‚’é¸æŠ --</option>';
      empnoInput.value = '';
      empnoInput.disabled = true;
      
      if (department && section && organizationData[department] && organizationData[department][section]) {
        employeeSelect.disabled = false;
        
        organizationData[department][section].forEach(name => {
          const option = document.createElement('option');
          option.value = name;
          option.textContent = name;
          employeeSelect.appendChild(option);
        });
      } else {
        employeeSelect.disabled = true;
      }
    }

    function enableEmpNo() {
      const employee = document.getElementById('employee').value;
      const empnoInput = document.getElementById('empno');
      
      if (employee) {
        empnoInput.disabled = false;
      } else {
        empnoInput.disabled = true;
        empnoInput.value = '';
      }
    }

    function login() {
      const empno = document.getElementById('empno').value.trim();
      const empName = document.getElementById('employee').value;
      const loginError = document.getElementById('login-error');
      
      if (!empName || !empno) {
        loginError.textContent = 'éƒ¨ç½²ã€èª²ã€åå‰ã‚’é¸æŠã—ã€ç¤¾å“¡ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
        return;
      }
      
      currentEmpNo = empno;
      currentEmpName = empName;
      showStampArea();
    }

    function logout() {
      currentEmpNo = "";
      currentEmpName = "";
      cleanupQrReader();
      showLoginArea();
      initializeDepartments();
    }

    function showLoginArea() {
      document.getElementById("login-area").classList.remove("hidden");
      document.getElementById("admin-login-area").classList.add("hidden");
      document.getElementById("stamp-area").classList.add("hidden");
      document.getElementById("admin-area").classList.add("hidden");
      document.getElementById('login-error').textContent = '';
    }

    function showAdminLogin() {
      document.getElementById("login-area").classList.add("hidden");
      document.getElementById("admin-login-area").classList.remove("hidden");
      document.getElementById('admin-login-error').textContent = '';
      document.getElementById('admin-pass').value = '';
    }

    function showStampArea() {
      document.getElementById("login-area").classList.add("hidden");
      document.getElementById("admin-login-area").classList.add("hidden");
      document.getElementById("stamp-area").classList.remove("hidden");
      document.getElementById("admin-area").classList.add("hidden");
      document.getElementById("user-greeting").textContent = `${currentEmpName}ã•ã‚“ã€ãŠç–²ã‚Œæ§˜ã§ã™ï¼`;
      updateStampButtons();
      renderHistory();
      cleanupQrReader();
      clearRoulette();
    }

    // ä»Šæ—¥ã®æ—¥ä»˜ã‚’å–å¾—ï¼ˆYYYY-MM-DDå½¢å¼ï¼‰
    function getTodayDate() {
      const now = new Date();
      return now.toISOString().split('T')[0];
    }

    // ä»Šæ—¥ã™ã§ã«æ‰“åˆ»ã—ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    function hasPunchedToday(type) {
      if (!historyData[currentEmpNo]) return false;
      const today = getTodayDate();
      return historyData[currentEmpNo].some(h => 
        h.type === type && h.date.startsWith(today)
      );
    }

    // æ‰“åˆ»ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
    function updateStampButtons() {
      const punchInBtn = document.getElementById("punch-in");
      const punchOutBtn = document.getElementById("punch-out");
      
      punchInBtn.disabled = hasPunchedToday("å‡ºå‹¤");
      punchOutBtn.disabled = hasPunchedToday("é€€å‹¤");
      
      if (punchInBtn.disabled) {
        punchInBtn.textContent = "å‡ºå‹¤æ¸ˆã¿";
      }
      if (punchOutBtn.disabled) {
        punchOutBtn.textContent = "é€€å‹¤æ¸ˆã¿";
      }
    }

    // å‡ºå‹¤å‡¦ç†
    function punchIn() {
      if (hasPunchedToday("å‡ºå‹¤")) {
        alert("æœ¬æ—¥ã¯ã™ã§ã«å‡ºå‹¤æ¸ˆã¿ã§ã™ã€‚");
        return;
      }
      currentPunchType = "å‡ºå‹¤";
      startQrScan();
    }

    // é€€å‹¤å‡¦ç†
    function punchOut() {
      if (hasPunchedToday("é€€å‹¤")) {
        alert("æœ¬æ—¥ã¯ã™ã§ã«é€€å‹¤æ¸ˆã¿ã§ã™ã€‚");
        return;
      }
      currentPunchType = "é€€å‹¤";
      startQrScan();
    }

    // --- QRã‚³ãƒ¼ãƒ‰é–¢é€£å‡¦ç† ---
    function startQrScan() {
      // QRã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Šã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ç›´æ¥æ‰“åˆ»å‡¦ç†ã‚’å®Ÿè¡Œ
      // ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¨ãƒ©ãƒ¼ã‚’å›é¿ã™ã‚‹ãŸã‚ï¼‰
      processQrResult('DEMO-QR-CODE', currentPunchType);
    }

    function processQrResult(qrData, type) {
      console.log(`QRå‡¦ç†é–‹å§‹: ${qrData}, ã‚¿ã‚¤ãƒ—: ${type}`);
      
      const now = new Date();
      
      // ä½ç½®æƒ…å ±å–å¾—ã‚’è©¦è¡Œ
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const coords = position.coords;
            console.log(`ä½ç½®æƒ…å ±å–å¾—æˆåŠŸ: ${coords.latitude}, ${coords.longitude}`);
            addHistory(currentEmpNo, type, qrData, now, coords, getDeviceInfo());
          },
          (error) => {
            console.log("ä½ç½®æƒ…å ±å–å¾—å¤±æ•—:", error.message);
            addHistory(currentEmpNo, type, qrData, now, null, getDeviceInfo());
          },
          { timeout: 5000, enableHighAccuracy: false }
        );
      } else {
        console.log("ä½ç½®æƒ…å ±æ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“");
        addHistory(currentEmpNo, type, qrData, now, null, getDeviceInfo());
      }
    }

    function getDeviceInfo() {
      return `${navigator.userAgent} | Screen: ${screen.width}x${screen.height} | Time: ${new Date().toISOString()}`;
    }

    function cleanupQrReader() {
      // QRãƒªãƒ¼ãƒ€ãƒ¼ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã¯ä¸è¦ï¼ˆä½¿ç”¨ã—ã¦ã„ãªã„ãŸã‚ï¼‰
    }

    function clearRoulette() {
      document.getElementById("roulette-area").innerHTML = "";
    }

    function showRoulette() {
      const rouletteDiv = document.getElementById("roulette-area");
      rouletteDiv.innerHTML = '<span style="color:#0072bc;">ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆä¸­...</span>';
      
      setTimeout(() => {
        const isWin = Math.random() < 0.3; // 30%ã®ç¢ºç‡ã§å½“é¸
        if (isWin) {
          rouletteDiv.innerHTML = `<div class="roulette-win">
            ğŸ‰å½“ãŸã‚Šï¼ã‚¸ãƒ¥ãƒ¼ã‚¹ä¸€æœ¬ç„¡æ–™ï¼ğŸ‰<br>
            <span style="font-size:1em;">ã‚¹ã‚¯ã‚·ãƒ§ã‚’æ’®ã£ã¦ç·å‹™éƒ¨ã¸æç¤ºã—ã¦ã­ï¼</span>
          </div>`;
        } else {
          rouletteDiv.innerHTML = `<div class="roulette-lose">
            ã¯ãšã‚Œï½ã¾ãŸæŒ‘æˆ¦ã—ã¦ã­ï¼<br>
            <span style="font-size:0.9em;">æ¬¡å›ã‚‚ãŠç–²ã‚Œæ§˜ã§ã™ï¼</span>
          </div>`;
        }
      }, 1200);
    }

    // --- å±¥æ­´é–¢é€£å‡¦ç† ---
    function addHistory(empno, type, qr, date, coords, device) {
      if (!historyData[empno]) {
        historyData[empno] = [];
      }
      
      const entry = {
        id: Date.now() + Math.random(), // ãƒ¦ãƒ‹ãƒ¼ã‚¯ID
        empno: empno,
        empname: currentEmpName,
        type,
        qr,
        date: date.toISOString(),
        lat: coords ? coords.latitude : null,
        lng: coords ? coords.longitude : null,
        device: device || ""
      };
      
      historyData[empno].unshift(entry);
      
      // å±¥æ­´ã‚’æœ€æ–°100ä»¶ã«åˆ¶é™
      if (historyData[empno].length > 100) {
        historyData[empno] = historyData[empno].slice(0, 100);
      }
      
      // æ‰“åˆ»æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      const messageDiv = document.getElementById("stamp-message");
      messageDiv.textContent = `${type}æ‰“åˆ»ãŒå®Œäº†ã—ã¾ã—ãŸï¼`;
      setTimeout(() => {
        messageDiv.textContent = "";
      }, 3000);
      
      updateStampButtons();
      renderHistory();
      showRoulette(); // æ‰“åˆ»å¾Œã«ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆé–‹å§‹
      console.log("å±¥æ­´è¿½åŠ å®Œäº†:", entry);
    }

    function renderHistory() {
      let history = historyData[currentEmpNo] || [];
      let html = "<b>æ‰“åˆ»å±¥æ­´ï¼ˆç›´è¿‘3æ—¥é–“ï¼‰</b><br>";
      
      // 3æ—¥å‰ã®æ—¥ä»˜ã‚’è¨ˆç®—
      const threeDaysAgo = new Date();
      threeDaysAgo.setDate(threeDaysAgo.getDate() - 3);
      threeDaysAgo.setHours(0, 0, 0, 0);
      
      // 3æ—¥ä»¥å†…ã®å±¥æ­´ã®ã¿ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
      const recentHistory = history.filter(h => {
        const historyDate = new Date(h.date);
        return historyDate >= threeDaysAgo;
      });
      
      if (recentHistory.length === 0) {
        html += "<span style='color:#888;'>ç›´è¿‘3æ—¥é–“ã®å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</span>";
      } else {
        recentHistory.forEach((h, i) => {
          const dateObj = new Date(h.date);
          const formattedDate = dateObj.toLocaleString('ja-JP');
          const isToday = dateObj.toISOString().split('T')[0] === getTodayDate();
          
          html += `<div class="history-entry">
            [${formattedDate}] ${isToday ? '<span style="color:#28a745;">ï¼ˆæœ¬æ—¥ï¼‰</span>' : ''}<br>
            ç¨®åˆ¥: <b>${escapeHtml(h.type)}</b><br>
            ${h.lat && h.lng ? `ä½ç½®: <a href="https://www.google.com/maps?q=${h.lat},${h.lng}" target="_blank">${h.lat.toFixed(5)},${h.lng.toFixed(5)}</a><br>` : ""}
            ç«¯æœ«æƒ…å ±: <span style="font-size:0.8em;" title="${escapeHtml(h.device)}">${abbreviateDevice(h.device, 30)}</span>
          </div>`;
        });
      }
      document.getElementById("history").innerHTML = html;
    }

    function abbreviateDevice(str, maxLength) {
        if (!str) return "ãªã—";
        str = String(str);
        if (str.length <= maxLength) return escapeHtml(str);
        return escapeHtml(str.substr(0, maxLength - 1)) + "â€¦";
    }

    function escapeHtml(str) {
      if (typeof str !== 'string') return "";
      return str.replace(/[&<>"'`]/g, function(match) {
        return ({
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;',
          '`': '&#x60;'
        })[match];
      });
    }

    // --- å¤‰æ›´ä¾é ¼é–¢é€£å‡¦ç† ---
    function showChangeRequestForm() {
      const form = document.getElementById("change-request-form");
      form.classList.remove("hidden");
      
      // å¤‰æ›´å¯èƒ½ãªæ‰“åˆ»ã‚’ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã«è¿½åŠ ï¼ˆ3æ—¥ä»¥å†…ã®ã¿ï¼‰
      const selectType = document.getElementById("request-type");
      selectType.innerHTML = '<option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>';
      
      const history = historyData[currentEmpNo] || [];
      
      // 3æ—¥å‰ã®æ—¥ä»˜ã‚’è¨ˆç®—
      const threeDaysAgo = new Date();
      threeDaysAgo.setDate(threeDaysAgo.getDate() - 3);
      threeDaysAgo.setHours(0, 0, 0, 0);
      
      // 3æ—¥ä»¥å†…ã®å±¥æ­´ã®ã¿
      const recentHistory = history.filter(h => {
        const historyDate = new Date(h.date);
        return historyDate >= threeDaysAgo;
      });
      
      recentHistory.forEach(h => {
        const dateObj = new Date(h.date);
        const option = document.createElement('option');
        option.value = h.id;
        option.textContent = `${dateObj.toLocaleString('ja-JP')} - ${h.type}`;
        selectType.appendChild(option);
      });
      
      // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
      document.getElementById("request-time").value = '';
      document.getElementById("request-reason").value = '';
      document.getElementById("request-message").textContent = '';
    }

    function hideChangeRequestForm() {
      document.getElementById("change-request-form").classList.add("hidden");
    }

    function submitChangeRequest() {
      const requestType = document.getElementById("request-type").value;
      const requestTime = document.getElementById("request-time").value;
      const requestReason = document.getElementById("request-reason").value;
      
      if (!requestType || !requestTime || !requestReason) {
        alert("ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
      }
      
      // å¤‰æ›´å¯¾è±¡ã®å±¥æ­´ã‚’å–å¾—
      const history = historyData[currentEmpNo] || [];
      const targetHistory = history.find(h => h.id == requestType);
      
      if (!targetHistory) {
        alert("å¯¾è±¡ã®æ‰“åˆ»ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
        return;
      }
      
      // å¤‰æ›´ä¾é ¼ã‚’ä½œæˆ
      const request = {
        id: Date.now() + Math.random(),
        empno: currentEmpNo,
        empname: currentEmpName,
        originalHistory: targetHistory,
        newTime: requestTime,
        reason: requestReason,
        status: "pending", // pending, approved, rejected
        requestDate: new Date().toISOString()
      };
      
      changeRequests.push(request);
      
      // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      const messageDiv = document.getElementById("request-message");
      messageDiv.textContent = "å¤‰æ›´ä¾é ¼ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚ç®¡ç†è€…ã®æ‰¿èªã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚";
      
      // ãƒ•ã‚©ãƒ¼ãƒ ã‚’éè¡¨ç¤º
      setTimeout(() => {
        hideChangeRequestForm();
      }, 2000);
    }

    // --- ç®¡ç†è€…é–¢é€£å‡¦ç† ---
    function adminLogin() {
      const pass = document.getElementById('admin-pass').value;
      const adminLoginError = document.getElementById('admin-login-error');
      if (pass === "1") {
        isAdminLoggedIn = true;
        showAdminArea();
      } else {
        adminLoginError.textContent = "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™";
      }
    }

    function showAdminArea() {
      document.getElementById("login-area").classList.add("hidden");
      document.getElementById("admin-login-area").classList.add("hidden");
      document.getElementById("stamp-area").classList.add("hidden");
      document.getElementById("admin-area").classList.remove("hidden");
      cleanupQrReader();
      renderChangeRequests();
      renderAdminHistory();
    }

    function adminLogout() {
      isAdminLoggedIn = false;
      showLoginArea();
      initializeDepartments();
    }

    function renderChangeRequests() {
      const requestsList = document.getElementById("requests-list");
      const pendingRequests = changeRequests.filter(r => r.status === "pending");
      
      if (pendingRequests.length === 0) {
        requestsList.innerHTML = "<span style='color:#888;'>å¤‰æ›´ä¾é ¼ã¯ã‚ã‚Šã¾ã›ã‚“</span>";
        return;
      }
      
      let html = "";
      pendingRequests.forEach(request => {
        const originalDate = new Date(request.originalHistory.date);
        const newDate = new Date(request.newTime);
        
        html += `<div class="request-item request-pending">
          <b>${request.empname} (${request.empno})</b><br>
          å¤‰æ›´å¯¾è±¡: ${request.originalHistory.type}<br>
          ç¾åœ¨ã®æ™‚åˆ»: ${originalDate.toLocaleString('ja-JP')}<br>
          å¤‰æ›´å¾Œã®æ™‚åˆ»: ${newDate.toLocaleString('ja-JP')}<br>
          ç†ç”±: ${escapeHtml(request.reason)}<br>
          ç”³è«‹æ—¥æ™‚: ${new Date(request.requestDate).toLocaleString('ja-JP')}<br>
          <button class="approve-btn" onclick="approveRequest('${request.id}')">æ‰¿èª</button>
          <button class="reject-btn" onclick="rejectRequest('${request.id}')">å´ä¸‹</button>
        </div>`;
      });
      
      requestsList.innerHTML = html;
    }

    function approveRequest(requestId) {
      const request = changeRequests.find(r => r.id == requestId);
      if (!request) return;
      
      // å±¥æ­´ã‚’æ›´æ–°
      const history = historyData[request.empno];
      if (history) {
        const targetIndex = history.findIndex(h => h.id === request.originalHistory.id);
        if (targetIndex !== -1) {
          history[targetIndex].date = new Date(request.newTime).toISOString();
          history[targetIndex].edited = true;
          history[targetIndex].editReason = request.reason;
        }
      }
      
      // ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
      request.status = "approved";
      
      alert("å¤‰æ›´ä¾é ¼ã‚’æ‰¿èªã—ã¾ã—ãŸã€‚");
      renderChangeRequests();
      renderAdminHistory();
    }

    function rejectRequest(requestId) {
      const request = changeRequests.find(r => r.id == requestId);
      if (!request) return;
      
      request.status = "rejected";
      
      alert("å¤‰æ›´ä¾é ¼ã‚’å´ä¸‹ã—ã¾ã—ãŸã€‚");
      renderChangeRequests();
    }

    function renderAdminHistory() {
      let html = "<h3>å…¨ç¤¾å“¡ã®æ‰“åˆ»å±¥æ­´ï¼ˆå…¨æœŸé–“ï¼‰</h3>";
      let hasData = false;
      
      // ç¤¾å“¡ç•ªå·ã§ã‚½ãƒ¼ãƒˆ
      const sortedEmpnos = Object.keys(historyData).sort();
      
      sortedEmpnos.forEach(empno => {
        if (historyData[empno].length > 0) {
          hasData = true;
          const empHistory = historyData[empno];
          const empName = empHistory[0].empname; // æœ€åˆã®å±¥æ­´ã‹ã‚‰åå‰ã‚’å–å¾—
          
          html += `<div style="margin: 20px 0; padding: 15px; background: #f0f0f0; border-radius: 5px;">`;
          html += `<b style="font-size: 1.1em;">ç¤¾å“¡ç•ªå·: ${empno} - ${empName}</b><br>`;
          html += `<div style="margin-top: 10px;">`;
          
          // å…¨å±¥æ­´ã‚’è¡¨ç¤ºï¼ˆç®¡ç†è€…ã¯ç„¡åˆ¶é™ï¼‰
          empHistory.forEach(h => {
            const dateObj = new Date(h.date);
            const formattedDate = dateObj.toLocaleString('ja-JP');
            html += `<div style="padding: 5px 0; border-bottom: 1px solid #ddd;">`;
            html += `${formattedDate} - <b>${h.type}</b>`;
            if (h.edited) {
              html += ` <span style="color:#ff6b00;">[ç·¨é›†æ¸ˆã¿: ${h.editReason}]</span>`;
            }
            if (h.lat && h.lng) {
              html += ` <a href="https://www.google.com/maps?q=${h.lat},${h.lng}" target="_blank" style="font-size:0.8em;">ğŸ“</a>`;
            }
            html += `</div>`;
          });
          
          html += `</div>`;
          html += `<div style="margin-top: 10px; font-size: 0.9em; color: #666;">ç·æ‰“åˆ»æ•°: ${empHistory.length}ä»¶</div>`;
          html += `</div>`;
        }
      });
      
      if (!hasData) {
        html += "<span style='color:#888;'>ã¾ã æ‰“åˆ»å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</span>";
      }
      
      document.getElementById("admin-history").innerHTML = html;
    }

    console.log("KAORYã‚·ã‚¹ãƒ†ãƒ  - åˆæœŸåŒ–å®Œäº†");
  </script>
</body>
</html>
