<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>KAORY</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body {
      font-family: 'Segoe UI', 'Meiryo', sans-serif;
      background: #f2f6fa;
      margin: 0;
      padding: 0;
    }
    header {
      background: #0072bc;
      color: #fff;
      padding: 18px 10px 12px 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .main-title {
      font-size: 2em;
      font-weight: bold;
      letter-spacing: 0.1em;
      margin-bottom: 6px;
    }
    .subtitle {
      font-size: 1.05em;
      opacity: 0.92;
      letter-spacing: 0.04em;
    }
    main {
      max-width: 480px;
      margin: 32px auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 16px rgba(0,0,0,0.06);
      padding: 24px 18px 32px 18px;
    }
    #result {
      font-size: 1.2em;
      margin: 12px 0;
      min-height: 1.8em;
    }
    #roulette-area {
      margin: 12px 0 0 0;
      min-height: 3em;
    }
    #history {
      margin-top: 24px;
      background: #f8f8f8;
      border-radius: 8px;
      padding: 16px;
      font-size: 0.98em;
      word-break: break-all;
    }
    .btn {
      background: #0072bc;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 12px 28px;
      font-size: 1.1em;
      cursor: pointer;
      margin: 10px 0;
      transition: background 0.2s;
    }
    .btn:hover {
      background: #005fa3;
    }
    .btn:disabled {
        background-color: #ccc;
        cursor: not-allowed;
    }
    .hidden {
      display: none;
    }
    .history-entry {
      margin-bottom: 10px;
      border-bottom: 1px dotted #b2cbe4;
      padding-bottom: 7px;
    }
    .edit-btn, .delete-btn {
      background: #eee;
      color: #333;
      border: none;
      border-radius: 3px;
      padding: 3px 9px;
      font-size: 0.97em;
      margin-left: 7px;
      cursor: pointer;
    }
    .edit-btn:hover, .delete-btn:hover {
      background: #cbe3fa;
    }
    /* --- Login Area Styles --- */
    #login-area label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
        color: #555;
        text-align: left;
    }
    #login-area select, #login-area input[type="text"], #login-area input[type="password"] {
        width: 100%;
        padding: 10px;
        margin-bottom: 15px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
    }
    /* --- End Login Area Styles --- */
    .input-row {
      margin-bottom: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .input-row label {
      min-width: 80px;
      font-weight: bold;
    }
    .input-row input {
      flex: 1;
      font-size: 1.1em;
      padding: 7px 8px;
      border: 1px solid #b2cbe4;
      border-radius: 5px;
    }
    .inout-btns {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
    }
    .inout-btn {
      flex: 1;
      font-size: 1.1em;
      font-weight: bold;
      padding: 12px 0;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      transition: background 0.2s;
    }
    .in-btn {
      background: #4caf50;
      color: #fff;
    }
    .in-btn:hover {
      background: #388e3c;
    }
    .out-btn {
      background: #f44336;
      color: #fff;
    }
    .out-btn:hover {
      background: #c62828;
    }
    .logout-btn {
      background: #999;
      color: #fff;
      border: none;
      border-radius: 5px;
      padding: 7px 18px;
      font-size: 1em;
      margin-top: 10px;
      cursor: pointer;
    }
    .logout-btn:hover {
      background: #666;
    }
    .roulette-win {
      color: #eabf00;
      background: #fffbe8;
      font-size: 1.2em;
      font-weight: bold;
      padding: 10px;
      border-radius: 8px;
      margin-top: 5px;
      animation: flash 1s 2;
    }
    .roulette-lose {
      color: #888;
      background: #f4f4f4;
      font-size: 1.1em;
      padding: 10px;
      border-radius: 8px;
      margin-top: 5px;
    }
    @keyframes flash {
      0% { background: #fffbe8; }
      50% { background: #fff3a0; }
      100% { background: #fffbe8; }
    }
    /* ç®¡ç†è€…ç”»é¢ */
    #admin-area {
      margin-top: 24px;
    }
    .admin-history-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.97em;
      margin-top: 10px;
      table-layout: fixed;
    }
    .admin-history-table th, .admin-history-table td {
      border: 1px solid #b2cbe4;
      padding: 4px 2px;
      text-align: left;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .admin-history-table th {
      background: #e9f3fa;
      font-size: 0.97em;
    }
    .admin-history-table td.device-col {
      max-width: 80px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: pointer;
      color: #0072bc;
      font-size: 0.94em;
    }
    .admin-history-table tr:nth-child(even) {
      background: #f7fafc;
    }
    .admin-logout-btn {
      background: #c62828;
      color: #fff;
      border: none;
      border-radius: 5px;
      padding: 7px 18px;
      font-size: 1em;
      margin-top: 10px;
      cursor: pointer;
    }
    .admin-logout-btn:hover {
      background: #a31515;
    }
    @media (max-width: 600px) {
      main {
        margin: 12px 3px;
        padding: 12px 3vw 16px 3vw;
      }
      header {
        font-size: 1em;
        padding: 12px 3vw;
      }
      .main-title {
        font-size: 1.3em;
      }
      .subtitle {
        font-size: 0.95em;
      }
      .admin-history-table th, .admin-history-table td {
        font-size: 0.92em;
        padding: 3px 1px;
      }
      .admin-history-table td.device-col {
        max-width: 55px;
        font-size: 0.91em;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="main-title">KAORY</div>
    <div class="subtitle">æ ªå¼ä¼šç¤¾ æˆä¼¸å·¥æ¥­ å‡ºé€€å‹¤å°‚ç”¨ã‚¢ãƒ—ãƒª</div>
  </header>
  <main>
    <!-- ãƒ­ã‚°ã‚¤ãƒ³é¸æŠç”»é¢ -->
    <div id="login-area">
      <h2 style="margin-top:0;">ãƒ­ã‚°ã‚¤ãƒ³</h2>
      <label for="department">éƒ¨ç½²:</label>
      <select id="department" name="department">
          <option value="">-- éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>
      </select>

      <label for="section">èª²:</label>
      <select id="section" name="section" disabled>
          <option value="">-- èª²ã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>
      </select>

      <label for="employee">åå‰:</label>
      <select id="employee" name="employee" disabled>
          <option value="">-- åå‰ã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>
      </select>

      <label for="employee-number">ç¤¾å“¡ç•ªå·:</label>
      <input type="text" id="employee-number" name="employee-number" placeholder="ç¤¾å“¡ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" disabled>

      <button id="loginButton" class="btn" onclick="login()" disabled>æ¬¡ã¸</button>
      <div id="login-error" style="color:red;min-height:1.5em;"></div>

      <!-- ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ  -->
      <div id="admin-login-area" style="margin-top:22px;">
        <hr>
        <div><b>ç®¡ç†è€…å°‚ç”¨ãƒ­ã‚°ã‚¤ãƒ³</b></div>
        <div class="input-row" style="margin-bottom:5px;">
          <label for="admin-pass" style="min-width:70px;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
          <input type="password" id="admin-pass" maxlength="20" autocomplete="off" style="max-width:140px;">
        </div>
        <button class="btn" style="padding:8px 22px;font-size:1em;" onclick="adminLogin()">ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</button>
        <div id="admin-login-error" style="color:red;min-height:1.5em;"></div>
      </div>
    </div>

    <!-- æ‰“åˆ»ç”»é¢ -->
    <div id="stamp-area" class="hidden">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h2 style="margin:0;">å‡ºé€€å‹¤æ‰“åˆ»</h2>
        <button class="logout-btn" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>
      <div style="margin-bottom:10px;">
        <b>ç¤¾å“¡ç•ªå·ï¼š</b><span id="current-empno"></span> <br>
        <b>åå‰ï¼š</b><span id="current-empname"></span>
      </div>
      <div class="inout-btns">
        <button class="inout-btn in-btn" onclick="startQrReader('å‡ºå‹¤')">å‡ºå‹¤</button>
        <button class="inout-btn out-btn" onclick="startQrReader('é€€å‹¤')">é€€å‹¤</button>
      </div>
      <div id="result"></div>
      <div id="roulette-area"></div>
      <div id="qr-reader" class="hidden" style="margin-top:14px;"></div>
      <div id="history"></div>
    </div>

    <!-- ç®¡ç†è€…ç”»é¢ -->
    <div id="admin-area" class="hidden">
      <h2 style="margin-top:0;">ç®¡ç†è€…ç”¨ï¼šå…¨ä½“å‡ºé€€å‹¤å±¥æ­´</h2>
      <div id="admin-history"></div>
      <button class="admin-logout-btn" onclick="adminLogout()">ç®¡ç†è€…ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
  </main>

  <script>
    // --- ä¼šç¤¾ãƒ‡ãƒ¼ã‚¿ ---
    const companyData = {
        "è£½é€ éƒ¨": {
            "è£½é€ èª²": [
                { name: "å°å‚ æ•æ–‡", id: "MS01" }, { name: "ç‰‡å±± é›„å¸", id: "MS02" }, { name: "è±Šç”° å´‡è–", id: "MS03" },
                { name: "å²¡ å¤§æˆ", id: "MS04" }, { name: "æ²³æœ¬ å“å“‰", id: "MS05" }, { name: "å²©ç”° ä¸€å¹³", id: "MS06" },
                { name: "è—¤æ°¸ æ­¦å¿—", id: "MS07" }, { name: "é  é¾æˆ", id: "MS08" }, { name: "ç¦æµª æ™ºå¼˜", id: "MS09" },
                { name: "è±Šç”° æŸ¾å¸Œ", id: "MS10" }, { name: "ãƒã‚ª", id: "MS11" }, { name: "ã‚½ãƒ³", id: "MS12" },
                { name: "ãƒãƒ¥ãƒƒã‚¯", id: "MS13" }, { name: "ã‚´ã‚¢ãƒ³", id: "MS14" }, { name: "æ¸…å®¶ ç¿¼", id: "MS15" },
                { name: "å°å· æ™ƒå¤§", id: "MS16" }, { name: "å‰æ°¸ è¼ä¹Ÿ", id: "MS17" }, { name: "ã‚¿ã‚¤ãƒ³", id: "MS18" },
                { name: "æœ«ç•™ ç‘è¦", id: "MS19" }, { name: "ãƒ›ã‚¢ãƒ³", id: "MS20" }, { name: "ã‚¯ã‚¢ãƒ³", id: "MS21" },
                { name: "ãƒ´ãƒ¼", id: "MS22" }, { name: "ãƒ†ã‚£ãƒ³", id: "MS23" }
            ],
            "æº¶æ¥èª²": [
                { name: "è—¤åŸ ç§€ä¸€", id: "MY01" }, { name: "æ¨‹ä¸Š é›…å½¦", id: "MY02" }, { name: "ä½™ äºŒå¥", id: "MY03" },
                { name: "é»’æœ¨ çœŸäºº", id: "MY04" }, { name: "è—¤ç”° æ™‹ä¹Ÿ", id: "MY05" }, { name: "ãƒ‡ãƒ­ã‚¹", id: "MY06" },
                { name: "æ¾å· å“²ä¹Ÿ", id: "MY07" }, { name: "é«™æ©‹ æ·³", id: "MY08" }, { name: "ãƒ–ã‚ªãƒ³", id: "MY09" }
            ],
            "æŠ€è¡“æ”¯æ´èª²": [
                { name: "ä¹…æ´¥é–“ å‰›", id: "MG01" }
            ],
            "ãƒ­ãƒœãƒƒãƒˆã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³èª²": [
                { name: "æ¡‘ç”° å¤§è¼”", id: "MR01" }
            ],
            "ãƒ¬ãƒ¼ã‚¶ãƒ¼ã‚·ã‚¢ãƒªãƒ³ã‚°èª²": [
                { name: "å¥¥æ±Ÿ äº®è¼”", id: "ML01" }, { name: "å¥¥æ±Ÿ èµ·çŸ¢", id: "ML02" }, { name: "å°æ— è¯ä»£", id: "ML03" },
                { name: "æ±æ£® å¥å¤ª", id: "ML04" }, { name: "å¾Œè—¤ ä¸€ä¹Ÿ", id: "ML05" }, { name: "é–€ç”° ä¿¡å­", id: "ML06" },
                { name: "å¤§å‡º ã‚ã‹ã­", id: "ML07" }
            ],
            "Hå½¢é‹¼æ©Ÿæ¢°åŠ å·¥èª²": [
                { name: "è©åŸ æ­£å±•", id: "MH01" }, { name: "å°ç”° è£•æƒŸ", id: "MH02" }, { name: "ä¸‰è°· æ•å¤«", id: "MH03" },
                { name: "æ— å¸", id: "MH04" }, { name: "å°ç”° æ­¦å£«", id: "MH05" }, { name: "åº§è³€ç™½ æ´‹ä¸€", id: "MH06" },
                { name: "ç«¹åŸ è–ä¹Ÿ", id: "MH07" }, { name: "é«˜æœ¬ æœ‹å…¸", id: "MH08" }, { name: "é«˜æ©‹ äºœå®Ÿ", id: "MH09" }
            ]
        },
        "å·¥å‹™éƒ¨": {
            "è¨­è¨ˆèª²": [
                { name: "è²æ¸… ä¿Šä¸€", id: "KS01" }, { name: "è—¤äº• æ•¦ä»", id: "KS02" }, { name: "ç•‘æœ¬ æ³°å®", id: "KS03" },
                { name: "æ— çŠçŠ", id: "KS04" }, { name: "æ­¦æœ¬ ç¤¼", id: "KS05" }, { name: "ä»Šå· è–ä½³", id: "KS06" },
                { name: "å‰å· å½©é¦™", id: "KS07" }, { name: "åºƒæ±Ÿ å°†å’Œ", id: "KS08" }
            ],
            "é…é€èª²": [
                { name: "ä»Šæ‘ ä»", id: "KH01" }, { name: "ä¹ƒç¾ å´‡ä¸€éƒ", id: "KH02" }, { name: "å‚æœ¬ å¤§å’Œ", id: "KH03" },
                { name: "å²¡åŸ ç”±æ´‹", id: "KH04" }, { name: "èŠ è³¢äºŒ", id: "KH05" }
            ],
            "å·¥äº‹èª²": [
                { name: "çŸ³äº• å‹‡ä¹Ÿ", id: "KK01" }, { name: "æœªå‰ å°†å¿—", id: "KK02" }
            ]
        },
        "ç·å‹™éƒ¨": {
            "ç·å‹™èª²": [
                { name: "æ²³åŸ æ˜éŸ³", id: "SS01" }, { name: "é’æœ¨ å„ªèŠ±", id: "SS02" }, { name: "æ¥¢å´ æ˜å½¦", id: "SS03" }
            ]
        }
    };

    // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
    let qrReader = null;
    let qrProcessing = false;
    let punchType = "";
    let currentEmpNo = ""; // ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®ç¤¾å“¡ç•ªå·ã‚’ä¿æŒ
    let currentEmpName = ""; // ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®ç¤¾å“¡åã‚’ä¿æŒ

    // --- åˆæœŸåŒ–å‡¦ç† ---
    document.addEventListener('DOMContentLoaded', function() {
      if (sessionStorage.getItem("admin") === "1") {
        showAdminArea();
        return;
      }
      const loggedInEmpNo = sessionStorage.getItem("loggedInEmpNo");
      const loggedInEmpName = sessionStorage.getItem("loggedInEmpName");
      if(loggedInEmpNo && loggedInEmpName) {
        showStampArea(loggedInEmpNo, loggedInEmpName);
      } else {
        showLoginArea();
        initializeDepartments(); // ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢è¡¨ç¤ºæ™‚ã«éƒ¨ç½²ã‚’åˆæœŸåŒ–
      }
      setupEventListeners(); // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
    });
    // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š ---
    function setupEventListeners() {
      const departmentSelect = document.getElementById('department');
      const sectionSelect = document.getElementById('section');
      const employeeSelect = document.getElementById('employee');
      const employeeNumberInput = document.getElementById('employee-number');
      const loginButton = document.getElementById('loginButton');
      const loginError = document.getElementById('login-error');

      departmentSelect.addEventListener('change', function() {
        const selectedDepartment = this.value;
        sectionSelect.innerHTML = '<option value="">-- èª²ã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>';
        employeeSelect.innerHTML = '<option value="">-- åå‰ã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>';
        sectionSelect.disabled = true;
        employeeSelect.disabled = true;
        employeeNumberInput.disabled = true;
        employeeNumberInput.value = '';
        loginButton.disabled = true;
        loginError.innerText = '';

        if (selectedDepartment && companyData[selectedDepartment]) {
          const sections = Object.keys(companyData[selectedDepartment]);
          sections.forEach(sec => {
            const option = document.createElement('option');
            option.value = sec;
            option.textContent = sec;
            sectionSelect.appendChild(option);
          });
          sectionSelect.disabled = false;
        }
      });

      sectionSelect.addEventListener('change', function() {
        const selectedDepartment = departmentSelect.value;
        const selectedSection = this.value;
        employeeSelect.innerHTML = '<option value="">-- åå‰ã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>';
        employeeSelect.disabled = true;
        employeeNumberInput.disabled = true;
        employeeNumberInput.value = '';
        loginButton.disabled = true;
        loginError.innerText = '';

        if (selectedDepartment && selectedSection && companyData[selectedDepartment][selectedSection]) {
          const employees = companyData[selectedDepartment][selectedSection];
          employees.forEach(emp => {
            const option = document.createElement('option');
            option.value = emp.id; // valueã«ç¤¾å“¡ç•ªå·ã‚’è¨­å®š
            option.textContent = emp.name;
            employeeSelect.appendChild(option);
          });
          employeeSelect.disabled = false;
        }
      });

      employeeSelect.addEventListener('change', function() {
        employeeNumberInput.disabled = !this.value;
        employeeNumberInput.value = '';
        loginButton.disabled = true;
        loginError.innerText = '';
        
        if (this.value) {
          employeeNumberInput.focus(); // åå‰é¸æŠå¾Œã€ç¤¾å“¡ç•ªå·å…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
        }
      });

      employeeNumberInput.addEventListener('input', function() {
        const trimmedValue = this.value.trim();
        loginButton.disabled = !trimmedValue;
        loginError.innerText = '';
      });
    }

    // --- ãƒ­ã‚°ã‚¤ãƒ³é–¢é€£å‡¦ç† ---
    function initializeDepartments() {
      const departmentSelect = document.getElementById('department');
      const sectionSelect = document.getElementById('section');
      const employeeSelect = document.getElementById('employee');
      const employeeNumberInput = document.getElementById('employee-number');
      const loginButton = document.getElementById('loginButton');

      // æ—¢å­˜ã®é¸æŠè‚¢ã‚’ã‚¯ãƒªã‚¢ï¼ˆåˆæœŸè¡¨ç¤ºç”¨ï¼‰
      departmentSelect.innerHTML = '<option value="">-- éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>';
      Object.keys(companyData).forEach(dep => {
        const option = document.createElement('option');
        option.value = dep;
        option.textContent = dep;
        departmentSelect.appendChild(option);
      });
      // å¿µã®ãŸã‚ã€èª²ã¨åå‰ã‚‚ãƒªã‚»ãƒƒãƒˆ
      sectionSelect.innerHTML = '<option value="">-- èª²ã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>';
      employeeSelect.innerHTML = '<option value="">-- åå‰ã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>';
      sectionSelect.disabled = true;
      employeeSelect.disabled = true;
      employeeNumberInput.disabled = true;
      employeeNumberInput.value = '';
      loginButton.disabled = true;
    }

    function login() {
      const departmentSelect = document.getElementById('department');
      const sectionSelect = document.getElementById('section');
      const employeeSelect = document.getElementById('employee');
      const employeeNumberInput = document.getElementById('employee-number');
      const loginError = document.getElementById('login-error');

      const selectedDepartment = departmentSelect.value;
      const selectedSection = sectionSelect.value;
      const selectedEmployeeId = employeeSelect.value;
      const selectedEmployeeName = employeeSelect.options[employeeSelect.selectedIndex].text;
      const enteredEmployeeNumber = employeeNumberInput.value.trim();

      if (!selectedDepartment || !selectedSection || !selectedEmployeeId || !enteredEmployeeNumber) {
        loginError.innerText = "éƒ¨ç½²ã€èª²ã€åå‰ã€ç¤¾å“¡ç•ªå·ã‚’ã™ã¹ã¦å…¥åŠ›ã—ã¦ãã ã•ã„";
        return;
      }

      // ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ï¼ˆå…¥åŠ›ã•ã‚ŒãŸç¤¾å“¡ç•ªå·ã‚’ä½¿ç”¨ï¼‰
      sessionStorage.setItem("loggedInEmpNo", enteredEmployeeNumber);
      sessionStorage.setItem("loggedInEmpName", selectedEmployeeName);
      showStampArea(enteredEmployeeNumber, selectedEmployeeName);
    }

    function logout() {
      sessionStorage.removeItem("loggedInEmpNo");
      sessionStorage.removeItem("loggedInEmpName");
      showLoginArea();
      initializeDepartments(); // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå¾Œã€ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã®éƒ¨ç½²ã‚’å†åˆæœŸåŒ–
    }

    function showLoginArea() {
      document.getElementById("login-area").classList.remove("hidden");
      document.getElementById("stamp-area").classList.add("hidden");
      document.getElementById("admin-area").classList.add("hidden");

      const departmentSelect = document.getElementById('department');
      const sectionSelect = document.getElementById('section');
      const employeeSelect = document.getElementById('employee');
      const employeeNumberInput = document.getElementById('employee-number');
      const loginButton = document.getElementById('loginButton');
      const loginError = document.getElementById('login-error');
      const adminLoginError = document.getElementById('admin-login-error');

      // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
      departmentSelect.value = "";
      sectionSelect.innerHTML = '<option value="">-- èª²ã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>';
      employeeSelect.innerHTML = '<option value="">-- åå‰ã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>';
      sectionSelect.disabled = true;
      employeeSelect.disabled = true;
      employeeNumberInput.disabled = true;
      employeeNumberInput.value = '';
      loginButton.disabled = true;
      loginError.innerText = "";
      adminLoginError.innerText = "";
      document.getElementById("admin-pass").value = "";

      // QRãƒªãƒ¼ãƒ€ãƒ¼ãŒã‚ã‚Œã°åœæ­¢
      if (qrReader && qrReader.getState() === 2) { // STATE 2: SCANNING
          qrReader.stop().catch(err => console.error("QRãƒªãƒ¼ãƒ€ãƒ¼åœæ­¢ã‚¨ãƒ©ãƒ¼:", err));
      }
      qrReader = null; // ãƒªãƒ¼ãƒ€ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚¯ãƒªã‚¢
      qrProcessing = false;
    }

    function showStampArea(empno, empname) {
      currentEmpNo = empno; // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿æŒ
      currentEmpName = empname; // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿æŒ
      document.getElementById("current-empno").innerText = empno;
      document.getElementById("current-empname").innerText = empname; // åå‰ã‚‚è¡¨ç¤º
      document.getElementById("login-area").classList.add("hidden");
      document.getElementById("stamp-area").classList.remove("hidden");
      document.getElementById("admin-area").classList.add("hidden");
      document.getElementById("result").innerHTML = "";
      document.getElementById("roulette-area").innerHTML = "";
      document.getElementById("qr-reader").classList.add("hidden");
      renderHistory(); // ãƒ­ã‚°ã‚¤ãƒ³ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å±¥æ­´ã‚’è¡¨ç¤º
    }
    // --- æ‰“åˆ»é–¢é€£å‡¦ç† ---
    function startQrReader(type) {
      punchType = type;
      document.getElementById("result").innerHTML = "";
      document.getElementById("roulette-area").innerHTML = "";
      document.getElementById("qr-reader").classList.remove("hidden");
      if (qrReader) {
          qrReader.clear().catch(err => console.error("QRãƒªãƒ¼ãƒ€ãƒ¼clearã‚¨ãƒ©ãƒ¼:", err));
      }
      qrReader = new Html5Qrcode("qr-reader");
      qrProcessing = false;

      const config = { fps: 10, qrbox: { width: 250, height: 250 } };

      qrReader.start(
        { facingMode: "environment" },
        config,
        qrCodeMessage => {
          if (qrProcessing) return;
          qrProcessing = true;
          document.getElementById("result").innerHTML = `<span style="color:#0072bc;">ä½ç½®æƒ…å ±ã‚’å–å¾—ã—ã¦ã„ã¾ã™...</span>`;
          navigator.geolocation.getCurrentPosition(
            function(position) {
              addHistory(currentEmpNo, punchType, qrCodeMessage, new Date(), position.coords, navigator.userAgent);
              document.getElementById("result").innerHTML = `<span style="color:green;">${punchType}æ‰“åˆ»ã—ã¾ã—ãŸ</span>`;
              stopQrReaderAndShowRoulette();
            },
            function(error) {
              addHistory(currentEmpNo, punchType, qrCodeMessage, new Date(), null, navigator.userAgent);
              document.getElementById("result").innerHTML = `<span style="color:red;">ä½ç½®æƒ…å ±ã‚¨ãƒ©ãƒ¼ï¼ˆ${error.message}ï¼‰</span>`;
              stopQrReaderAndShowRoulette();
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            }
          );
        },
        errorMessage => {
            // console.log(`QRã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Šã‚¨ãƒ©ãƒ¼: ${errorMessage}`);
        }
      ).catch(err => {
          console.error("QRãƒªãƒ¼ãƒ€ãƒ¼é–‹å§‹ã‚¨ãƒ©ãƒ¼:", err);
          document.getElementById("result").innerHTML = `<span style="color:red;">ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚è¨±å¯ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</span>`;
          document.getElementById("qr-reader").classList.add("hidden");
          qrProcessing = false; // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ãƒ•ãƒ©ã‚°ã‚’æˆ»ã™
      });
    }


    // QRãƒªãƒ¼ãƒ€ãƒ¼ã‚’åœæ­¢ã—ã¦ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã‚’è¡¨ç¤ºã™ã‚‹å…±é€šå‡¦ç†
    function stopQrReaderAndShowRoulette() {
        if (qrReader && qrReader.getState() === 2) { // STATE 2: SCANNING
            qrReader.stop()
                .then(() => {
                    document.getElementById("qr-reader").classList.add("hidden");
                    qrProcessing = false;
                    showRoulette();
                })
                .catch(err => {
                    console.error("QRãƒªãƒ¼ãƒ€ãƒ¼åœæ­¢ã‚¨ãƒ©ãƒ¼:", err);
                    document.getElementById("qr-reader").classList.add("hidden"); // ã‚¨ãƒ©ãƒ¼ã§ã‚‚éš ã™
                    qrProcessing = false;
                    showRoulette(); // ã‚¨ãƒ©ãƒ¼ã§ã‚‚ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã¯è¡¨ç¤ºè©¦è¡Œ
                });
        } else {
             // ãƒªãƒ¼ãƒ€ãƒ¼ãŒèµ·å‹•ã—ã¦ã„ãªã„ã‹ã€æ—¢ã«åœæ­¢ã—ã¦ã„ã‚‹å ´åˆ
             document.getElementById("qr-reader").classList.add("hidden");
             qrProcessing = false;
             showRoulette();
        }
    }

    function showRoulette() {
      const rouletteDiv = document.getElementById("roulette-area");
      rouletteDiv.innerHTML = '<span style="color:#0072bc;">ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆä¸­...</span>';
      setTimeout(() => {
        const isWin = Math.random() < 0.5; // 50%ã®ç¢ºç‡
        if (isWin) {
          rouletteDiv.innerHTML = `<div class="roulette-win">
            ğŸ‰å½“ãŸã‚Šï¼ã‚¸ãƒ¥ãƒ¼ã‚¹ä¸€æœ¬ç„¡æ–™ï¼ğŸ‰<br>
            <span style="font-size:1em;">ã‚¹ã‚¯ã‚·ãƒ§ã‚’æ’®ã£ã¦ç·å‹™éƒ¨ã¸æç¤ºã—ã¦ã­ï¼</span><br>
            <video src="2w2RgwYcL080demHj2RyNDjIRJU.mp4" autoplay loop muted playsinline style="width:180px;max-width:95vw;margin-top:5px;border-radius:10px;box-shadow:0 2px 12px rgba(0,0,0,0.13);"></video>
          </div>`;
        } else {
          rouletteDiv.innerHTML = `<div class="roulette-lose">
            ã¯ãšã‚Œï½ã¾ãŸæŒ‘æˆ¦ã—ã¦ã­ï¼<br>
            <video src="2yBlj3kHxxedMcnHvk18R4dRRwf.mp4" autoplay loop muted playsinline style="width:120px;max-width:85vw;margin-top:5px;border-radius:10px;box-shadow:0 2px 12px rgba(0,0,0,0.13);"></video>
          </div>`;
        }
      }, 900);
    }
    // --- å±¥æ­´é–¢é€£å‡¦ç† ---
    function addHistory(empno, type, qr, date, coords, device) {
      // å±¥æ­´ã®ã‚­ãƒ¼ã‚’ç¤¾å“¡ç•ªå·ãƒ™ãƒ¼ã‚¹ã«å¤‰æ›´
      let key = "history_" + empno;
      let history = JSON.parse(localStorage.getItem(key) || "[]");
      const entry = {
        empno: empno, // å±¥æ­´ã«ã‚‚ç¤¾å“¡ç•ªå·ã‚’ä¿å­˜ï¼ˆç®¡ç†è€…ç”»é¢ç”¨ï¼‰
        empname: currentEmpName, // åå‰ã‚‚ä¿å­˜
        type,
        qr,
        date: date.toISOString(), // ISOå½¢å¼ã§ä¿å­˜æ¨å¥¨
        lat: coords ? coords.latitude : null,
        lng: coords ? coords.longitude : null,
        device: device || ""
      };
      history.unshift(entry);
      // å±¥æ­´ä»¶æ•°ã‚’åˆ¶é™ã™ã‚‹å ´åˆ (ä¾‹: æœ€æ–°100ä»¶)
      // if (history.length > 100) {
      //   history.pop();
      // }
      localStorage.setItem(key, JSON.stringify(history));
      renderHistory(); // æ‰“åˆ»è€…ã®å±¥æ­´ã‚’æ›´æ–°
    }

    function renderHistory() {
      // ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç¤¾å“¡ç•ªå·ã‚’ä½¿ç”¨
      let key = "history_" + currentEmpNo;
      let history = JSON.parse(localStorage.getItem(key) || "[]");
      let html = "<b>æ‰“åˆ»å±¥æ­´</b><br>";
      if (history.length === 0) {
        html += "<span style='color:#888;'>ã¾ã å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</span>";
      } else {
        history.forEach((h, i) => {
          const dateObj = new Date(h.date); // ISOæ–‡å­—åˆ—ã‹ã‚‰Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¸
          const formattedDate = dateObj.toLocaleString('ja-JP'); // æ—¥æœ¬èªãƒ­ã‚±ãƒ¼ãƒ«ã§è¡¨ç¤º
          html += `<div class="history-entry">
            [${formattedDate}]<br>
            ç¨®åˆ¥: <b>${escapeHtml(h.type)}</b><br>
            QRå†…å®¹: <b>${escapeHtml(h.qr)}</b>
            ${h.lat && h.lng ? `<br>ä½ç½®: <a href="https://www.google.com/maps?q=${h.lat},${h.lng}" target="_blank">${h.lat.toFixed(5)},${h.lng.toFixed(5)}</a>` : "<br>ä½ç½®: ãªã—"}
            <br>ç«¯æœ«æƒ…å ±: <span style="font-size:0.95em;" title="${escapeHtml(h.device)}">${abbreviateDevice(h.device, 30)}</span>
            <br>
            <button class="edit-btn" onclick="editHistory(${i})">ç·¨é›†</button>
            <button class="delete-btn" onclick="deleteHistory(${i})">å‰Šé™¤</button>
          </div>`;
        });
      }
      document.getElementById("history").innerHTML = html;
    }

    // æ–‡å­—åˆ—ã‚’æŒ‡å®šæ–‡å­—æ•°ã§çœç•¥ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    function abbreviateDevice(str, maxLength) {
        if (!str) return "ãªã—";
        str = String(str); // å¿µã®ãŸã‚æ–‡å­—åˆ—ã«å¤‰æ›
        if (str.length <= maxLength) return escapeHtml(str);
        return escapeHtml(str.substr(0, maxLength - 1)) + "â€¦";
    }

    function escapeHtml(str) {
      if (typeof str !== 'string') return ""; // æ–‡å­—åˆ—ä»¥å¤–ã¯ç©ºæ–‡å­—ã‚’è¿”ã™
      return str.replace(/[&<>"'`]/g, function(match) {
        return ({
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;',
          '`': '&#x60;'
        })[match];
      });
    }

    function editHistory(index) {
      let key = "history_" + currentEmpNo;
      let history = JSON.parse(localStorage.getItem(key) || "[]");
      if (!history[index]) return; // å­˜åœ¨ã—ãªã„ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãªã‚‰ä½•ã‚‚ã—ãªã„

      let h = history[index];
      let newQr = prompt("QRå†…å®¹ã‚’ç·¨é›†", h.qr);
      if (newQr !== null) { // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œãªã‹ã£ãŸå ´åˆ
        h.qr = newQr.trim(); // å‰å¾Œã®ç©ºç™½ã‚’å‰Šé™¤
        history[index] = h;
        localStorage.setItem(key, JSON.stringify(history));
        renderHistory();
      }
    }

    function deleteHistory(index) {
      if (!confirm("ã“ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
      let key = "history_" + currentEmpNo;
      let history = JSON.parse(localStorage.getItem(key) || "[]");
      if (history[index]) { // å­˜åœ¨ã™ã‚‹å ´åˆã®ã¿å‰Šé™¤
          history.splice(index, 1);
          localStorage.setItem(key, JSON.stringify(history));
          renderHistory();
      }
    }
    // --- ç®¡ç†è€…é–¢é€£å‡¦ç† ---
    function adminLogin() {
      const pass = document.getElementById('admin-pass').value;
      const adminLoginError = document.getElementById('admin-login-error');
      // â˜†â˜†â˜† ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯æœ¬æ¥ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§æ¤œè¨¼ã™ã¹ãã§ã™ â˜†â˜†â˜†
      // â˜†â˜†â˜† ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã§ã®å˜ç´”æ¯”è¼ƒã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šéå¸¸ã«å±é™ºã§ã™ â˜†â˜†â˜†
      if (pass === "1") { // ä»®ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ "1"
        sessionStorage.setItem("admin", "1");
        showAdminArea();
      } else {
        adminLoginError.innerText = "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™";
      }
    }

    function showAdminArea() {
      document.getElementById("login-area").classList.add("hidden");
      document.getElementById("stamp-area").classList.add("hidden");
      document.getElementById("admin-area").classList.remove("hidden");
      renderAdminHistory();
       // ç®¡ç†è€…ç”»é¢è¡¨ç¤ºæ™‚ã«QRãƒªãƒ¼ãƒ€ãƒ¼ãŒã‚ã‚Œã°åœæ­¢
       if (qrReader && qrReader.getState() === 2) { // STATE 2: SCANNING
          qrReader.stop().catch(err => console.error("QRãƒªãƒ¼ãƒ€ãƒ¼åœæ­¢ã‚¨ãƒ©ãƒ¼(Admin):", err));
       }
       qrReader = null;
       qrProcessing = false;
    }

    function adminLogout() {
      sessionStorage.removeItem("admin");
      showLoginArea();
      initializeDepartments(); // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå¾Œã€ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã®éƒ¨ç½²ã‚’å†åˆæœŸåŒ–
    }

    // ç®¡ç†è€…ç”¨ï¼šå…¨ä½“å±¥æ­´è¡¨ç¤º
    function renderAdminHistory() {
      let html = '';
      let allHistoryEntries = [];

      // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å±¥æ­´ã‚’å–å¾—
      for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key.startsWith("history_")) {
              try {
                  const history = JSON.parse(localStorage.getItem(key) || "[]");
                  // å„å±¥æ­´ã‚¨ãƒ³ãƒˆãƒªã«å¿…è¦ãªæƒ…å ±ï¼ˆç¤¾å“¡ç•ªå·ã€åå‰ãªã©ï¼‰ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
                  history.forEach(entry => {
                      if(entry.date && entry.type && entry.qr) { // æœ€ä½é™ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ã‹
                         // empnoã¨empnameãŒentryã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹æƒ³å®š
                         allHistoryEntries.push(entry);
                      }
                  });
              } catch (e) {
                  console.error(`å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã®ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ (key: ${key}):`, e);
              }
          }
      }

      // æ—¥ä»˜ã§é™é †ï¼ˆæ–°ã—ã„é †ï¼‰ã«ã‚½ãƒ¼ãƒˆ
      allHistoryEntries.sort((a, b) => new Date(b.date) - new Date(a.date));

      if (allHistoryEntries.length === 0) {
        html = "<span style='color:#888;'>ã¾ã å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</span>";
      } else {
        html = `<table class="admin-history-table">
          <thead>
            <tr>
              <th style="width:60px;">ç¤¾å“¡ç•ªå·</th>
              <th style="width:90px;">åå‰</th>
              <th style="width:115px;">æ—¥ä»˜</th>
              <th style="width:45px;">ç¨®åˆ¥</th>
              <th style="width:75px;">QRå†…å®¹</th>
              <th style="width:70px;">ä½ç½®</th>
              <th style="width:80px;">ç«¯æœ«æƒ…å ±</th>
            </tr>
          </thead>
          <tbody>
        `;
        allHistoryEntries.forEach(h => {
          const dateObj = new Date(h.date);
          const formattedDate = dateObj.toLocaleString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }); // ã‚ˆã‚ŠçŸ­ã„å½¢å¼
          html += `<tr>
              <td>${escapeHtml(h.empno || 'ä¸æ˜')}</td>
              <td>${escapeHtml(h.empname || 'ä¸æ˜')}</td>
              <td>${escapeHtml(formattedDate)}</td>
              <td>${escapeHtml(h.type)}</td>
              <td>${escapeHtml(h.qr)}</td>
              <td>${h.lat && h.lng ? `<a href="https://www.google.com/maps?q=${h.lat},${h.lng}" target="_blank">${h.lat.toFixed(4)},${h.lng.toFixed(4)}</a>` : "ãªã—"}</td>
              <td class="device-col" title="${escapeHtml(h.device)}">${abbreviateDevice(h.device, 13)}</td>
            </tr>`;
        });
        html += "</tbody></table>";
      }
      document.getElementById("admin-history").innerHTML = html;
    }
  </script>
</body>
</html>

