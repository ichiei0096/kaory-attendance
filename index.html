<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>KAORY</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { font-family: 'Segoe UI', 'Meiryo', sans-serif; background: #f2f6fa; margin: 0; padding: 0; }
    header { background: #0072bc; color: #fff; padding: 18px 10px 12px 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .main-title { font-size: 2em; font-weight: bold; letter-spacing: 0.1em; margin-bottom: 6px; }
    .subtitle { font-size: 1.05em; opacity: 0.92; letter-spacing: 0.04em; }
    main { max-width: 480px; margin: 32px auto; background: #fff; border-radius: 12px; box-shadow: 0 2px 16px rgba(0,0,0,0.06); padding: 24px 18px 32px 18px; }
    #result { font-size: 1.2em; margin: 12px 0; min-height: 1.8em; }
    #roulette-area { margin: 12px 0 0 0; min-height: 3em; }
    #history { margin-top: 24px; background: #f8f8f8; border-radius: 8px; padding: 16px; font-size: 0.98em; word-break: break-all; }
    .btn { background: #0072bc; color: #fff; border: none; border-radius: 6px; padding: 12px 28px; font-size: 1.1em; cursor: pointer; margin: 10px 0; transition: background 0.2s; }
    .btn:hover { background: #005fa3; }
    .hidden { display: none; }
    .history-entry { margin-bottom: 10px; border-bottom: 1px dotted #b2cbe4; padding-bottom: 7px; }
    .change-time-btn, .change-report-btn { background: #ffd600; color: #333; border: none; border-radius: 3px; padding: 3px 9px; font-size: 0.97em; margin-left: 7px; cursor: pointer; }
    .change-time-btn:hover, .change-report-btn:hover { background: #ffe082; }
    .input-row { margin-bottom: 14px; display: flex; align-items: center; gap: 8px; }
    .input-row label { min-width: 80px; font-weight: bold; }
    .input-row input, .input-row select { flex: 1; font-size: 1.1em; padding: 7px 8px; border: 1px solid #b2cbe4; border-radius: 5px; }
    .inout-btns { display: flex; gap: 12px; margin-bottom: 12px; }
    .inout-btn { flex: 1; font-size: 1.1em; font-weight: bold; padding: 12px 0; border-radius: 6px; border: none; cursor: pointer; transition: background 0.2s; }
    .in-btn { background: #4caf50; color: #fff; }
    .in-btn:hover { background: #388e3c; }
    .out-btn { background: #f44336; color: #fff; }
    .out-btn:hover { background: #c62828; }
    .logout-btn { background: #999; color: #fff; border: none; border-radius: 5px; padding: 7px 18px; font-size: 1em; margin-top: 10px; cursor: pointer; }
    .logout-btn:hover { background: #666; }
    .roulette-win {
      color: #fff !important;
      background: linear-gradient(45deg, #FFD700, #FFA500);
      font-size: 1.3em;
      font-weight: bold;
      padding: 15px;
      border-radius: 15px;
      margin-top: 5px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
      animation: winPulse 1.5s ease-in-out infinite;
      text-shadow: 2px 2px 6px #a97b00, 0 0 8px #000;
    }
    .roulette-lose {
      color: #fff;
      background: linear-gradient(45deg, #87CEEB, #4682B4);
      font-size: 1.1em;
      font-weight: bold;
      padding: 15px;
      border-radius: 10px;
      margin-top: 5px;
      text-align: center;
      animation: loseShake 0.8s ease-in-out;
      text-shadow: 2px 2px 4px #1e3c6d, 0 0 8px #000;
    }
    @keyframes winPulse { 0% { transform: scale(1); box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4); } 50% { transform: scale(1.05); box-shadow: 0 6px 25px rgba(255, 215, 0, 0.6); } 100% { transform: scale(1); box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4); } }
    @keyframes loseShake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
    .roulette-spinning { animation: spin 0.1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    #admin-area { margin-top: 24px; }
    .admin-search-area { background: #e9f3fa; border-radius: 8px; padding: 18px 15px 10px 15px; margin-bottom: 18px; }
    .admin-search-row { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; flex-wrap: wrap; }
    .admin-search-row label { min-width: 68px; font-weight: bold; }
    .admin-search-row input[type="date"] { min-width: 140px; }
    .admin-search-row select { min-width: 120px; }
    .admin-search-row .multi-select { min-width: 160px; }
    .admin-history-table { width: 100%; border-collapse: collapse; font-size: 0.98em; margin-top: 10px; table-layout: fixed; }
    .admin-history-table th, .admin-history-table td { border: 1px solid #b2cbe4; padding: 6px 4px; text-align: left; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .admin-history-table th { background: #e9f3fa; }
    .admin-history-table tr:nth-child(even) { background: #f7fafc; }
    .admin-logout-btn { background: #c62828; color: #fff; border: none; border-radius: 5px; padding: 7px 18px; font-size: 1em; margin-top: 10px; cursor: pointer; }
    .admin-logout-btn:hover { background: #a31515; }
    .admin-clear-btn { background: #f44336; color: #fff; border: none; border-radius: 5px; padding: 7px 18px; font-size: 1em; margin-top: 10px; cursor: pointer; margin-left: 10px;}
    .admin-clear-btn:hover { background: #b71c1c; }
    .change-request-form, .change-report-form { background: #fff9c4; border: 1px solid #ffe082; border-radius: 6px; padding: 10px; margin: 10px 0; }
    .change-request-form label, .change-report-form label { display: block; margin-bottom: 4px; }
    .change-request-form input, .change-request-form textarea, .change-report-form input, .change-report-form textarea { width: 100%; margin-bottom: 7px; }
    .admin-requests-table { width: 100%; border-collapse: collapse; font-size: 0.98em; margin-top: 10px; }
    .admin-requests-table th, .admin-requests-table td { border: 1px solid #b2cbe4; padding: 6px 4px; text-align: left; }
    .admin-requests-table th { background: #ffe082; }
    .admin-requests-table tr:nth-child(even) { background: #fffde7; }
    .admin-approve-btn, .admin-reject-btn { border: none; border-radius: 3px; padding: 4px 10px; font-size: 1em; margin-right: 7px; cursor: pointer; }
    .admin-approve-btn { background: #4caf50; color: #fff; }
    .admin-reject-btn { background: #f44336; color: #fff; }
    .admin-approve-btn:hover { background: #2e7d32; }
    .admin-reject-btn:hover { background: #b71c1c; }
    .device-ellipsis, .location-ellipsis, .report-ellipsis { cursor: pointer; color: #0072bc; text-decoration: underline; }
    .modal-bg { position: fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.35); z-index:1000; display: flex; align-items: center; justify-content: center; }
    .modal-content { background:#fff; border-radius:8px; padding:24px; min-width:280px; max-width:90vw; max-height:80vh; box-shadow:0 8px 32px rgba(0,0,0,0.25); overflow: auto; }
    .modal-close { float:right; font-size:1.2em; color:#888; cursor:pointer; margin-left:10px;}
    .hidden { display: none !important; }
    @media (max-width: 900px) {
      .admin-history-table th, .admin-history-table td { font-size: 0.92em; padding: 4px 2px; }
    }
    @media (max-width: 600px) {
      main { margin: 12px 3px; padding: 12px 3vw 16px 3vw; }
      header { font-size: 1em; padding: 12px 3vw; }
      .main-title { font-size: 1.3em; }
      .subtitle { font-size: 0.95em; }
      .admin-history-table th, .admin-history-table td,
      .admin-requests-table th, .admin-requests-table td { font-size: 0.92em; padding: 4px 2px; }
      .admin-search-row {flex-direction: column; align-items: flex-start;}
      .admin-search-row label {margin-bottom: 3px;}
    }
    /* æ—¥å ±å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ */
    #report-modal-bg { position: fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.35); z-index:2000; display: flex; align-items: center; justify-content: center; }
    #report-modal-content { background:#fff; border-radius:8px; padding:24px; min-width:280px; max-width:90vw; max-height:80vh; box-shadow:0 8px 32px rgba(0,0,0,0.25); overflow: auto; }
    #report-modal-close { float:right; font-size:1.2em; color:#888; cursor:pointer; margin-left:10px;}
  </style>
</head>
<body>
  <audio id="audio-win" src="dorakue-reberuatsupuyin.mp3"></audio>
  <audio id="audio-lose" src="doragonkuesuto-miss.mp3"></audio>
  <audio id="audio-stamp" src="pokemon-hui-fu-yin.mp3"></audio>
  <header>
    <div class="main-title">KAORY</div>
    <div class="subtitle">æ ªå¼ä¼šç¤¾æˆä¼¸å·¥æ¥­ å‡ºé€€å‹¤å°‚ç”¨ã‚¢ãƒ—ãƒª</div>
  </header>
  <main>
    <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
    <div id="login-area">
      <h2 style="margin-top:0;">ãƒ­ã‚°ã‚¤ãƒ³</h2>
      <div class="input-row">
        <label for="department">éƒ¨ç½²</label>
        <select id="department">
          <option value="">-- éƒ¨ç½²ã‚’é¸æŠ --</option>
        </select>
      </div>
      <div class="input-row">
        <label for="section">èª²</label>
        <select id="section" disabled>
          <option value="">-- èª²ã‚’é¸æŠ --</option>
        </select>
      </div>
      <div class="input-row">
        <label for="employee">ãŠåå‰</label>
        <select id="employee" disabled>
          <option value="">-- åå‰ã‚’é¸æŠ --</option>
        </select>
      </div>
      <div class="input-row" style="display:none;">
        <label for="empno">ç¤¾å“¡ç•ªå·</label>
        <input type="text" id="empno" maxlength="10" autocomplete="off" placeholder="ä¾‹: 001">
      </div>
      <button class="btn" id="login-btn">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <div id="login-error" style="color:red;min-height:1.5em;"></div>
      <!-- ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ  -->
      <div id="admin-login-area" style="margin-top:22px;">
        <hr>
        <div><b>ç®¡ç†è€…å°‚ç”¨ãƒ­ã‚°ã‚¤ãƒ³</b></div>
        <div class="input-row" style="margin-bottom:5px;">
          <label for="admin-pass" style="min-width:70px;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
          <input type="password" id="admin-pass" maxlength="20" autocomplete="off" style="max-width:140px;">
        </div>
        <button class="btn" style="padding:8px 22px;font-size:1em;" id="admin-login-btn">ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</button>
        <div id="admin-login-error" style="color:red;min-height:1.5em;"></div>
      </div>
    </div>
    <!-- æ‰“åˆ»ç”»é¢ -->
    <div id="stamp-area" class="hidden">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h2 style="margin:0;">å‡ºé€€å‹¤æ‰“åˆ»</h2>
        <button class="logout-btn" id="logout-btn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>
      <div style="margin-bottom:10px;">
        <b>ç¤¾å“¡ç•ªå·ï¼š</b><span id="current-empno"></span><br>
        <b>ãŠåå‰ï¼š</b><span id="current-empname"></span>
      </div>
      <div class="inout-btns">
        <button class="inout-btn in-btn" id="in-btn">å‡ºå‹¤</button>
        <button class="inout-btn out-btn" id="out-btn">é€€å‹¤</button>
      </div>
      <div id="result"></div>
      <div id="roulette-area"></div>
      <div id="qr-reader" class="hidden" style="margin-top:14px;"></div>
      <div id="history"></div>
    </div>
    <!-- ç®¡ç†è€…ç”»é¢ -->
    <div id="admin-area" class="hidden">
      <h2 style="margin-top:0;">ç®¡ç†è€…ç”¨ï¼šå…¨ä½“å‡ºé€€å‹¤å±¥æ­´</h2>
      <div style="margin-bottom:10px;">
        <button class="admin-logout-btn" id="admin-logout-btn">ç®¡ç†è€…ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        <button class="admin-clear-btn" id="admin-clear-btn">å±¥æ­´å…¨æ¶ˆå»</button>
      </div>
      <!-- æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ  -->
      <div class="admin-search-area">
        <div class="admin-search-row">
          <label for="search-date-from">æœŸé–“</label>
          <input type="date" id="search-date-from">
          <span>ï½</span>
          <input type="date" id="search-date-to">
        </div>
        <div class="admin-search-row">
          <label for="search-sections">èª²</label>
          <select id="search-sections" class="multi-select" multiple size="3" style="height: auto; min-height: 60px;"></select>
        </div>
        <div class="admin-search-row">
          <label for="search-employees">ç¤¾å“¡å</label>
          <select id="search-employees" class="multi-select" multiple size="3" style="height: auto; min-height: 60px;"></select>
        </div>
        <div class="admin-search-row">
          <button class="btn" id="admin-search-btn" type="button" style="padding:8px 18px; font-size:1em;">æ¤œç´¢</button>
          <button class="btn" id="admin-search-reset-btn" type="button" style="background:#bbb;color:#222;padding:8px 18px; font-size:1em;">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
      </div>
      <div id="admin-history"></div>
      <h3 style="margin-top:30px;">æ™‚åˆ»ãƒ»æ—¥å ±å¤‰æ›´ç”³è«‹ä¸€è¦§</h3>
      <div id="admin-requests"></div>
    </div>
  </main>
  <div id="modal-bg" class="modal-bg hidden" onclick="closeModal(event)">
    <div class="modal-content" onclick="event.stopPropagation();">
      <span class="modal-close" onclick="closeModal(event)">&times;</span>
      <div id="modal-text"></div>
    </div>
  </div>
  <!-- æ—¥å ±å…¥åŠ›ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="report-modal-bg" class="modal-bg hidden" onclick="closeReportModal(event)">
    <div id="report-modal-content" onclick="event.stopPropagation();">
      <span id="report-modal-close" onclick="closeReportModal(event)">&times;</span>
      <div id="report-modal-inner"></div>
    </div>
  </div>
  <script>
    // --- ã“ã“ã‹ã‚‰JS ---
    // çµ„ç¹”ãƒ‡ãƒ¼ã‚¿ï¼ˆçœç•¥ãªã—ã€ç•¥ï¼‰
    const organizationData = {
      "è£½é€ éƒ¨": {
        "è£½é€ èª²": [
          { empno: "001", name: "å°å‚ æ•æ–‡" },
          { empno: "002", name: "ç‰‡å±± é›„å¸" },
          { empno: "003", name: "è±Šç”° å´‡è–" },
          { empno: "004", name: "å²¡ å¤§æˆ" },
          { empno: "005", name: "æ²³æœ¬ å“å“‰" },
          { empno: "006", name: "å²©ç”° ä¸€å¹³" },
          { empno: "007", name: "è—¤æ°¸ æ­¦å¿—" },
          { empno: "008", name: "é  é¾æˆ" },
          { empno: "009", name: "ç¦æµª æ™ºå¼˜" },
          { empno: "010", name: "è±Šç”° æŸ¾å¸Œ" },
          { empno: "011", name: "ãƒã‚ª" },
          { empno: "012", name: "ã‚½ãƒ³" },
          { empno: "013", name: "ãƒãƒ¥ãƒƒã‚¯" },
          { empno: "014", name: "ã‚´ã‚¢ãƒ³" },
          { empno: "015", name: "æ¸…å®¶ ç¿¼" },
          { empno: "016", name: "å°å· æ™ƒå¤§" },
          { empno: "017", name: "å‰æ°¸ è¼ä¹Ÿ" },
          { empno: "018", name: "ã‚¿ã‚¤ãƒ³" },
          { empno: "019", name: "æœ«ç•™ ç‘è¦" },
          { empno: "020", name: "ãƒ›ã‚¢ãƒ³" },
          { empno: "021", name: "ã‚¯ã‚¢ãƒ³" },
          { empno: "022", name: "ãƒ´â€•" },
          { empno: "023", name: "ãƒ†ã‚£ãƒ³" }
        ],
        "æº¶æ¥èª²": [
          { empno: "024", name: "è—¤åŸ ç§€ä¸€" },
          { empno: "025", name: "æ¨‹ä¸Š é›…å½¦" },
          { empno: "026", name: "ä½™ äºŒå¥" },
          { empno: "027", name: "é»’æœ¨ çœŸäºº" },
          { empno: "028", name: "è—¤ç”° æ™‹ä¹Ÿ" },
          { empno: "029", name: "ãƒ‡ãƒ­ã‚¹" },
          { empno: "030", name: "æ¾å· å“²ä¹Ÿ" },
          { empno: "031", name: "é«™æ©‹ æ·³" },
          { empno: "032", name: "ãƒ–ã‚ªãƒ³" }
        ],
        "æŠ€è¡“æ”¯æ´èª²": [
          { empno: "033", name: "ä¹…æ´¥é–“ å‰›" }
        ],
        "ãƒ­ãƒœãƒƒãƒˆã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³èª²": [
          { empno: "034", name: "æ¡‘ç”° å¤§è¼”" }
        ],
        "ãƒ¬ãƒ¼ã‚¶ãƒ¼ã‚·ã‚¢ãƒªãƒ³ã‚°èª²": [
          { empno: "035", name: "å¥¥æ±Ÿ äº®è¼”" },
          { empno: "036", name: "å¥¥æ±Ÿ èµ·çŸ¢" },
          { empno: "037", name: "å°æ— è¯ä»£" },
          { empno: "038", name: "æ±æ£® å¥å¤ª" },
          { empno: "039", name: "å¾Œè—¤ ä¸€ä¹Ÿ" },
          { empno: "040", name: "é–€ç”° ä¿¡å­" },
          { empno: "041", name: "å¤§å‡º ã‚ã‹ã­" }
        ],
        "ï¼¨å½¢é‹¼æ©Ÿæ¢°åŠ å·¥èª²": [
          { empno: "042", name: "è©åŸ æ­£å±•" },
          { empno: "043", name: "å°ç”° è£•æƒŸ" },
          { empno: "044", name: "ä¸‰è°· æ•å¤«" },
          { empno: "045", name: "æ— å¸" },
          { empno: "046", name: "å°ç”° æ­¦å£«" },
          { empno: "047", name: "åº§è³€ç™½ æ´‹ä¸€" },
          { empno: "048", name: "ç«¹åŸ è–ä¹Ÿ" },
          { empno: "049", name: "é«˜æœ¬ æœ‹å…¸" },
          { empno: "050", name: "é«˜æ©‹ äºœå®Ÿ" }
        ]
      },
      "å·¥å‹™éƒ¨": {
        "è¨­è¨ˆèª²": [
          { empno: "051", name: "è²æ¸… ä¿Šä¸€" },
          { empno: "052", name: "è—¤äº• æ•¦ä»" },
          { empno: "053", name: "ç•‘æœ¬ æ³°å®" },
          { empno: "054", name: "æ— çŠçŠ" },
          { empno: "055", name: "æ­¦æœ¬ ç¤¼" },
          { empno: "056", name: "ä»Šå· è–ä½³" },
          { empno: "057", name: "å‰å· å½©é¦™" },
          { empno: "058", name: "åºƒæ±Ÿ å°†å’Œ" }
        ],
        "é…é€èª²": [
          { empno: "059", name: "ä»Šæ‘ ä»" },
          { empno: "060", name: "ä¹ƒç¾ å´‡ä¸€éƒ" },
          { empno: "061", name: "å‚æœ¬ å¤§å’Œ" },
          { empno: "062", name: "å²¡åŸ ç”±æ´‹" },
          { empno: "063", name: "èŠ è³¢äºŒ" }
        ],
        "å·¥äº‹èª²": [
          { empno: "064", name: "çŸ³äº• å‹‡ä¹Ÿ" },
          { empno: "065", name: "æœªå‰ å°†å¿—" }
        ]
      },
      "ç·å‹™éƒ¨": {
        "ç·å‹™èª²": [
          { empno: "066", name: "æ²³åŸ æ˜éŸ³" },
          { empno: "067", name: "é’æœ¨ å„ªèŠ±" },
          { empno: "068", name: "æ¥¢å´ æ˜å½¦" }
        ]
      }
    };

    // æ¤œç´¢ç”¨ãƒ‡ãƒ¼ã‚¿
    let adminSearchFilters = {
      dateFrom: "",
      dateTo: "",
      sections: [],
      employees: []
    };

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let currentEmpNo = "";
    let currentEmpName = "";
    let qrReader = null;
    let qrProcessing = false;
    let punchType = "";
    let adminAllRowsCache = []; // å…¨å±¥æ­´ã‚­ãƒ£ãƒƒã‚·ãƒ¥

    // æ—¥å ±å…¥åŠ›ç”¨ä¸€æ™‚å¤‰æ•°
    let tempReportCallback = null;

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚¤ãƒ³ãƒ‰ã¨åˆæœŸåŒ–
    document.addEventListener("DOMContentLoaded", function() {
      initializeDepartments();
      setupAdminSearchUI();

      document.getElementById('department').addEventListener('change', updateSections);
      document.getElementById('section').addEventListener('change', updateEmployees);
      document.getElementById('login-btn').addEventListener('click', login);
      document.getElementById('admin-login-btn').addEventListener('click', adminLogin);
      document.getElementById('logout-btn').addEventListener('click', logout);
      document.getElementById('in-btn').addEventListener('click', () => startQrReader('å‡ºå‹¤'));
      document.getElementById('out-btn').addEventListener('click', () => startQrReader('é€€å‹¤'));
      document.getElementById('admin-logout-btn').addEventListener('click', adminLogout);
      document.getElementById('admin-clear-btn').addEventListener('click', clearAllHistories);

      document.getElementById('admin-search-btn').addEventListener('click', function() {
        updateAdminSearchFiltersFromUI();
        renderAdminHistory();
      });
      document.getElementById('admin-search-reset-btn').addEventListener('click', function() {
        resetAdminSearchFilters();
        renderAdminHistory();
      });
      document.getElementById('search-sections').addEventListener('change', updateAdminSearchEmployees);

      if (sessionStorage.getItem("admin") === "1") {
        showAdminArea();
        return;
      }
      const empno = sessionStorage.getItem("empno");
      const empname = sessionStorage.getItem("empname");
      if(empno && empname) {
        showStampArea(empno, empname);
      } else {
        showLoginArea();
      }
    });

    // ç®¡ç†è€…æ¤œç´¢UIåˆæœŸåŒ–
    function setupAdminSearchUI() {
      let sectionSelect = document.getElementById('search-sections');
      sectionSelect.innerHTML = "";
      let allSections = [];
      Object.keys(organizationData).forEach(dept => {
        Object.keys(organizationData[dept]).forEach(section => {
          allSections.push({dept, section});
        });
      });
      allSections.forEach(({dept, section}) => {
        const opt = document.createElement('option');
        opt.value = section;
        opt.textContent = `${dept} - ${section}`;
        sectionSelect.appendChild(opt);
      });
      updateAdminSearchEmployees();
    }
    function updateAdminSearchEmployees() {
      let selectedSections = Array.from(document.getElementById('search-sections').selectedOptions).map(o=>o.value);
      let employeeSelect = document.getElementById('search-employees');
      employeeSelect.innerHTML = "";
      let employees = [];
      Object.keys(organizationData).forEach(dept => {
        Object.keys(organizationData[dept]).forEach(section => {
          if (selectedSections.length === 0 || selectedSections.includes(section)) {
            organizationData[dept][section].forEach(emp => {
              employees.push({empno: emp.empno, name: emp.name, section, dept});
            });
          }
        });
      });
      employees.sort((a,b)=>a.empno.localeCompare(b.empno));
      employees.forEach(emp => {
        const opt = document.createElement('option');
        opt.value = emp.empno;
        opt.textContent = `${emp.name}ï¼ˆ${emp.dept}-${emp.section}ï¼‰`;
        employeeSelect.appendChild(opt);
      });
    }
    function updateAdminSearchFiltersFromUI() {
      adminSearchFilters.dateFrom = document.getElementById('search-date-from').value;
      adminSearchFilters.dateTo = document.getElementById('search-date-to').value;
      adminSearchFilters.sections = Array.from(document.getElementById('search-sections').selectedOptions).map(o=>o.value);
      adminSearchFilters.employees = Array.from(document.getElementById('search-employees').selectedOptions).map(o=>o.value);
    }
    function resetAdminSearchFilters() {
      document.getElementById('search-date-from').value = "";
      document.getElementById('search-date-to').value = "";
      document.getElementById('search-sections').selectedIndex = -1;
      updateAdminSearchEmployees();
      document.getElementById('search-employees').selectedIndex = -1;
      adminSearchFilters = {dateFrom:"",dateTo:"",sections:[],employees:[]};
    }

    function initializeDepartments() {
      const departmentSelect = document.getElementById('department');
      departmentSelect.innerHTML = '<option value="">-- éƒ¨ç½²ã‚’é¸æŠ --</option>';
      Object.keys(organizationData).forEach(dept => {
        const option = document.createElement('option');
        option.value = dept;
        option.textContent = dept;
        departmentSelect.appendChild(option);
      });
      document.getElementById('section').innerHTML = '<option value="">-- èª²ã‚’é¸æŠ --</option>';
      document.getElementById('section').disabled = true;
      document.getElementById('employee').innerHTML = '<option value="">-- åå‰ã‚’é¸æŠ --</option>';
      document.getElementById('employee').disabled = true;
    }

    function updateSections() {
      const department = document.getElementById('department').value;
      const sectionSelect = document.getElementById('section');
      const employeeSelect = document.getElementById('employee');
      sectionSelect.innerHTML = '<option value="">-- èª²ã‚’é¸æŠ --</option>';
      employeeSelect.innerHTML = '<option value="">-- åå‰ã‚’é¸æŠ --</option>';
      employeeSelect.disabled = true;
      if (department && organizationData[department]) {
        sectionSelect.disabled = false;
        Object.keys(organizationData[department]).forEach(section => {
          const option = document.createElement('option');
          option.value = section;
          option.textContent = section;
          sectionSelect.appendChild(option);
        });
      } else {
        sectionSelect.disabled = true;
      }
    }

    function updateEmployees() {
      const department = document.getElementById('department').value;
      const section = document.getElementById('section').value;
      const employeeSelect = document.getElementById('employee');
      employeeSelect.innerHTML = '<option value="">-- åå‰ã‚’é¸æŠ --</option>';
      if (department && section && organizationData[department] && organizationData[department][section]) {
        employeeSelect.disabled = false;
        organizationData[department][section].forEach(emp => {
          const option = document.createElement('option');
          option.value = emp.empno;
          option.textContent = emp.name;
          employeeSelect.appendChild(option);
        });
      } else {
        employeeSelect.disabled = true;
      }
    }

    function login() {
      const department = document.getElementById('department').value;
      const section = document.getElementById('section').value;
      const empno = document.getElementById('employee').value;
      const loginError = document.getElementById('login-error');
      if (!department || !section || !empno) {
        loginError.textContent = 'éƒ¨ç½²ã€èª²ã€åå‰ã‚’ã™ã¹ã¦é¸æŠã—ã¦ãã ã•ã„ã€‚';
        return;
      }
      const empObj = organizationData[department][section].find(emp => emp.empno === empno);
      if (empObj) {
        sessionStorage.setItem("empno", empObj.empno);
        sessionStorage.setItem("empname", empObj.name);
        showStampArea(empObj.empno, empObj.name);
      } else {
        loginError.textContent = 'é¸æŠå†…å®¹ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚';
      }
    }

    function logout() {
      sessionStorage.removeItem("empno");
      sessionStorage.removeItem("empname");
      showLoginArea();
    }

    function showLoginArea() {
      document.getElementById("login-area").classList.remove("hidden");
      document.getElementById("stamp-area").classList.add("hidden");
      document.getElementById("admin-area").classList.add("hidden");
      document.getElementById('empno').value = "";
      document.getElementById("login-error").innerText = "";
      document.getElementById("admin-pass").value = "";
      document.getElementById("admin-login-error").innerText = "";
      document.getElementById("modal-bg").classList.add("hidden");
      document.getElementById("report-modal-bg").classList.add("hidden");
      initializeDepartments();
    }

    function showStampArea(empno, empname) {
      currentEmpNo = empno;
      currentEmpName = empname;
      document.getElementById("current-empno").innerText = empno;
      document.getElementById("current-empname").innerText = empname;
      document.getElementById("login-area").classList.add("hidden");
      document.getElementById("stamp-area").classList.remove("hidden");
      document.getElementById("admin-area").classList.add("hidden");
      document.getElementById("result").innerHTML = "";
      document.getElementById("roulette-area").innerHTML = "";
      document.getElementById("qr-reader").classList.add("hidden");
      renderHistory();
      document.getElementById("modal-bg").classList.add("hidden");
      document.getElementById("report-modal-bg").classList.add("hidden");
    }

    // --- QRãƒªãƒ¼ãƒ€ãƒ¼ ---
    function startQrReader(type) {
      punchType = type;
      document.getElementById("result").innerHTML = "";
      document.getElementById("roulette-area").innerHTML = "";
      document.getElementById("qr-reader").classList.remove("hidden");
      if (qrReader) qrReader.clear();
      qrReader = new Html5Qrcode("qr-reader");
      qrProcessing = false;
      qrReader.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        qrCodeMessage => {
          if (qrProcessing) return;
          qrProcessing = true;

          // --- 1æ—¥1å›åˆ¶é™ãƒã‚§ãƒƒã‚¯ ---
          let key = "kaory_history_" + currentEmpNo;
          let history = JSON.parse(localStorage.getItem(key) || "[]");
          let now = new Date();
          let todayStr = now.getFullYear()+"-"+(now.getMonth()+1).toString().padStart(2,"0")+"-"+now.getDate().toString().padStart(2,"0");
          let already = history.find(h=>{
            let hDate = new Date(h.date);
            let hStr = hDate.getFullYear()+"-"+(hDate.getMonth()+1).
toString().padStart(2,"0")+"-"+hDate.getDate().toString().padStart(2,"0");
            return h.type === punchType && hStr === todayStr;
          });
          if(already){
            document.getElementById("result").innerHTML = `<span style="color:red;">æœ¬æ—¥ã¯ã™ã§ã«${punchType}æ‰“åˆ»æ¸ˆã§ã™</span>`;
            qrReader.stop();
            document.getElementById("qr-reader").classList.add("hidden");
            qrProcessing = false;
            return;
          }

          document.getElementById("result").innerHTML = `<span style="color:#0072bc;">ä½ç½®æƒ…å ±ã‚’å–å¾—ã—ã¦ã„ã¾ã™...</span>`;
          navigator.geolocation.getCurrentPosition(
            function(position) {
              if (punchType === "é€€å‹¤") {
                // é€€å‹¤æ™‚ã¯æ—¥å ±å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«
                showReportModal(function(reportText) {
                  addHistory(currentEmpNo, currentEmpName, punchType, qrCodeMessage, new Date(), position.coords, getDeviceId(), reportText);
                  document.getElementById("result").innerHTML = `<span style="color:green;">${punchType}æ‰“åˆ»ã—ã¾ã—ãŸ</span>`;
                  qrReader.stop();
                  document.getElementById("qr-reader").classList.add("hidden");
                  qrProcessing = false;
                  playStampSound();
                  setTimeout(() => showRoulette(punchType), 1000);
                });
              } else {
                addHistory(currentEmpNo, currentEmpName, punchType, qrCodeMessage, new Date(), position.coords, getDeviceId(), "");
                document.getElementById("result").innerHTML = `<span style="color:green;">${punchType}æ‰“åˆ»ã—ã¾ã—ãŸ</span>`;
                qrReader.stop();
                document.getElementById("qr-reader").classList.add("hidden");
                qrProcessing = false;
                playStampSound();
                setTimeout(() => showRoulette(punchType), 1000);
              }
            },
            function(error) {
              if (punchType === "é€€å‹¤") {
                showReportModal(function(reportText) {
                  addHistory(currentEmpNo, currentEmpName, punchType, qrCodeMessage, new Date(), null, getDeviceId(), reportText);
                  document.getElementById("result").innerHTML = `<span style="color:red;">ä½ç½®æƒ…å ±ã‚¨ãƒ©ãƒ¼ï¼ˆ${error.message}ï¼‰</span>`;
                  qrReader.stop();
                  document.getElementById("qr-reader").classList.add("hidden");
                  qrProcessing = false;
                  playStampSound();
                  setTimeout(() => showRoulette(punchType), 1000);
                });
              } else {
                addHistory(currentEmpNo, currentEmpName, punchType, qrCodeMessage, new Date(), null, getDeviceId(), "");
                document.getElementById("result").innerHTML = `<span style="color:red;">ä½ç½®æƒ…å ±ã‚¨ãƒ©ãƒ¼ï¼ˆ${error.message}ï¼‰</span>`;
                qrReader.stop();
                document.getElementById("qr-reader").classList.add("hidden");
                qrProcessing = false;
                playStampSound();
                setTimeout(() => showRoulette(punchType), 1000);
              }
            }
          );
        },
        errorMessage => {}
      );
    }

    function getDeviceId() {
      let id = localStorage.getItem("kaory_device_id");
      if (!id) {
        id = "D-" + Math.random().toString(36).substr(2, 8);
        localStorage.setItem("kaory_device_id", id);
      }
      return id;
    }

    function playStampSound() {
      try {
        const audio = document.getElementById('audio-stamp');
        audio.currentTime = 0;
        audio.play();
      } catch(e) {}
    }

    function showRoulette(type) {
      // å‡ºå‹¤ãƒ»é€€å‹¤ã©ã¡ã‚‰ã‚‚ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ
      const rouletteDiv = document.getElementById("roulette-area");
      rouletteDiv.innerHTML = '<span style="color:#0072bc;">ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆä¸­...</span>';
      setTimeout(() => {
        const isWin = Math.random() < 0.09;
        stopRouletteMedia();

        if (isWin) {
          rouletteDiv.innerHTML = `
            <div class="roulette-win">
              <video id="roulette-video-win" width="100%" style="border-radius:10px;max-width:320px;" autoplay playsinline loop muted></video>
              <br>ğŸ‰å½“ãŸã‚Šï¼ã‚¸ãƒ¥ãƒ¼ã‚¹ä¸€æœ¬ç„¡æ–™ï¼ğŸ‰<br>
              <span style="font-size:1em;">ã‚¹ã‚¯ã‚·ãƒ§ã‚’æ’®ã£ã¦ç·å‹™éƒ¨ã¸æç¤ºã—ã¦ã­ï¼</span>
            </div>
          `;
          setTimeout(() => {
            const video = document.getElementById('roulette-video-win');
            video.src = "2yBlj3kHxxedMcnHvk18R4dRRwf.mp4";
            video.load();
            video.play();
            const audio = document.getElementById('audio-win');
            audio.currentTime = 0;
            audio.play();
          }, 100);
        } else {
          rouletteDiv.innerHTML = `
            <div class="roulette-lose">
              <video id="roulette-video-lose" width="100%" style="border-radius:10px;max-width:320px;" autoplay playsinline loop muted></video>
              <br>ã¯ãšã‚Œï½ã¾ãŸæŒ‘æˆ¦ã—ã¦ã­ï¼<br>
              <span style="font-size:0.9em;">æ¬¡å›ã‚‚ãŠç–²ã‚Œæ§˜ã§ã™ï¼</span>
            </div>
          `;
          setTimeout(() => {
            const video = document.getElementById('roulette-video-lose');
            video.src = "2w2RgwYcL080demHj2RyNDjIRJU.mp4";
            video.load();
            video.play();
            const audio = document.getElementById('audio-lose');
            audio.currentTime = 0;
            audio.play();
          }, 100);
        }
      }, 900);
    }

    function stopRouletteMedia() {
      ['audio-win','audio-lose'].forEach(id=>{
        const a = document.getElementById(id);
        if(a && !a.paused) try{a.pause();a.currentTime=0;}catch(e){}
      });
      ['roulette-video-win','roulette-video-lose'].forEach(id=>{
        const v = document.getElementById(id);
        if(v && !v.paused) try{v.pause();v.currentTime=0;}catch(e){}
      });
    }

    // æ—¥å ±å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«
    function showReportModal(callback) {
      tempReportCallback = callback;
      document.getElementById("report-modal-inner").innerHTML = `
        <form id="report-form" class="change-request-form" onsubmit="submitReportModal(event)">
          <label for="report-text">æ¥­å‹™æ—¥å ±ï¼ˆå¿…é ˆï¼‰</label>
          <textarea id="report-text" rows="5" required placeholder="æœ¬æ—¥ã®æ¥­å‹™å†…å®¹ã‚„ç‰¹è¨˜äº‹é …ã‚’è¨˜å…¥ã—ã¦ãã ã•ã„"></textarea>
          <button type="submit" class="btn" style="padding:8px 22px;font-size:1em;">ç™»éŒ²</button>
        </form>
      `;
      document.getElementById("report-modal-bg").classList.remove("hidden");
      setTimeout(()=>{document.getElementById("report-text").focus();},200);
    }

    function submitReportModal(e) {
      e.preventDefault();
      const text = document.getElementById("report-text").value.trim();
      if (text === "") return;
      document.getElementById("report-modal-bg").classList.add("hidden");
      if (typeof tempReportCallback === "function") tempReportCallback(text);
      tempReportCallback = null;
    }
    function closeReportModal(e) {
      document.getElementById("report-modal-bg").classList.add("hidden");
      tempReportCallback = null;
    }

    function addHistory(empno, empname, type, qr, date, coords, device, report) {
      let key = "kaory_history_" + empno;
      let history = JSON.parse(localStorage.getItem(key) || "[]");
      const entry = {
        empno: empno,
        empname: empname,
        type,
        qr,
        date: date.toLocaleString(),
        lat: coords ? coords.latitude : null,
        lng: coords ? coords.longitude : null,
        device: device || "",
        report: report || ""
      };
      history.push(entry);
      localStorage.setItem(key, JSON.stringify(history));
      renderHistory();
    }

    // escapeHtml
    function escapeHtml(str) {
      if (typeof str !== 'string') return "";
      return str.replace(/[&<>"'`]/g, function(match) {
        return ({
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;',
          '`': '&#x60;'
        })[match];
      });
    }

    function renderHistory() {
      let key = "kaory_history_" + currentEmpNo;
      let history = JSON.parse(localStorage.getItem(key) || "[]");
      let today = new Date();
      let days = [];
      for(let i=0;i<3;i++){
        let d = new Date(today);
        d.setDate(today.getDate()-i);
        days.push(d.getFullYear()+"-"+(d.getMonth()+1).toString().padStart(2,"0")+"-"+d.getDate().toString().padStart(2,"0"));
      }
      let filtered = history.filter(h=>{
        let hDate = new Date(h.date);
        let hStr = hDate.getFullYear()+"-"+(hDate.getMonth()+1).toString().padStart(2,"0")+"-"+hDate.getDate().toString().padStart(2,"0");
        return days.includes(hStr);
      });

      let html = "<b>ç›´è¿‘3æ—¥é–“ã®æ‰“åˆ»å±¥æ­´</b><br>";
      if (filtered.length === 0) {
        html += "<span style='color:#888;'>ã¾ã å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</span>";
      } else {
        filtered.forEach((h, i) => {
          html += `<div class="history-entry">
            [${escapeHtml(h.date)}]ã€€
            ç¨®åˆ¥: <b>${escapeHtml(h.type)}</b>ã€€
            QRå†…å®¹: <b>${escapeHtml(h.qr)}</b>ã€€
            ${h.lat && h.lng ? `ä½ç½®: <a href="https://www.google.com/maps?q=${h.lat},${h.lng}" target="_blank">${h.lat.toFixed(5)},${h.lng.toFixed(5)}</a>ã€€` : "ä½ç½®: ãªã—ã€€"}
            ${
              h.type === "é€€å‹¤"
                ? `<br>æ—¥å ±: <span style="background:#ffe082;padding:2px 6px;border-radius:3px;">${escapeHtml(h.report||"")}</span>
                   <button class="change-report-btn" onclick="showChangeReportForm(${i})">æ—¥å ±ä¿®æ­£ç”³è«‹</button>`
                : ""
            }
            <button class="change-time-btn" onclick="showChangeTimeForm(${i})">æ™‚åˆ»å¤‰æ›´ç”³è«‹</button>
            <div id="change-time-form-${i}"></div>
            <div id="change-report-form-${i}"></div>
          </div>`;
        });
      }
      document.getElementById("history").innerHTML = html;
    }

    // --- æ™‚åˆ»å¤‰æ›´ç”³è«‹ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤º ---
    function showChangeTimeForm(index) {
      let formId = `change-time-form-${index}`;
      let formHtml = `
      <form class="change-request-form" onsubmit="submitChangeTime(event,${index})">
        <label>å¸Œæœ›æ™‚åˆ»</label>
        <input type="datetime-local" id="change-time-newtime-${index}" required>
        <label>ç†ç”±</label>
        <textarea id="change-time-reason-${index}" rows="2" required></textarea>
        <button type="submit" class="btn" style="padding:6px 12px;font-size:1em;">ç”³è«‹ã™ã‚‹</button>
        <button type="button" onclick="closeChangeTimeForm(${index})" class="btn" style="background:#ccc;color:#222;padding:6px 12px;font-size:1em;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </form>
      `;
      document.getElementById(formId).innerHTML = formHtml;
    }
    function closeChangeTimeForm(index) {
      document.getElementById(`change-time-form-${index}`).innerHTML = "";
    }

    // --- æ—¥å ±ä¿®æ­£ç”³è«‹ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤º ---
    function showChangeReportForm(index) {
      let formId = `change-report-form-${index}`;
      let formHtml = `
      <form class="change-report-form" onsubmit="submitChangeReport(event,${index})">
        <label>ä¿®æ­£å¾Œã®æ—¥å ±</label>
        <textarea id="change-report-newreport-${index}" rows="3" required></textarea>
        <label>ç†ç”±</label>
        <textarea id="change-report-reason-${index}" rows="2" required></textarea>
        <button type="submit" class="btn" style="padding:6px 12px;font-size:1em;">ç”³è«‹ã™ã‚‹</button>
        <button type="button" onclick="closeChangeReportForm(${index})" class="btn" style="background:#ccc;color:#222;padding:6px 12px;font-size:1em;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </form>
      `;
      document.getElementById(formId).innerHTML = formHtml;
    }
    function closeChangeReportForm(index) {
      document.getElementById(`change-report-form-${index}`).innerHTML = "";
    }

    // --- ç”³è«‹é€ä¿¡ï¼ˆæ™‚åˆ»ï¼‰ ---
    function submitChangeTime(e, index) {
      e.preventDefault();
      let key = "kaory_history_" + currentEmpNo;
      let history = JSON.parse(localStorage.getItem(key) || "[]");
      let h = history[index];
      let newTime = document.getElementById(`change-time-newtime-${index}`).value;
      let reason = document.getElementById(`change-time-reason-${index}`).value;
      if (!newTime || !reason) return;
      let requests = getRequests();
      requests.unshift({
        type: "time",
        empno: currentEmpNo,
        empname: currentEmpName,
        historyIndex: index,
        oldDate: h.date,
        punchType: h.type,
        newTime: newTime,
        reason: reason,
        requestDate: (new Date()).toLocaleString(),
        status: "pending"
      });
      setRequests(requests);
      alert("ç”³è«‹ã‚’é€ä¿¡ã—ã¾ã—ãŸ");
      closeChangeTimeForm(index);
    }

    // --- ç”³è«‹é€ä¿¡ï¼ˆæ—¥å ±ï¼‰ ---
    function submitChangeReport(e, index) {
      e.preventDefault();
      let key = "kaory_history_" + currentEmpNo;
      let history = JSON.parse(localStorage.getItem(key) || "[]");
      let h = history[index];
      let newReport = document.getElementById(`change-report-newreport-${index}`).value;
      let reason = document.getElementById(`change-report-reason-${index}`).value;
      if (!newReport || !reason) return;
      let requests = getRequests();
      requests.unshift({
        type: "report",
        empno: currentEmpNo,
        empname: currentEmpName,
        historyIndex: index,
        oldDate: h.date,
        punchType: h.type,
        newReport: newReport,
        reason: reason,
        requestDate: (new Date()).toLocaleString(),
        status: "pending"
      });
      setRequests(requests);
      alert("ç”³è«‹ã‚’é€ä¿¡ã—ã¾ã—ãŸ");
      closeChangeReportForm(index);
    }

    // --- ç”³è«‹ãƒ‡ãƒ¼ã‚¿ç®¡ç† ---
    function getRequests() {
      return JSON.parse(localStorage.getItem("kaory_requests") || "[]");
    }
    function setRequests(reqs) {
      localStorage.setItem("kaory_requests", JSON.stringify(reqs));
    }

    // --- ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³ ---
    function adminLogin() {
      const pass = document.getElementById('admin-pass').value;
      if (pass === "1") {
        sessionStorage.setItem("admin", "1");
        showAdminArea();
      } else {
        document.getElementById("admin-login-error").innerText = "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™";
      }
    }

    function showAdminArea() {
      document.getElementById("login-area").classList.add("hidden");
      document.getElementById("stamp-area").classList.add("hidden");
      document.getElementById("admin-area").classList.remove("hidden");
      renderAdminHistory();
      renderAdminRequests();
      document.getElementById("modal-bg").classList.add("hidden");
      document.getElementById("report-modal-bg").classList.add("hidden");
    }

    function adminLogout() {
      sessionStorage.removeItem("admin");
      showLoginArea();
    }

    // --- å’Œæš¦å¤‰æ› ---
    function toWareki(ymd) {
      let [y, m, d] = ymd.split("-").map(x=>parseInt(x));
      if(y >= 2019) return `ä»¤å’Œ${y-2018}å¹´${m}æœˆ${d}æ—¥`;
      if(y >= 1989) return `å¹³æˆ${y-1988}å¹´${m}æœˆ${d}æ—¥`;
      if(y >= 1926) return `æ˜­å’Œ${y-1925}å¹´${m}æœˆ${d}æ—¥`;
      return `${y}å¹´${m}æœˆ${d}æ—¥`;
    }

    // --- ç®¡ç†è€…ç”¨å±¥æ­´ä¸€è¦§ï¼ˆæ¤œç´¢ä»˜ãï¼‰ ---
    function renderAdminHistory() {
      let allKeys = Object.keys(localStorage).filter(k => k.startsWith("kaory_history_"));
      let allEntries = [];
      allKeys.forEach(key => {
        const empno = key.replace("kaory_history_", "");
        const history = JSON.parse(localStorage.getItem(key) || "[]");
        history.forEach(h => {
          let section = "", dept = "";
          Object.keys(organizationData).forEach(d => {
            Object.keys(organizationData[d]).forEach(s => {
              if (organizationData[d][s].some(e => e.empno === empno)) {
                section = s; dept = d;
              }
            });
          });
          allEntries.push({
            empno: empno,
            empname: h.empname || "",
            type: h.type,
            qr: h.qr,
            date: h.date,
            lat: h.lat,
            lng: h.lng,
            device: h.device || "",
            report: h.report || "",
            section: section,
            dept: dept
          });
        });
      });
      let grouped = {};
      allEntries.forEach(entry => {
        let dt = new Date(entry.date);
        let y = dt.getFullYear();
        let m = dt.getMonth() + 1;
        let d = dt.getDate();
        let dayKey = `${y}-${String(m).padStart(2, "0")}-${String(d).padStart(2, "0")}`;
        if (!grouped[dayKey]) grouped[dayKey] = {};
        if (!grouped[dayKey][entry.empno]) grouped[dayKey][entry.empno] = { empname: entry.empname, section: entry.section, dept: entry.dept, in: null, out: null, inObj: null, outObj: null, lat: null, lng: null, device: null, report: null };
        if (entry.type === "å‡ºå‹¤") {
          if (!grouped[dayKey][entry.empno].in || new Date(entry.date) < new Date(grouped[dayKey][entry.empno].inObj?.date)) {
            grouped[dayKey][entry.empno].in = dt;
            grouped[dayKey][entry.empno].inObj = entry;
          }
        }
        if (entry.type === "é€€å‹¤") {
          if (!grouped[dayKey][entry.empno].out || new Date(entry.date) > new Date(grouped[dayKey][entry.empno].outObj?.date)) {
            grouped[dayKey][entry.empno].out = dt;
            grouped[dayKey][entry.empno].outObj = entry;
          }
        }
      });

      let rows = [];
      Object.keys(grouped).sort().forEach(dayKey => {
        Object.keys(grouped[dayKey]).sort().forEach(empno => {
          let g = grouped[dayKey][empno];
          rows.push({
            dayKey,
            empno,
            empname: g.empname,
            section: g.section,
            dept: g.dept,
            in: g.in,
            out: g.out,
            inObj: g.inObj,
            outObj: g.outObj
          });
        });
      });

      adminAllRowsCache = rows;

      let filteredRows = rows.filter(row => {
        let ok = true;
        if (adminSearchFilters.dateFrom) {
          let fromYMD = adminSearchFilters.dateFrom;
          if (row.dayKey < fromYMD) ok = false;
        }
        if (adminSearchFilters.dateTo) {
          let toYMD = adminSearchFilters.dateTo;
          if (row.dayKey > toYMD) ok = false;
        }
        if (adminSearchFilters.sections.length > 0 && !adminSearchFilters.sections.includes(row.section)) ok = false;
        if (adminSearchFilters.employees.length > 0 && !adminSearchFilters.employees.includes(row.empno)) ok = false;
        return ok;
      });

      let html = '';
      if (filteredRows.length === 0) {
        html = "<span style='color:#888;'>è©²å½“ã™ã‚‹å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</span>";
      } else {
        html = `<table class="admin-history-table">
          <thead>
            <tr>
              <th style="width:100px;">æ—¥ä»˜</th>
              <th style="width:80px;">ç¤¾å“¡ç•ªå·</th>
              <th style="width:110px;">ç¤¾å“¡æ°å</th>
              <th style="width:90px;">èª²</th>
              <th style="width:90px;">å‡ºå‹¤æ™‚åˆ»</th>
              <th style="width:90px;">é€€å‹¤æ™‚åˆ»</th>
              <th style="width:90px;">å‹¤å‹™æ™‚é–“</th>
              <th style="width:60px;">ä½ç½®</th>
              <th style="width:60px;">ç«¯æœ«ç•ªå·</th>
              <th style="width:60px;">ä½œæ¥­æ—¥å ±</th>
            </tr>
          </thead>
          <tbody>
        `;
        filteredRows.forEach((row, idx) => {
          let wareki = toWareki(row.dayKey);
          let inTime = row.in ? `${String(row.in.getHours()).padStart(2, "0")}:${String(row.in.getMinutes()).padStart(2, "0")}` : "";
          let outTime = row.out ? `${String(row.out.getHours()).padStart(2, "0")}:${String(row.out.getMinutes()).padStart(2, "0")}` : "";

          let workTimeStr = "";
          if (row.in && row.out) {
            let diffMs = row.out - row.in - 60 * 60 * 1000;
            if (diffMs < 0) diffMs = 0;
            let hours = Math.floor(diffMs / (60 * 60 * 1000));
            let mins = Math.floor((diffMs % (60 * 60 * 1000)) / (60 * 1000));
            workTimeStr = `${hours}æ™‚é–“${mins}åˆ†`;
          } else if (row.in && !row.out) {
            workTimeStr = "è¨ˆæ¸¬ä¸­";
          } else {
            workTimeStr = "";
          }

          let lat = (row.outObj && row.outObj.lat) || (row.inObj && row.inObj.lat) || "";
          let lng = (row.outObj && row.outObj.lng) || (row.inObj && row.inObj.lng) || "";
          let device = (row.outObj && row.outObj.device) || (row.inObj && row.inObj.device) || "";
          let report = (row.outObj && row.outObj.report) || (row.inObj && row.inObj.report) || "";

          html += `<tr>
            <td>${escapeHtml(wareki)}</td>
            <td>${escapeHtml(row.empno)}</td>
            <td>${escapeHtml(row.empname)}</td>
            <td>${escapeHtml(row.section)}</td>
            <td>${inTime}</td>
            <td>${outTime}</td>
            <td>${workTimeStr}</td>
            <td><span class="location-ellipsis" onclick="showDetailModal('ä½ç½®æƒ…å ±', '${escapeHtml(lat && lng ? lat + ',' + lng : 'ãªã—')}')">@</span></td>
            <td><span class="device-ellipsis" onclick="showDetailModal('ç«¯æœ«ç•ªå·', '${escapeHtml(device || 'ãªã—')}')">@</span></td>
            <td><span class="report-ellipsis" onclick="showDetailModal('ä½œæ¥­æ—¥å ±', '${escapeHtml(report || 'ãªã—')}')">@</span></td>
          </tr>`;
        });
        html += "</tbody></table>";
      }
      document.getElementById("admin-history").innerHTML = html;
    }

    function showDetailModal(label, content) {
      let html = `<b>${label}</b><br><div style="margin-top:8px;">${content}</div>`;
      document.getElementById("modal-text").innerHTML = html;
      document.getElementById("modal-bg").classList.remove("hidden");
    }
    function closeModal(e) {
      document.getElementById("modal-bg").classList.add("hidden");
    }

    // --- ç®¡ç†è€…ï¼šæ™‚åˆ»ãƒ»æ—¥å ±å¤‰æ›´ç”³è«‹ä¸€è¦§ ---
    function renderAdminRequests() {
      let reqs = getRequests();
      if (reqs.length === 0) {
        document.getElementById("admin-requests").innerHTML = "<span style='color:#888;'>ç”³è«‹ã¯ã‚ã‚Šã¾ã›ã‚“</span>";
        return;
      }
      let html = `<table class="admin-requests-table">
        <thead>
          <tr>
            <th>ç”³è«‹æ—¥æ™‚</th>
            <th>ç¤¾å“¡ç•ªå·</th>
            <th>åå‰</th>
            <th>ç¨®åˆ¥</th>
            <th>å…ƒæ™‚åˆ»</th>
            <th>å…ƒæ—¥å ±</th>
            <th>å¸Œæœ›å†…å®¹</th>
            <th>ç†ç”±</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody>
      `;
      reqs.forEach((r, idx) => {
        let key = "kaory_history_" + r.empno;
        let history = JSON.parse(localStorage.getItem(key) || "[]");
        let h = history.find(hh=>hh.date===r.oldDate && hh.type===r.punchType);
        let oldReport = h ? h.report : "";
        html += `<tr>
          <td>${escapeHtml(r.requestDate)}</td>
          <td>${escapeHtml(r.empno)}</td>
          <td>${escapeHtml(r.empname)}</td>
          <td>${r.type==="time"?"æ™‚åˆ»":"æ—¥å ±"}</td>
          <td>${escapeHtml(r.oldDate)}</td>
          <td>${escapeHtml(oldReport)}</td>
          <td>${
            r.type==="time"
              ? escapeHtml(new Date(r.newTime).toLocaleString())
              : escapeHtml(r.newReport)
          }</td>
          <td>${escapeHtml(r.reason)}</td>
          <td>
            <button class="admin-approve-btn" onclick="approveRequest(${idx})">æ‰¿èª</button>
            <button class="admin-reject-btn" onclick="rejectRequest(${idx})">æ£„å´</button>
          </td>
        </tr>`;
      });
      html += "</tbody></table>";
      document.getElementById("admin-requests").innerHTML = html;
    }

    // --- ç”³è«‹æ‰¿èª ---
    function approveRequest(idx) {
      let reqs = getRequests();
      let r = reqs[idx];
      let key = "kaory_history_" + r.empno;
      let history = JSON.parse(localStorage.getItem(key) || "[]");
      let hIndex = history.findIndex(h => h.date === r.oldDate && h.type === r.punchType);
      if (hIndex === -1) {
        alert("è©²å½“å±¥æ­´ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
        reqs.splice(idx, 1);
        setRequests(reqs);
        renderAdminRequests();
        renderAdminHistory();
        return;
      }
      if (r.type === "time") {
        history[hIndex].date = new Date(r.newTime).toLocaleString();
      } else if (r.type === "report") {
        history[hIndex].report = r.newReport;
      }
      localStorage.setItem(key, JSON.stringify(history));
      reqs.splice(idx, 1);
      setRequests(reqs);
      alert("æ‰¿èªã—ã¾ã—ãŸã€‚å±¥æ­´ãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸã€‚");
      renderAdminRequests();
      renderAdminHistory();
    }

    // --- ç”³è«‹æ£„å´ ---
    function rejectRequest(idx) {
      let reqs = getRequests();
      reqs.splice(idx, 1);
      setRequests(reqs);
      alert("ç”³è«‹ã‚’æ£„å´ã—ã¾ã—ãŸã€‚");
      renderAdminRequests();
    }

    // --- å±¥æ­´å…¨æ¶ˆå» ---
    function clearAllHistories() {
      if (!window.confirm("æœ¬å½“ã«å…¨ã¦ã®å±¥æ­´ã‚’æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿï¼ˆå…ƒã«æˆ»ã›ã¾ã›ã‚“ï¼‰")) return;
      let allKeys = Object.keys(localStorage).filter(k => k.startsWith("kaory_history_"));
      allKeys.forEach(k => localStorage.removeItem(k));
      localStorage.removeItem("kaory_requests");
      renderAdminHistory();
      renderAdminRequests();
      alert("å…¨ã¦ã®å±¥æ­´ãƒ»ç”³è«‹ã‚’æ¶ˆå»ã—ã¾ã—ãŸã€‚");
    }
  </script>
</body>
</html>
